#pragma rtGlobals=1		// Use modern global access method.

//----------------------------------------------------------------------------------------------------------------------------------

Function/C calcul_matrix(scatangle,firstinterface,lastinterface,i,j)
	Variable scatangle,firstinterface,lastinterface,i,j
	NVAR long_onde
	Wave/D delta,betta,thickness,roughness
	Variable/C m11i,m12i,m21i,m22i,m11f,m12f,m21f,m22f,kzi,kzf,r11,r12,t11,t22
	m11i=1
	m12i=0
	m21i=0
	m22i=1
	If (firstinterface==0)
		kzi=-2*pi/long_onde*sqrt((1)^2-(cos(scatangle*pi/180))^2)
	Else
		kzi=-2*pi/long_onde*sqrt((1-delta[firstinterface-1]-sqrt(-1)*betta[firstinterface-1])^2-(cos(scatangle*pi/180))^2)
	Endif

	Variable k
	For(k=firstinterface;k<lastinterface;k+=1)
		kzf=-2*pi/long_onde*sqrt((1-delta[k]-sqrt(-1)*betta[k])^2-(cos(scatangle*pi/180))^2)
		r11=(kzi+kzf)/(2*kzi)
		r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[k]^2)
		t11=exp(sqrt(-1)*kzf*thickness[k])
		t22=exp(-sqrt(-1)*kzf*thickness[k])
		
		m11f=t11*(m11i*r11+m12i*r12)
		m12f=t22*(m11i*r12+m12i*r11)
		m21f=t11*(m21i*r11+m22i*r12)
		m22f=t22*(m21i*r12+m22i*r11)

		kzi=kzf
		m11i=m11f
		m12i=m12f
		m21i=m21f
		m22i=m22f
	Endfor

	kzf=-2*pi/long_onde*sqrt((1-delta[lastinterface]-sqrt(-1)*betta[lastinterface])^2-(cos(scatangle*pi/180))^2)
	r11=(kzi+kzf)/(2*kzi)
	r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[lastinterface]^2)

	m11f=m11i*r11+m12i*r12
	m12f=m11i*r12+m12i*r11
	m21f=m21i*r11+m22i*r12
	m22f=m21i*r12+m22i*r11
	
	Return -(i-2)*(-(j-2)*m11f+(j-1)*m12f)+(i-1)*(-(j-2)*m21f+(j-1)*m22f)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C calcul_matrix_RTRT(scatangle,firstinterface,lastinterface,i,j)
	Variable scatangle,firstinterface,lastinterface,i,j
	NVAR long_onde
	Wave/D delta,betta,thickness,roughness
	Variable/C m11i,m12i,m21i,m22i,m11f,m12f,m21f,m22f,kzi,kzf,r11,r12,t11,t22
	m11i=1
	m12i=0
	m21i=0
	m22i=1
	If (firstinterface==0)
		kzi=-2*pi/long_onde*sqrt((1)^2-(cos(scatangle*pi/180))^2)
	Else
		kzi=-2*pi/long_onde*sqrt((1-delta[firstinterface-1]-sqrt(-1)*betta[firstinterface-1])^2-(cos(scatangle*pi/180))^2)
	Endif

	Variable k
	For(k=firstinterface;k<lastinterface;k+=1)
		kzf=-2*pi/long_onde*sqrt((1-delta[k]-sqrt(-1)*betta[k])^2-(cos(scatangle*pi/180))^2)
		r11=(kzi+kzf)/(2*kzi)
		r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[k]^2)
		t11=exp(sqrt(-1)*kzf*thickness[k])
		t22=exp(-sqrt(-1)*kzf*thickness[k])
		
		m11f=t11*(m11i*r11+m12i*r12)
		m12f=t22*(m11i*r12+m12i*r11)
		m21f=t11*(m21i*r11+m22i*r12)
		m22f=t22*(m21i*r12+m22i*r11)

		kzi=kzf
		m11i=m11f
		m12i=m12f
		m21i=m21f
		m22i=m22f
	Endfor

		m11f=m11i
		m12f=m12i
		m21f=m21i
		m22f=m22i

	Return -(i-2)*(-(j-2)*m11f+(j-1)*m12f)+(i-1)*(-(j-2)*m21f+(j-1)*m22f)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C calcul_matrix_TRTR(scatangle,firstinterface,lastinterface,i,j)
	Variable scatangle,firstinterface,lastinterface,i,j
	NVAR long_onde
	Wave/D delta,betta,thickness,roughness
	Variable/C m11i,m12i,m21i,m22i,m11f,m12f,m21f,m22f,kzi,kzf,r11,r12,t11,t22
	m11i=1
	m12i=0
	m21i=0
	m22i=1
	kzi=-2*pi/long_onde*sqrt((1-delta[firstinterface]-sqrt(-1)*betta[firstinterface])^2-(cos(scatangle*pi/180))^2)

	Variable k
	For(k=firstinterface;k<lastinterface;k+=1)
		kzf=-2*pi/long_onde*sqrt((1-delta[k+1]-sqrt(-1)*betta[k+1])^2-(cos(scatangle*pi/180))^2)
		r11=(kzi+kzf)/(2*kzi)
		r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[k]^2)
		t11=exp(sqrt(-1)*kzi*thickness[k])
		t22=exp(-sqrt(-1)*kzi*thickness[k])
		
		m11f=t11*(m11i*r11+m21i*r12)
		m12f=t11*(m12i*r11+m22i*r12)
		m21f=t22*(m11i*r12+m21i*r11)
		m22f=t22*(m12i*r12+m22i*r11)

		kzi=kzf
		m11i=m11f
		m12i=m12f
		m21i=m21f
		m22i=m22f
	Endfor

		m11f=m11i
		m12f=m12i
		m21f=m21i
		m22f=m22i

	Return -(i-2)*(-(j-2)*m11f+(j-1)*m12f)+(i-1)*(-(j-2)*m21f+(j-1)*m22f)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C champincidentmoins(angl)		// U- (up)
	Variable angl
	Variable nlayer=numpnts(delta)-1
	Variable/G slayer
	
	Return calcul_matrix(angl,slayer,nlayer,2,2)/calcul_matrix(angl,0,nlayer,2,2)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C champincidentplus(angl)		//	U+ (up)
	Variable angl
	Variable nlayer=numpnts(delta)-1
	Variable/G slayer
	
	Return calcul_matrix(angl,slayer,nlayer,1,2)/calcul_matrix(angl,0,nlayer,2,2)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C champincidentmoinsdown(angl)		// V- (down)
	Variable angl
	Variable nlayer=numpnts(delta)-1
	Variable/G slayer
	
	Return calcul_matrix_TRTR(angl,slayer,nlayer,2,2)/calcul_matrix(angl,0,nlayer,2,2)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function/C champincidentplusdown(angl)		//	V+ (down)
	Variable angl
	Variable nlayer=numpnts(delta)-1
	Variable/G slayer
	
	Return calcul_matrix_TRTR(angl,slayer,nlayer,1,2)/calcul_matrix(angl,0,nlayer,2,2)
End

//----------------------------------------------------------------------------------------------------------------------------------


Function calc_efi(angl,interface)
	Variable angl,interface
	NVAR slayer
	
	slayer=interface

	Return magsqr(champincidentmoins(angl)+champincidentplus(angl))
End

//----------------------------------------------------------------------------------------------------------------------------------

Function calc_efi2z(angl,depth)
	Variable angl,depth
	NVAR slayer
	Variable s_layer=slayer
	Variable i=-1
	Variable j=0
	Wave/D delta, betta, thickness, roughness
	
	Duplicate/O/D delta deltatemp1
	Duplicate/O/D betta bettatemp1
	Duplicate/O/D thickness thicknesstemp1
	Duplicate/O/D roughness roughnesstemp1

//	depth=max(1e-15,depth)
	Do
		i+=1
		j+=thickness[i]
	While (depth>j)

	InsertPoints i,1, delta,betta,thickness,roughness
	delta[i]=delta[i+1]
	betta[i]=betta[i+1]
	thickness[i]=depth-sum(thickness,0,i-1)
	thickness[i+1]=j-depth
	roughness[i]=roughness[i+1]
	roughness[i+1]=0

	slayer=i+1

	Variable efitemp=magsqr(champincidentmoins(angl)+champincidentplus(angl))

	Duplicate/O/D deltatemp1 delta
	Duplicate/O/D bettatemp1 betta
	Duplicate/O/D thicknesstemp1 thickness
	Duplicate/O/D roughnesstemp1 roughness
	Killwaves deltatemp1,bettatemp1,thicknesstemp1,roughnesstemp1
	slayer=s_layer
	
	Return efitemp
End

//----------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function askFITparameters()
	Wave/T textWave0,textWave1
	String titletemp,setvar,cmd
	NVAR long_onde,deltaNPs,betaNPs,deltaNPc,betaNPc
	Variable i=0
	DoWindow/K Fit_parameters
	NewPanel/M/W=(16.6, 9.0, 26.3, 18.1)/N=Fit_parameters	//W=(left, top, right, bottom )
	ModifyPanel/W=Fit_parameters cbRGB=(65280,65280,48896)

	TabControl foo,pos={3,3},size={362,339},tabLabel(0)="Fitting parameters",value= 0
	TabControl foo labelBack=(65280,65280,48896)
	
	For (i=0;i<numpnts(coef);i+=2)
		titletemp=textwave0[i]
		setvar="setvar"+num2str(i)
		SetVariable $setvar title=titletemp,pos={20,30+35*i/2},size={150,20},value=coef[i],fSize=13,limits={-Inf,Inf,0},bodyWidth=60,disable=0
		If (cmpstr(textWave0[i], "None")==0)
			cmd="SetVariable "+setvar+" disable=1"
			Execute cmd
		Endif
	Endfor

	For (i=1;i<numpnts(coef);i+=2)
		titletemp=textwave0[i]
		setvar="setvar"+num2str(i)
		SetVariable $setvar title=titletemp,pos={205,30+35*(i-1)/2},size={150,20},value=coef[i],fSize=13,limits={-Inf,Inf,0},bodyWidth=60,disable=0
		If (cmpstr(textWave0[i], "None")==0)
			cmd="SetVariable "+setvar+" disable=1"
			Execute cmd
		Endif
	Endfor
	i-=1

	TabControl foo,proc=fooProc,tabLabel(1)="More parameters"

	cmd="ValDisplay valdisp0 title=\"Wavelength (nm)\",value=long_onde,size={180,17},fSize=12,pos={20,30},fstyle=1,disable=1"
	Execute cmd
	cmd="ValDisplay valdisp1 title=\"Energy (eV)\",value=1239.97/long_onde,size={135,17},fSize=12,pos={220,30},fstyle=1,disable=1"
	Execute cmd
	setvar="setvar"+num2str(i)
	SetVariable $setvar title=" Incidence angle (deg)",pos={20,65},size={190,20},value=alphai_detec,fsize=14,limits={0,90,0.005},bodyWidth=60,disable=1,frame=1,proc=SetVarProcAlphai
	setvar="setvar"+num2str(i+1)
	SetVariable $setvar title=" Azimuthal angle (deg)",pos={20,100},size={190,20},value=phi_detec,fsize=14,limits={0,360,5},bodyWidth=60,disable=1,frame=1
	setvar="setvar"+num2str(i+2)
	SetVariable $setvar title=" Tilt angle (deg)",pos={20,135},size={190,20},value=psi_detec,fsize=14,limits={-90,90,5},bodyWidth=60,disable=1,frame=1
	If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0 || cmpstr(textWave1[4], "Core-shell ripple")==0)
		setvar="setvar"+num2str(i+3)
		SetVariable $setvar title=" \\F'Symbol'd\\F'Arial' core",pos={20,170},size={190,20},value=deltaNPs,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+4)
		SetVariable $setvar title=" \\F'Symbol'b\\F'Arial' core",pos={20,205},size={190,20},value=betaNPs,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+5)
		SetVariable $setvar title=" \\F'Symbol'd\\F'Arial' shell",pos={20,240},size={190,20},value=deltaNPc,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+6)
		SetVariable $setvar title=" \\F'Symbol'b\\F'Arial' shell",pos={20,275},size={190,20},value=betaNPc,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
	Else
		setvar="setvar"+num2str(i+3)
		SetVariable $setvar title=" \\F'Symbol'd\\F'Arial' scatterers",pos={20,170},size={190,20},value=deltaNPs,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+4)
		SetVariable $setvar title=" \\F'Symbol'b\\F'Arial' scatterers",pos={20,205},size={190,20},value=betaNPs,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+5)
		SetVariable $setvar title=" \\F'Symbol'd\\F'Arial' shell",pos={20,240},size={190,20},value=deltaNPc,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
		setvar="setvar"+num2str(i+6)
		SetVariable $setvar title=" \\F'Symbol'b\\F'Arial' shell",pos={20,275},size={190,20},value=betaNPc,fsize=14,bodyWidth=70,disable=1,frame=1,limits={0,1,0}
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function fooProc(name,tab)
	String name
	Variable tab
	String titletemp,setvar,cmd
	Variable i
	Wave/T textWave0,textWave1
	
	If (tab==0)
		For (i=0;i<numpnts(coef);i+=1)
			setvar="setvar"+num2str(i)
			If (cmpstr(textWave0[i], "None")!=0)
				cmd="SetVariable "+setvar+" disable=0"
				Execute cmd
			Endif
		Endfor
		For (i=numpnts(coef);i<numpnts(coef)+7;i+=1)
			setvar="setvar"+num2str(i)
			cmd="SetVariable "+setvar+" disable=1"
			Execute cmd
		Endfor
		ValDisplay valdisp0 disable=1
		ValDisplay valdisp1 disable=1
	Else
		For (i=0;i<numpnts(coef);i+=1)
			setvar="setvar"+num2str(i)
			cmd="SetVariable/Z "+setvar+" disable=1"
			Execute cmd
		Endfor
		For (i=numpnts(coef);i<numpnts(coef)+5;i+=1)
			setvar="setvar"+num2str(i)
			cmd="SetVariable "+setvar+" disable=0"
			Execute cmd
		Endfor
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell ripple")==0)
			For (i=numpnts(coef)+5;i<numpnts(coef)+7;i+=1)
				setvar="setvar"+num2str(i)
				cmd="SetVariable "+setvar+" disable=0"
				Execute cmd
			Endfor
		Endif
		ValDisplay valdisp0 disable=0
		ValDisplay valdisp1 disable=0
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function SetVarProcAlphai(ctrlName,varNum,varStr,varName) : SetVariableControl
	String ctrlName
	Variable varNum
	String varStr
	String varName
	NVAR DirectY,alphai_detec,distance,resolutionY,long_onde
	Wave/D alphaf,alphaf_detec,wavetwothetaf,wavealphaf,wavevector_x,wavevector_y,wavevector_z
	
	DoWindow/K cut2d
	DoWindow/K Fit2d_parameters
	DoWindow/K Guinier_plot
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	
	If (stringmatch(WinList("*",";",""), "*NewGISAXS*")==1)
		alphaf_detec=atan((p-(DirectY+tan(alphai_detec*pi/180)*distance/resolutionY))*resolutionY/distance)*180/pi
		alphaf=atan((p-(DirectY+tan(alphai_detec*pi/180)*distance/resolutionY))*resolutionY/distance)*180/pi
		ControlInfo/W=NewGISAXS button8
		If (V_disable==1)
			alphaf=2*pi/long_onde*(sin(alphaf*pi/180)+sin(alphai_detec*pi/180))
		Endif
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Menu "FitGISAXS"
	Submenu "Load GISAXS..."
		"Image file", LoadNewGISAXS("imagefile")
		"Text file", LoadNewGISAXS("textfile")
		"-",
		Submenu "D2AM-ESRF"
			"D2AM-CCD", LoadNewGISAXS("d2am")
			"D2AM-XPAD", LoadNewGISAXS("d2am_xpad")
		End
		"BM32-ESRF", LoadNewGISAXS("bm32")
		"BM20-ESRF", LoadNewGISAXS("bm20")
		"ID01-ESRF", LoadNewGISAXS("id01")
		"ID10B-ESRF", LoadNewGISAXS("id10b")
		Submenu "SWING-SOLEIL"
			"SWING-BIN", LoadNewGISAXS("swing_bin")
			"SWING-ASCII", LoadNewGISAXS("swing_asc")
			"SWING-EDF", LoadNewGISAXS("swing_edf")
		End
		Submenu "SIXS-SOLEIL"
			"SIXS-BIN", LoadNewGISAXS("sixs_bin")
			"SIXS-ASCII", LoadNewGISAXS("sixs_asc")
			"SIXS-XPAD", LoadNewGISAXS("sixs_xpad")
		End
		"-",
		"D22-LURE", LoadNewGISAXS("d22")
		"DW31B-LURE", LoadNewGISAXS("dw31b")
		"Imaging Plate", LoadNewGISAXS("ip")
	End
	Submenu "Create GISAXS..."
		"Qy,Qz map", CreateNewGISAXS2D("QyQz_map")
		"Qy,Qx map", CreateNewGISAXS2D("QxQy_map")
		"Qy,Phi map", CreateNewGISAXS2D("QyPhi_map")
		"Qy cut", CreateNewGISAXS1D("Qy_cut")
		"Qz cut", CreateNewGISAXS1D("Qz_cut")
//		"Qx,Qz map", CreateNewGISAXS2D("QxQz_map") 
	End
	"-",
	"Layer parameters...", askLAYERparameters()
	"GISAXS parameters...", askGISAXSparameters()
	"Fit parameters...", askFITparameters()
	"-",
	"Plot form factor...", pfactor()
	"Plot structure factor...", sfactor()
	MAstring+"Plot size distribution...", dsize()
	MAstring+"Plot shape distribution...", dshape()
	"-",
	"Plot reflection...", Reflection_coef()
	"Plot transmission...", Transmission_coef()
	"Plot penetration depth...", Penetration_depth()
	Submenu "Plot EFI..."
		"EFI 1D vs depth", Map1d2z_efi()
		"EFI 1D vs angle", Map1d2a_efi()
		"-",
		"EFI 2D", Map2d_efi()
		"-",
		"U-", Calcul_champincidentmoins()
		"U+", Calcul_champincidentplus()
		"V-", Calcul_champincidentmoinsdown()
		"V+", Calcul_champincidentplusdown()
	End
	"-",
	Submenu "X-ray database..."
		"CXRO home page...",	BrowseURL/Z  "http://henke.lbl.gov/optical_constants/"
		"SCM-AXS database...",BrowseURL/Z  "http://res.tagen.tohoku.ac.jp/~waseda/scm/AXS/index.html"
		"Cromer-Lieberman code...",BrowseURL/Z  "http://usaxs.xor.aps.anl.gov/staff/ilavsky/AtomicFormFactors.html"
		"WebElements...",BrowseURL/Z  "http://www.webelements.com/"
	End
End

//----------------------------------------------------------------------------------------------------------------------------------

Function DSize()
	Wave/D coef
	NVAR Dmin,Dmax
	DoWindow/K Size_distribution

	Make/O/N=1001/D height0,frequencyD,temp
	SetScale/I x Dmin,Dmax,"", height0,frequencyD,temp
	Duplicate/O temp temp3,temp4
	frequencyD=Size_dist(coef,x)
	temp=frequencyD*x
	temp3=frequencyD*x^3
	temp4=frequencyD*x^4
	Display frequencyD
	DoWindow/C Size_distribution
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14
	Label left "Frequency"
	Label bottom "Size (nm)"
	ShowInfo
	Print "D distribution: Area =",area(frequencyD,0,Dmax),", Mean =",sum(temp)/sum(frequencyD),", Weighted =",sum(temp4)/sum(temp3)
	height0=Shape_dist(coef,x)*x
	Wavestats/Q height0
	Duplicate/O/D frequencyD,frequencyH
	frequencyH=frequencyD*area(frequencyD,0,Dmax)/areaXY(height0,frequencyD,0,V_max)
	AppendToGraph frequencyH vs height0
	ModifyGraph rgb(frequencyH)=(0,0,0),lstyle(frequencyH)=2
	Legend/C/N=text0/J/F=0/M/A=RB "\\s(frequencyD) D\r\\s(frequencyH) H"
	temp=frequencyH*height0
	temp3=frequencyH*height0^3
	temp4=frequencyH*height0^4
	Print "H distribution: Area =",areaXY(height0,frequencyH,0,V_max),", Mean =",sum(temp)/sum(frequencyH),", Weighted =",sum(temp4)/sum(temp3)
	Killwaves temp,temp3,temp4
End

//----------------------------------------------------------------------------------------------------------------------------------

Function DShape()
	Wave/D coef
	NVAR Dmin,Dmax
	Make/O/N=1001/D aspectratio1,height1
	SetScale/I x Dmin,Dmax,"", aspectratio1,height1
	
	DoWindow/K Shape_distribution
	aspectratio1=Shape_dist(coef,x)
	height1=aspectratio1*x
	Display height1
	AppendToGraph/R aspectratio1
	DoWindow/C Shape_distribution
	ModifyGraph btLen=5, lsize(height1)=2, fSize=14, mirror(bottom)=2, rgb(aspectratio1)=(0,0,0)
	Legend/C/N=text0/J/F=0/M/A=RB "\\s(height1) H\r\\s(aspectratio1) H/D"
	SetAxis/A/E=1 left
	SetAxis/A/E=1 right
	Label right "H/D"
	Label left "H (nm)"
	Label bottom "D (nm)"
	ShowInfo
End

//----------------------------------------------------------------------------------------------------------------------------------

Function pfactor()
	Wave/D coef
	Variable qymin=NumVarOrDefault("qy_min",-2.5)
	Variable qymax=NumVarOrDefault("qy_max",2.5)
	Variable qzmin=NumVarOrDefault("qz_min",0)
	Variable qzmax=NumVarOrDefault("qz_max",2.5)

	Prompt qymin,"qy min. (1/nm):"
	Prompt qymax,"qy max. (1/nm):"
	Prompt qzmin,"qz min. (1/nm):"
	Prompt qzmax,"qz max. (1/nm):"
	DoPrompt "Enter parameters", qymin,qymax,qzmin,qzmax

	Variable/G qy_min=qymin
	Variable/G qy_max=qymax
	Variable/G qz_min=qzmin
	Variable/G qz_max=qzmax

	DoWindow/K Formfactor
	Make/N=1001/O/D formfactorqy,formfactorqz
	SetScale/I x qy_min,qy_max,"", formfactorqy
	SetScale/I x qz_min,qz_max,"", formfactorqz
	formfactorqy=magsqr(Form_factor(1e-3,x,1e-3,coef[2],coef[2]*Shape_dist(coef,coef[2])))
	formfactorqz=magsqr(Form_factor(1e-3,1e-3,x,coef[2],coef[2]*Shape_dist(coef,coef[2])))

	Display formfactorqy
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14, zero(bottom)=1
	AppendToGraph formfactorqz
	ModifyGraph rgb(formfactorqz)=(0,0,0),lstyle(formfactorqz)=2
	Legend/C/N=text0/J/F=0/M/A=RT "\\s(formfactorqy) P(q\\By\\M)\r\\s(formfactorqz) P(q\\Bz\\M)"	
	DoWindow/C Formfactor
	Label left "P(q)"
	Label bottom "q (nm\\S-1\\M)"
	ShowInfo
End

//----------------------------------------------------------------------------------------------------------------------------------

Function sfactor()
	Wave/D coef
	Variable qymin=NumVarOrDefault("qy_min",-2.5)
	Variable qymax=NumVarOrDefault("qy_max",2.5)
	Variable qzmin=NumVarOrDefault("qz_min",0)
	Variable qzmax=NumVarOrDefault("qz_max",2.5)

	Prompt qymin,"qy min. (1/nm):"
	Prompt qymax,"qy max. (1/nm):"
	Prompt qzmin,"qz min. (1/nm):"
	Prompt qzmax,"qz max. (1/nm):"
	DoPrompt "Enter parameters", qymin,qymax,qzmin,qzmax

	Variable/G qy_min=qymin
	Variable/G qy_max=qymax
	Variable/G qz_min=qzmin
	Variable/G qz_max=qzmax

	DoWindow/K Structurefactor
	Make/N=1001/O/D structurefactorqy,structurefactorqz
	SetScale/I x qy_min,qy_max,"", structurefactorqy
	SetScale/I x qz_min,qz_max,"", structurefactorqz
	structurefactorqy=Structure_Factor(1e-3,x,1e-3,coef[2]*coef[4],coef[2]*Shape_dist(coef,coef[2])*coef[4],coef[5])
	structurefactorqz=Structure_Factor(1e-3,1e-3,x,coef[2]*coef[4],coef[2]*Shape_dist(coef,coef[2])*coef[4],coef[5])

	Display structurefactorqy
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14, zero(bottom)=1
	AppendToGraph structurefactorqz
	ModifyGraph rgb(structurefactorqz)=(0,0,0),lstyle(structurefactorqz)=2
	Legend/C/N=text0/J/F=0/M/A=RB "\\s(structurefactorqy) S(q\\By\\M)\r\\s(structurefactorqz) S(q\\Bz\\M)"	
	DoWindow/C Structurefactor
	Label left "S(q)"
	Label bottom "q (nm\\S-1\\M)"
	ShowInfo

	Button intens1 title="Peak position", proc=ButtonProc_peakposition1, pos={80,195}, size={75,20}, fSize=11
End

//		-----------------			-----------------			-----------------			-----------------

Function ButtonProc_peakposition1(ctrlName) : ButtonControl
	String ctrlName
	Wave/D structurefactorqy,structurefactorqz,W_coef

	If (numtype(str2num(StringByKey("point", CsrInfo(A))))==2)		// si le curseur A n'existe pas sur le graph
		Abort "Cursor A is not present on the graph !"
	Endif
	If (numtype(str2num(StringByKey("point", CsrInfo(B))))==2)		// si le curseur B n'existe pas sur le graph
		Abort "Cursor B is not present on the graph !"
	Endif

	String cmd="CurveFit/Q/NTHR=1 gauss  "+StringByKey("tname", CsrInfo(A))+"[pcsr(B),pcsr(A)] /D "
	Execute cmd
	cmd="ModifyGraph rgb(fit_"+StringByKey("tname", CsrInfo(A))+")=(0,0,65280)"
	Execute cmd
	Legend/C/N=text0/J/F=0/M/A=RB "\\s(structurefactorqy) S(q\\By\\M)\r\\s(structurefactorqz) S(q\\Bz\\M)"	
	Print "	Peak position: qmax =", W_coef(2),"1/nm, Interparticle distance: L =",2*pi/abs(W_coef(2)),"nm"
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Reflection_coef()
	NVAR long_onde
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde

	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", alphamin,alphamax,nrj

	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax
	long_onde=1239.97/nrj

	DoWindow/K coef_reflection
	Make/N=1001/O/D reflected_intensity
	SetScale/I x alpha_min,alpha_max,"", reflected_intensity
	reflected_intensity=magsqr(calcul_reflecto(x))
	
	Display reflected_intensity
	ModifyGraph mirror=2, btLen=5, lsize=2, log(left)=1, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "I\\Br\\M / I\\B0\\M"
	ShowInfo
	DoWindow/C coef_reflection
End

//		-----------------			-----------------			-----------------			-----------------

Function/C calcul_reflecto(grazangle)
	Variable grazangle
	NVAR long_onde
	Wave/D delta,betta,thickness,roughness
	Variable/C m11i,m12i,m21i,m22i,m11f,m12f,m21f,m22f,kzi,kzf,r11,r12,t11,t22
	m11i=1
	m12i=0
	m21i=0
	m22i=1
	kzi=-2*pi/long_onde*sqrt((1)^2-(cos(grazangle*pi/180))^2)

	Variable k
	For(k=0;k<numpnts(delta)-1;k+=1)
		kzf=-2*pi/long_onde*sqrt((1-delta[k]-sqrt(-1)*betta[k])^2-(cos(grazangle*pi/180))^2)
		r11=(kzi+kzf)/(2*kzi)
		r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[k]^2)
		t11=exp(sqrt(-1)*kzf*thickness[k])
		t22=exp(-sqrt(-1)*kzf*thickness[k])
		
		m11f=t11*(m11i*r11+m12i*r12)
		m12f=t22*(m11i*r12+m12i*r11)
		m21f=t11*(m21i*r11+m22i*r12)
		m22f=t22*(m21i*r12+m22i*r11)
		
		kzi=kzf
		m11i=m11f
		m12i=m12f
		m21i=m21f
		m22i=m22f
	Endfor

	kzf=-2*pi/long_onde*sqrt((1-delta[numpnts(delta)-1]-sqrt(-1)*betta[numpnts(delta)-1])^2-(cos(grazangle*pi/180))^2)
	r11=(kzi+kzf)/(2*kzi)
	r12=(kzi-kzf)/(2*kzi)*exp(-2*kzi*kzf*roughness[numpnts(delta)-1]^2)
	
	m11f=m11i*r11+m12i*r12
	m12f=m11i*r12+m12i*r11
	m21f=m21i*r11+m22i*r12
	m22f=m21i*r12+m22i*r11

	Return (m12f/m22f)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Transmission_coef()
	NVAR long_onde
	Wave/D delta,betta
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde

	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", alphamin,alphamax,nrj

	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax
	long_onde=1239.97/nrj

	DoWindow/K coef_transmission
	Make/D/N=1001/O transmitted_intensity
	SetScale/I x alpha_min,alpha_max,"", transmitted_intensity
	transmitted_intensity=Calcul_transmission(x,delta[0],betta[0])

	Display transmitted_intensity
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "I\\Bt\\M / I\\B0\\M"
	ShowInfo
	DoWindow/C coef_transmission
	Print "delta =",delta[0],", beta =",betta[0]
	Print "critical angle =",sqrt(2*delta[0])*180/pi,"deg., absorption coef =",4*pi*betta[0]/(long_onde*1e-7),"cm-1"
End

//		-----------------			-----------------			-----------------			-----------------

Function Calcul_transmission(grazangle,deltavalue,betavalue)
	Variable grazangle,deltavalue,betavalue
	Variable atemp,btemp
	
	atemp=sqrt(0.5*(sqrt(((grazangle*pi/180)^2-2*deltavalue)^2+4*betavalue^2)+(grazangle*pi/180)^2-2*deltavalue))
	btemp=sqrt(0.5*(sqrt(((grazangle*pi/180)^2-2*deltavalue)^2+4*betavalue^2)-(grazangle*pi/180)^2+2*deltavalue))

	Return 4*(grazangle*pi/180)^2/((grazangle*pi/180+atemp)^2+btemp^2)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Penetration_depth()
	NVAR long_onde
	Wave/D delta,betta,thickness
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde

	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", alphamin,alphamax,nrj

	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax
	long_onde=1239.97/nrj

	DoWindow/K penetration
	Make/D/N=1001/O depth_intensity
	SetScale/I x alpha_min,alpha_max,"", depth_intensity

	depth_intensity=calcul_profpen(x,delta[0],betta[0])

	Display depth_intensity
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "Depth (nm)"
	ShowInfo
	DoWindow/C penetration
	Print "delta =",delta[0],", beta =",betta[0]
	Print "critical angle =",sqrt(2*delta[0])*180/pi,"deg., absorption coef =",4*pi*betta[0]/(long_onde*1e-7),"cm-1"
End

//		-----------------			-----------------			-----------------			-----------------

Function Calcul_profpen(grazangle,deltavalue,betavalue)
	Variable grazangle,deltavalue,betavalue
	NVAR long_onde

	Return long_onde*sqrt(2)/4/pi/sqrt(sqrt(((grazangle*pi/180)^2-2*(deltavalue))^2+4*(betavalue)^2)-(grazangle*pi/180)^2+2*(deltavalue))
End

//Function calcul_profpen(grazangle)
//	Variable grazangle
//	Wave/D delta,betta,thickness
//	NVAR long_onde

//	Variable itemp,ztemp,ttemp
//	Variable k
//	itemp=0
//	ttemp=0
//	For (k=0;k<numpnts(delta)-1;k+=1)
//		ztemp=long_onde*sqrt(2)/4/pi/sqrt(sqrt(((grazangle*pi/180)^2-2*delta[k])^2+4*betta[k]^2)-(grazangle*pi/180)^2+2*delta[k])
//		itemp+=thickness[k]/ztemp
//		If (itemp>1)
//			itemp-=thickness[k]/ztemp
//			Break
//		Endif
//		ttemp+=thickness[k]
//	Endfor
//	ztemp=long_onde*sqrt(2)/4/pi/sqrt(sqrt(((grazangle*pi/180)^2-2*delta[k])^2+4*betta[k]^2)-(grazangle*pi/180)^2+2*delta[k])
//	Return ttemp+ztemp*(1-itemp)
//End

//----------------------------------------------------------------------------------------------------------------------------------

Function Calcul_champincidentmoins()
	NVAR long_onde,slayer
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde
	Variable interface=slayer
	Variable slayertemp=slayer

	Prompt interface, "Interface # :"
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", interface,alphamin,alphamax,nrj

	If (interface > numpnts(delta)-1)
		Abort "Interface doest not exist !"
	Endif

	slayer=interface
	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax

	DoWindow/K U_moins
	Make/N=1001/O/D Umoins
	SetScale/I x alpha_min,alpha_max,"", Umoins

	Umoins=magsqr(champincidentmoins(x))
	
	Display Umoins
	ModifyGraph mirror=2, btLen=5, lsize=2, log(left)=1, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "|U\\B-\\M|\\S2"
	String cmd
	cmd="TextBox/C/N=text0/M/A=RB \"Interface #"+num2str(interface)+"\""
	Execute cmd
	ShowInfo
	DoWindow/C U_moins
	slayer=slayertemp
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Calcul_champincidentplus()
	NVAR long_onde,slayer
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde
	Variable interface=slayer
	Variable slayertemp=slayer

	Prompt interface, "Interface # :"
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", interface,alphamin,alphamax,nrj

	If (interface > numpnts(delta)-1)
		Abort "Interface doest not exist !"
	Endif

	slayer=interface
	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax

	DoWindow/K U_plus
	Make/N=1001/O/D Uplus
	SetScale/I x alpha_min,alpha_max,"", Uplus

	Uplus=magsqr(champincidentplus(x))
	
	Display Uplus
	ModifyGraph mirror=2, btLen=5, lsize=2, log(left)=1, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "|U\\B+\\M|\\S2"
	String cmd
	cmd="TextBox/C/N=text0/M \"Interface #"+num2str(interface)+"\""
	Execute cmd
	ShowInfo
	DoWindow/C U_plus
	slayer=slayertemp
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Calcul_champincidentmoinsdown()
	NVAR long_onde,slayer
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde
	Variable interface=slayer
	Variable slayertemp=slayer

	Prompt interface, "Interface # :"
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", interface,alphamin,alphamax,nrj

	If (interface > numpnts(delta)-1)
		Abort "Interface doest not exist !"
	Endif

	slayer=interface
	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax

	DoWindow/K V_moins
	Make/N=1001/O/D Vmoins
	SetScale/I x alpha_min,alpha_max,"", Vmoins

	Vmoins=magsqr(champincidentmoinsdown(x))
	
	Display Vmoins
	ModifyGraph mirror=2, btLen=5, lsize=2, log(left)=1, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "|V\\B-\\M|\\S2"
	String cmd
	cmd="TextBox/C/N=text0/M/A=RB \"Interface #"+num2str(interface)+"\""
	Execute cmd
	ShowInfo
	DoWindow/C V_moins
	slayer=slayertemp
End

//----------------------------------------------------------------------------------------------------------------------------------

Function Calcul_champincidentplusdown()
	NVAR long_onde,slayer
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	Variable nrj=1239.97/long_onde
	Variable interface=slayer
	Variable slayertemp=slayer

	Prompt interface, "Interface # :"
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters", interface,alphamin,alphamax,nrj

	If (interface > numpnts(delta)-1)
		Abort "Interface doest not exist !"
	Endif

	slayer=interface
	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax

	DoWindow/K V_plus
	Make/N=1001/O/D Vplus
	SetScale/I x alpha_min,alpha_max,"", Vplus

	Vplus=magsqr(champincidentplusdown(x))
	
	Display Vplus
	ModifyGraph mirror=2, btLen=5, lsize=2, log(left)=1, fSize=14
	Label bottom "Grazing angle (°)"
	Label left "|V\\B+\\M|\\S2"
	String cmd
	cmd="TextBox/C/N=text0/M \"Interface #"+num2str(interface)+"\""
	Execute cmd
	ShowInfo
	DoWindow/C V_plus
	slayer=slayertemp
End

//----------------------------------------------------------------------------------------------------------------------------------

Function map1d2z_efi()
	NVAR long_onde,alphai_detec
	Variable nrj=1239.97/long_onde
	Variable angl=alphai_detec
	Variable depthmin=0
	Variable depthmax=round(sum(thickness,0,numpnts(thickness)-2)*4/3)
	
	Prompt angl,"Grazing angle (°):"
	Prompt depthmin,"Depth min. (nm):"
	Prompt depthmax,"Depth max. (nm):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters" angl,depthmin,depthmax,nrj

	long_onde=1239.97/nrj
	alphai_detec=angl
	Print "E =",nrj,"eV, Grazing angle =",angl,"°"
	Print ""

	DoWindow/K EFI_1d2z
	
	Make/O/D/N=201 efi1d2z
	SetScale/I x depthmin,depthmax,"", efi1d2z
	efi1d2z=calc_efi2z(angl,x)
		
	Display efi1d2z
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14
	ModifyGraph width=226.772,height=141.732
	Label bottom "Depth (nm)"
	Label left "Normalized EFI"
	SetAxis/A/E=1 left
	ShowInfo
	DoWindow/C EFI_1d2z
End

//----------------------------------------------------------------------------------------------------------------------------------

Function map1d2a_efi()
	NVAR long_onde,alphai_detec,slayer
	Variable nrj=1239.97/long_onde
	Variable prof=sum(thickness,0,slayer-1)
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	
	Prompt prof,"Depth (nm):"
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters" prof,alphamin,alphamax,nrj

	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax
	Print "E =",nrj,"eV, Depth =",prof,"nm"
	Print " "

	DoWindow/K EFI_1d2a
	
	Make/O/D/N=201 efi1d2a
	SetScale/I x alphamin,alphamax,"", efi1d2a
	efi1d2a=calc_efi2z(x,prof)
		
	Display efi1d2a
	ModifyGraph mirror=2, btLen=5, lsize=2, fSize=14
	ModifyGraph width=226.772,height=141.732
	Label bottom "Grazing angle (°)"
	Label left "Normalized EFI"
	SetAxis/A/E=1 left
	ShowInfo
	DoWindow/C EFI_1d2a
End

//----------------------------------------------------------------------------------------------------------------------------------

Function map2d_efi()
	NVAR long_onde,alphai_detec,alpha_min,alpha_max
	Variable nrj=1239.97/long_onde
	Variable depthmin=0
	Variable depthmax=round(sum(thickness,0,numpnts(thickness)-2)*4/3)
	Variable alphamin=NumVarOrDefault("alpha_min",0)
	Variable alphamax=NumVarOrDefault("alpha_max",1)
	
	Prompt alphamin,"Grazing angle min. (°):"
	Prompt alphamax,"Grazing angle max. (°):"
	Prompt depthmin,"Depth min. (nm):"
	Prompt depthmax,"Depth max. (nm):"
	Prompt nrj,"Energy (eV):"
	DoPrompt "Enter parameters" alphamin,alphamax,depthmin,depthmax,nrj

	long_onde=1239.97/nrj
	Variable/G alpha_min=alphamin
	Variable/G alpha_max=alphamax
	Print "E =",nrj,"eV"
	Print ""

	DoWindow/K EFI_2d
		
	Make/N=(200,200)/O/D efi2d
	SetScale/I x alphamin,alphamax,"", efi2d
	SetScale/I y depthmin,depthmax,"", efi2d
	efi2d=calc_efi2z(x,y)
		
	Display;AppendImage efi2d
	ModifyGraph fSize=14,btLen=5
	ModifyGraph width=226.772,height=141.732
	Label left "Depth (nm)"
	Label bottom "Grazing angle (°)"
	SetAxis/A/R left
	ModifyImage efi2d ctab= {0,*,BlueHot,1}
	ColorScale/C/N=text0/X=0.00/Y=4.00/F=0/A=RC/E image=efi2d,heightPct=100,width=10,lblMargin=-5,tickLen=5.00,fsize=14,prescaleExp=0,"Normalized EFI"
	ShowInfo
	DoWindow/C EFI_2d
End

//----------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function askGISAXSparameters()
	Wave/T textWave1
	NVAR long_onde,Dmin,Dmax
	SVAR MAstring
	Variable mode0,mode1,mode2,mode3,mode4,mode5

	If (cmpstr(textWave1[4], "Spheroid")==0)
		mode0=1
	ElseIf (cmpstr(textWave1[4], "Random spheroid")==0)
		mode0=2
	ElseIf (cmpstr(textWave1[4], "Ellipsoid")==0)
		mode0=3
	ElseIf (cmpstr(textWave1[4], "Cylinder")==0)
		mode0=4
	ElseIf (cmpstr(textWave1[4], "Hemispheroid")==0)
		mode0=5
	ElseIf (cmpstr(textWave1[4], "Truncated sphere")==0)
		mode0=6
	ElseIf (cmpstr(textWave1[4], "Facetted sphere")==0)
		mode0=7
	ElseIf (cmpstr(textWave1[4], "Capsule")==0)
		mode0=8
	ElseIf (cmpstr(textWave1[4], "Prism")==0)
		mode0=9
	ElseIf (cmpstr(textWave1[4], "Truncated tetrahedron")==0)
		mode0=10
	ElseIf (cmpstr(textWave1[4], "Ripple1")==0)
		mode0=11
	ElseIf (cmpstr(textWave1[4], "Ripple2")==0)
		mode0=12
	ElseIf (cmpstr(textWave1[4], "Anisotropic pyramid")==0)
		mode0=13
	ElseIf (cmpstr(textWave1[4], "Core-shell spheroid")==0)
		mode0=14
	ElseIf (cmpstr(textWave1[4], "Core-shell cylinder")==0)
		mode0=15
	ElseIf (cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
		mode0=16
	ElseIf (cmpstr(textWave1[4], "Core-shell ripple")==0)
		mode0=17
	EndIf	
	
	If (cmpstr(textWave1[2], "Random organization")==0)
		mode1=1
	ElseIf (cmpstr(textWave1[2], "Percus-Yevick 3D")==0)
		mode1=2
	ElseIf (cmpstr(textWave1[2], "Percus-Yevick 2D")==0)
		mode1=3
	ElseIf (cmpstr(textWave1[2], "Paracrystal 1D")==0)
		mode1=4
	ElseIf (cmpstr(textWave1[2], "Paracrystal 2D-rec")==0)
		mode1=5
	ElseIf (cmpstr(textWave1[2], "Paracrystal 2D-hex")==0)
		mode1=6
//	ElseIf (cmpstr(textWave1[2], "Paracrystal 3D")==0)
//		mode1=7
	EndIf	

	If (cmpstr(textWave1[6], "Monodisperse approximation")==0)
		mode2=1
	ElseIf (cmpstr(textWave1[6], "Local monodisperse approximation")==0)
		mode2=2
	ElseIf (cmpstr(textWave1[6], "Decoupling approximation")==0)
		mode2=3
	EndIf	

	If (cmpstr(textWave1[5], "Gaussian")==0)
		mode3=1
	ElseIf (cmpstr(textWave1[5], "DoubleGaussian")==0)
		mode3=2
	ElseIf (cmpstr(textWave1[5], "Log-normal")==0)
		mode3=3
	ElseIf (cmpstr(textWave1[5], "DoubleLog-normal")==0)
		mode3=4
	ElseIf (cmpstr(textWave1[5], "Weibull")==0)
		mode3=5
	EndIf	

	If (cmpstr(textWave1[3], "Born approximation")==0)
		mode4=1
	ElseIf (cmpstr(textWave1[3], "Supported islands")==0)
		mode4=2
	ElseIf (cmpstr(textWave1[3], "Sandwiched islands")==0)
		mode4=3
	ElseIf (cmpstr(textWave1[3], "Sandwiched layer")==0)
		mode4=4
	ElseIf (cmpstr(textWave1[3], "Buried layer")==0)
		mode4=5
	ElseIf (cmpstr(textWave1[3], "Correlated roughness")==0)
		mode4=6
	ElseIf (cmpstr(textWave1[3], "Surface holes")==0)
		mode4=7
	EndIf	

	If (cmpstr(textWave1[7], "Constant")==0)
		mode5=1
	ElseIf (cmpstr(textWave1[7], "Polynomial")==0)
		mode5=2
//	ElseIf (cmpstr(textWave1[7], "Bell")==0)
//		mode5=3
	EndIf	
	
	DoWindow/K GISAXS_parameters
	NewPanel/M/W=(16.6, 1.6, 26.3, 8.0)/N=GISAXS_parameters	//W=(left, top, right, bottom )
	ModifyPanel/W=GISAXS_parameters cbRGB=(65280,65280,48896), frameInset= 3, frameStyle= 1
	PopupMenu popup4,pos={10,10},fsize=13,size={100,20},proc=PopMenuProc4,title="Layer geometry:",value="Born approximation;Supported islands;Sandwiched islands;Sandwiched layer;Buried layer;Correlated roughness;Surface holes",mode=mode4
	PopupMenu popup0,pos={10,50},fsize=13,size={100,20},proc=PopMenuProc0,title="Form factor:",value="Spheroid;Random spheroid;Ellipsoid;Cylinder;Hemispheroid;Truncated sphere;Facetted sphere;Capsule;Prism;Truncated tetrahedron;Ripple1;Ripple2;Anisotropic pyramid;Core-shell spheroid;Core-shell cylinder;Core-shell hemispheroid;Core-shell ripple",mode=mode0
//	PopupMenu popup1,pos={10,90},fsize=13,size={100,20},proc=PopMenuProc1,title="Structure factor:",value="Random organization;Percus-Yevick 3D;Percus-Yevick 2D;Paracrystal 1D;Paracrystal 2D-rec;Paracrystal 2D-hex;Paracrystal 3D",mode=mode1
	PopupMenu popup1,pos={10,90},fsize=13,size={100,20},proc=PopMenuProc1,title="Structure factor:",value="Random organization;Percus-Yevick 3D;Percus-Yevick 2D;Paracrystal 1D;Paracrystal 2D-rec;Paracrystal 2D-hex",mode=mode1
	PopupMenu popup2,pos={10,130},fsize=13,size={100,20},proc=PopMenuProc2,title="Size distribution model:",value="Monodisperse approximation;Local monodisperse approximation;Decoupling approximation",mode=mode2
	PopupMenu popup3,pos={10,170},fsize=13,size={100,20},proc=PopMenuProc3,title="Distribution function:",value="Gaussian;DoubleGaussian;Log-normal;DoubleLog-normal;Weibull",mode=mode3
//	PopupMenu popup5,pos={235,50},fsize=13,size={100,20},proc=PopMenuProc5,title="H/D\\By\\M:",value="Constant;Polynomial;Bell",mode=mode5
	PopupMenu popup5,pos={235,50},fsize=13,size={100,20},proc=PopMenuProc5,title="H/D:",value="Constant;Polynomial",mode=mode5
	SetVariable setvar6,pos={50,210},fsize=13,size={100,20},title="D min. (nm)",value=Dmin,limits={1e-6,Inf,1},bodyWidth=60,proc=SetVarProcDminDmax
	SetVariable setvar5,pos={200,210},fsize=13,size={100,20},title="D max. (nm)",value=Dmax,limits={1e-6,Inf,1},bodyWidth=60,proc=SetVarProcDminDmax

	If (cmpstr(textWave1[6], "Monodisperse Approximation")==0)
		PopupMenu popup3 disable=2
		PopupMenu popup5 disable=2
		SetVariable setvar5 disable=2
		SetVariable setvar6 disable=2
		MAstring="("	
	Else
		PopupMenu popup3 disable=0
		PopupMenu popup5 disable=0
		SetVariable setvar5 disable=0
		SetVariable setvar6 disable=0		
		MAstring=""	
	Endif

End

//----------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc0(ctrlName,popNum,popStr) : PopupMenuControl		// Form factor
	String ctrlName
	Variable popNum
	String popStr
	Wave/T textWave0,textWave1
	Wave/D coef
	Execute/P/Q/Z "DELETEINCLUDE  \"Form_"+textWave1[4]+"\""
	textwave1[4]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"Form_"+textWave1[4]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "
	
	If (cmpstr(textWave1[4], "Ripple1")==0)
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif
		textwave0[8]="None"
		textwave0[14]="D\\Bx\\M (nm)"
		textwave0[15]="None"
		coef[8]=-1
		coef[14]=coef[2]
		coef[15]=-1
	Elseif (cmpstr(textWave1[4], "Ripple2")==0 || cmpstr(textWave1[4], "Anisotropic pyramid")==0)
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif
		textwave0[8]="None"
		textwave0[14]="D\\Bx\\M (nm)"
		textwave0[15]="Asymmetry"
		coef[8]=-1
		coef[14]=coef[2]
		coef[15]=0
	ElseIf (cmpstr(textWave1[4], "Ellipsoid")==0)
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif
		textwave0[8]="None"
		textwave0[14]="D\\Bx\\M/D\\By\\M"
		textwave0[15]="None"
		coef[8]=-1
		coef[14]=1
		coef[15]=-1
	ElseIf (cmpstr(textWave1[4], "Truncated tetrahedron")==0)
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif
		textwave0[8]="None"
		textwave0[14]="\\F'Symbol'b\\F'Arial' (deg)"
		textwave0[15]="None"
		coef[8]=-1
		coef[14]=70
		coef[15]=-1
		coef[6]=0.79
//		coef[14]=ceil(atan(coef[6]*2*sqrt(3))*180/pi)
	Elseif (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
		textwave0[2]="D\\Bcore\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\Bcore\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H\\Bcore\\M/D\\Bcore\\M (C\\B1\\M)"
		Else
			textwave0[6]="H\\Bcore\\M/D\\Bcore\\M (C\\B1\\M)"
			textwave0[7]="H\\Bcore\\M/D\\Bcore\\M (C\\B2\\M)"
		Endif		
		textwave0[8]="t\\Bshell\\M (nm)"
		textwave0[14]="None"
		textwave0[15]="None"
		coef[8]=0
		coef[14]=-1
		coef[15]=-1
	Elseif (cmpstr(textWave1[4], "Core-shell ripple")==0)
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H\\Bcore\\M/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H\\Bcore\\M/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H\\Bcore\\M/D\\By\\M (C\\B2\\M)"
		Endif		
		textwave0[8]="t\\Bshell\\M (nm)"
		textwave0[14]="D\\Bx\\M (nm)"
		textwave0[15]="Asymmetry"
		coef[8]=0
		coef[14]=coef[2]
		coef[15]=0
	Else
		textwave0[2]="D\\By\\M (nm)"
		If (cmpstr(textWave1[2], "Random organization")==0)
			textwave0[4]="None"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		If (cmpstr(textWave1[7], "Constant")==0)
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif		
		textwave0[8]="None"
		textwave0[14]="None"
		textwave0[15]="none"
		coef[8]=-1
		coef[14]=-1
		coef[15]=-1
	Endif
		
	askGISAXSparameters()
	askFITparameters()
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc1(ctrlName,popNum,popStr) : PopupMenuControl		// Structure factor
	String ctrlName
	Variable popNum
	String popStr
	Wave/D coef
	Wave/T textWave0,textWave1
	Execute/P/Q/Z "DELETEINCLUDE  \"Structure_"+textWave1[2]+"\""
	textwave1[2]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"Structure_"+textWave1[2]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "

	If (cmpstr(textWave1[2], "Random organization")==0)
		textwave0[4]="None"
		textwave0[5]="None"
//		textwave0[13]="None"
		textwave0[16]="None"
		textwave0[17]="None"
		coef[4]=-1
		coef[5]=-1
//		coef[13]=-1
		coef[16]=-1
		coef[17]=-1
	ElseIf (cmpstr(textWave1[2], "Paracrystal 1D")==0 || cmpstr(textWave1[2], "Paracrystal 2D-hex")==0)
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\Bcore\\M (C)"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		textwave0[5]="\\F'Symbol's\\F'Arial'\\By\\M (nm)"
//		textwave0[13]="None"
		textwave0[16]="None"
		textwave0[17]="None"
		coef[4]=1.5
		coef[5]=coef[2]*coef[4]*2/5
//		coef[13]=-1
		coef[16]=-1
		coef[17]=-1
	ElseIf (cmpstr(textWave1[2], "Paracrystal 2D-rec")==0)
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\Bcore\\M (C)"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		textwave0[5]="\\F'Symbol's\\F'Arial'\\By\\M (nm)"
//		textwave0[13]="None"
		textwave0[16]="\\F'Symbol'L\\F'Arial'\\Bx\\M/\\F'Symbol'L\\B\\F'Arial'y\\M"
		textwave0[17]="\\F'Symbol's\\F'Arial'\\Bx\\M/\\F'Symbol's\\F'Arial'\\By\\M"
		coef[4]=1.5
		coef[5]=coef[2]*coef[4]*2/5
//		coef[13]=-1
		coef[16]=1
		coef[17]=1
//	ElseIf (cmpstr(textWave1[2], "Paracrystal 3D")==0)
//		textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
//		textwave0[5]="\\F'Symbol's\\F'Arial'\\By\\M (nm)"
//		textwave0[16]="None"
//		textwave0[17]="None"
//		coef[4]=1.5
//		coef[5]=coef[2]*coef[4]*2/5
//		coef[16]=-1
//		coef[17]=-1

//		textwave0[13]="\\F'Symbol's\\F'Arial'\\Bz\\M (nm)"
//		coef[13]=coef[5]
	Else
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\Bcore\\M (C)"
		Else
			textwave0[4]="\\F'Symbol'L\\F'Arial'\\By\\M/D\\By\\M (C)"
		Endif
		textwave0[5]="\\F'Symbol'h\\F'Arial'\\Bhs"
//		textwave0[13]="None"
		textwave0[16]="None"
		textwave0[17]="None"
		coef[4]=1.5
		coef[5]=0.2
//		coef[13]=-1
		coef[16]=-1
		coef[17]=-1
	EndIf	

	askGISAXSparameters()
	askLAYERparameters()
	askFITparameters()
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc2(ctrlName,popNum,popStr) : PopupMenuControl		// Size distribution model
	String ctrlName
	Variable popNum
	String popStr
	Wave/D coef
	Wave/T textWave0,textWave1
	String cmd1,cmd2
	Execute/P/Q/Z "DELETEINCLUDE  \"LMA_"+textWave1[6]+"\""
	textwave1[6]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"LMA_"+textWave1[6]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "

	If (cmpstr(textWave1[6], "Monodisperse Approximation")==0)
		textwave0[3]="None"
		textwave0[9]="None"
		textwave0[10]="None"
		textwave0[11]="None"
		coef[3]=-1
		coef[9]=-1
		coef[10]=-1
		coef[11]=-1

		Execute/P/Q/Z "DELETEINCLUDE  \"Shapedist_"+textWave1[7]+"\""
		textWave1[7]="Constant"
//		textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		textwave0[7]="None"
//		textwave0[8]="None"
		coef[7]=-1
//		coef[8]=-1
		Execute/P/Q/Z "INSERTINCLUDE  \"Shapedist_"+textWave1[7]+"\""
		Execute/P/Q/Z "COMPILEPROCEDURES "
	Else
		textwave0[3]="FWHM (nm)"
		coef[3]=coef[2]*2/5
		If (cmpstr(textWave1[5], "DoubleGaussian")==0 || cmpstr(textWave1[5], "DoubleLog-normal")==0)
			textwave0[9]="Scale factor (k\\B2\\M)"
			textwave0[10]="D\\B2\\M (D\\B2\\M)"
			textwave0[11]="FWHM\\B2\\M (w\\B2\\M)"
			coef[9]=1
			coef[10]=coef[2]/2
			coef[11]=coef[3]/2
			cmd1="Dmin:=min(max(1e-6,coef[2]-3*coef[3]),max(1e-6,coef[10]-3*coef[11]))"
			cmd2="Dmax:=max(coef[2]+3*coef[3],coef[10]+3*coef[11])"
		ElseIf (cmpstr(textWave1[5], "Gaussian")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-3*coef[3])"
			cmd2="Dmax:=coef[2]+3*coef[3]"
		ElseIf (cmpstr(textWave1[5], "Log-normal")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-2*coef[3])"
			cmd2="Dmax:=coef[2]+3*coef[3]"
		ElseIf (cmpstr(textWave1[5], "Weibull")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-3*coef[3])"
			cmd2="Dmax:=coef[2]+5*coef[3]"
		Endif

		Execute cmd1
		Execute cmd2

		If (cmpstr(textWave1[6], "Decoupling approximation")==0)
			If (cmpstr(textWave1[3], "Sandwiched layer")==0 || cmpstr(textWave1[3], "Buried layer")==0 || cmpstr(textWave1[3], "Correlated roughness")==0)
				Execute/P/Q/Z "DELETEINCLUDE  \"LMA_"+textWave1[6]+"\""
				textwave1[6]="Local monodisperse approximation"
				Execute/P/Q/Z "INSERTINCLUDE  \"LMA_"+textWave1[6]+"\""
				Execute/P/Q/Z "COMPILEPROCEDURES "
			Endif
		Endif
	EndIf
	
	askGISAXSparameters()
	askFITparameters()
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc3(ctrlName,popNum,popStr) : PopupMenuControl		// Distribution function
	String ctrlName
	Variable popNum
	String popStr
	Wave/D coef
	Wave/T textWave0,textWave1
	String cmd1,cmd2
	Execute/P/Q/Z "DELETEINCLUDE  \"Sizedist_"+textWave1[5]+"\""
	textwave1[5]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"Sizedist_"+textWave1[5]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "

	If (cmpstr(textWave1[6], "Monodisperse Approximation")!=0)
		If (cmpstr(textWave1[5], "Gaussian")==0 || cmpstr(textWave1[5], "Log-normal")==0 || cmpstr(textWave1[5], "Weibull")==0)
			textwave0[9]="None"
			textwave0[10]="None"
			textwave0[11]="None"
			coef[9]=-1
			coef[10]=-1
			coef[11]=-1
		Else
			textwave0[9]="Scale factor (k\\B2\\M)"
			textwave0[10]="D\\B2\\M (D\\B2\\M)"
			textwave0[11]="FWHM\\B2\\M (w\\B2\\M)"
			coef[9]=1
			coef[10]=coef[2]/2
			coef[11]=coef[3]/2
		Endif
	
		If (cmpstr(textWave1[5], "DoubleGaussian")==0 || cmpstr(textWave1[5], "DoubleLog-normal")==0)
			cmd1="Dmin:=min(max(1e-6,coef[2]-3*coef[3]),max(1e-6,coef[10]-3*coef[11]))"
			cmd2="Dmax:=max(coef[2]+3*coef[3],coef[10]+3*coef[11])"
		ElseIf (cmpstr(textWave1[5], "Gaussian")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-3*coef[3])"
			cmd2="Dmax:=coef[2]+3*coef[3]"
		ElseIf (cmpstr(textWave1[5], "Log-normal")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-2*coef[3])"
			cmd2="Dmax:=coef[2]+3*coef[3]"
		ElseIf (cmpstr(textWave1[5], "Weibull")==0)
			cmd1="Dmin:=max(1e-6,coef[2]-3*coef[3])"
			cmd2="Dmax:=coef[2]+5*coef[3]"
		Endif

		Execute cmd1
		Execute cmd2
	Endif
	
	askGISAXSparameters()
	askFITparameters()
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc4(ctrlName,popNum,popStr) : PopupMenuControl		// Layer geometry
	String ctrlName
	Variable popNum
	String popStr
	Wave/T textwave0,textwave1
	NVAR slayer
	Wave/D coef,nps
	Execute/P/Q/Z "DELETEINCLUDE  \"Form2_"+textWave1[3]+"\""
	textwave1[3]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"Form2_"+textWave1[3]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "

	If (cmpstr(textWave1[3],"Supported islands")==0)
		slayer=0
		nps=0
	Endif

	If (cmpstr(textWave1[3],"Correlated roughness")==0 && cmpstr(textWave1[2], "Paracrystal 3D")!=0)
		textwave0[12]="\\F'Symbol'x\\F'Arial'\\By\\M"
		textwave0[13]="\\F'Symbol'x\\F'Arial'\\Bz\\M"
		coef[12]=1
		coef[13]=1
	ElseIf(cmpstr(textWave1[2], "Paracrystal 3D")==0)
		textwave0[12]="none"
		coef[12]=-1
	Else
		textwave0[12]="none"
		textwave0[13]="none"
		coef[12]=-1
		coef[13]=-1
	Endif
	
	If (cmpstr(textWave1[6], "Decoupling approximation")==0)
		If (cmpstr(textWave1[3], "Sandwiched layer")==0 || cmpstr(textWave1[3], "Buried layer")==0 || cmpstr(textWave1[3], "Correlated roughness")==0)
			Execute/P/Q/Z "DELETEINCLUDE  \"LMA_"+textWave1[6]+"\""
			textwave1[6]="Local monodisperse approximation"
			Execute/P/Q/Z "INSERTINCLUDE  \"LMA_"+textWave1[6]+"\""
			Execute/P/Q/Z "COMPILEPROCEDURES "
		Endif
	Endif
	
	askGISAXSparameters()
	askLAYERparameters()
	askFITparameters()
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc5(ctrlName,popNum,popStr) : PopupMenuControl		// H/D model
	String ctrlName
	Variable popNum
	String popStr
	Wave/D coef
	Wave/T textwave0,textwave1
	
	Execute/P/Q/Z "DELETEINCLUDE  \"Shapedist_"+textWave1[7]+"\""
	textwave1[7]=popstr
	Execute/P/Q/Z "INSERTINCLUDE  \"Shapedist_"+textWave1[7]+"\""
	Execute/P/Q/Z "COMPILEPROCEDURES "
	
	If (cmpstr(textWave1[7], "Constant")==0)
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
			textwave0[6]="H\\Bcore\\M/D\\Bcore\\M (C\\B1\\M)"
		ElseIf (cmpstr(textWave1[4], "Core-shell ripple")==0)
			textwave0[6]="H\\Bcore\\M/D\\By\\M (C\\B1\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
		Endif
		textwave0[7]="None"
//		textwave0[8]="None"
		coef[7]=-1
//		coef[8]=-1
	ElseIf (cmpstr(textWave1[7], "Polynomial")==0)
		If (cmpstr(textWave1[4], "Core-shell cylinder")==0 || cmpstr(textWave1[4], "Core-shell spheroid")==0 || cmpstr(textWave1[4], "Core-shell hemispheroid")==0)
			textwave0[6]="H\\Bcore\\M/D\\Bcore\\M (C\\B1\\M)"
			textwave0[7]="H\\Bcore\\M/D\\Bcore\\M (C\\B2\\M)"
		ElseIf (cmpstr(textWave1[4], "Core-shell ripple")==0)
			textwave0[6]="H\\Bcore\\M/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H\\Bcore\\M/D\\By\\M (C\\B2\\M)"
		Else
			textwave0[6]="H/D\\By\\M (C\\B1\\M)"
			textwave0[7]="H/D\\By\\M (C\\B2\\M)"
		Endif
//		textwave0[8]="None"
		coef[7]=1
//		coef[8]=-1
//	ElseIf (cmpstr(textWave1[7], "Bell")==0)
//		textwave0[6]="H/D\\By\\M coef (C\\B1\\M)"
//		textwave0[7]="H/D\\By\\M coef (C\\B2\\M)"
//		textwave0[8]="H/D\\By\\M coef (C\\B3\\M)"
//		coef[6]=1
//		coef[7]=coef[2]
//		coef[8]=coef[2]*2/5
	EndIf	
	
	askFITparameters()
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function SetVarProcDminDmax(ctrlName,varNum,varStr,varName) : SetVariableControl
	String ctrlName
	Variable varNum
	String varStr
	String varName
	NVAR Dmin,Dmax
	
	String cmd=varName+"="+varName
	Execute cmd
	
	DoWindow/K Size_distribution
	DoWindow/K Shape_distribution
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------


#pragma rtGlobals=1		// Use modern global access method.

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function LoadNewGISAXS(Beamline)
	String Beamline

	Variable grazingangle=NumVarOrDefault("alphai_detec",0.3)
	Variable azimuthangle=NumVarOrDefault("phi_detec",0)
	Variable Direct_X=Round(NumVarOrDefault("DirectXdial",650))
	Variable Direct_Y=Round(NumVarOrDefault("DirectYdial",1100))
	Variable s2d_dist=NumVarOrDefault("distance",570)
	Variable nrj=1239.97/NumVarOrDefault("long_onde",0.155)

	Prompt grazingangle,"Incidence angle (?:"
	Prompt azimuthangle,"Azimuthal angle (?:"
	Prompt Direct_X,"Direct beam X pixel:"
	Prompt Direct_Y,"Direct beam Y pixel:"
	Prompt s2d_dist,"Sample-detector distance  (mm):"
	Prompt nrj, "Energy (eV):"

	DoPrompt "Enter parameters", grazingangle, azimuthangle, Direct_X, Direct_Y, s2d_dist, nrj

	DoWindow/K NewGISAXS
	DoWindow/K cut
	DoWindow/K cut2d
	DoWindow/K qyqxmap
	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	DoWindow/K Guinier_plot

	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D

	//-------------------Définition des variables-----------------------------------	
		
	Variable/G alphai_detec=grazingangle
	Variable/G phi_detec=azimuthangle
	Variable/G DirectXdial=Direct_X
	Variable/G DirectYdial=Direct_Y
	Variable/G distance=s2d_dist
	Variable/G long_onde=1239.97/nrj

	Variable/G DirectXinit=Direct_X
	Variable/G DirectYinit=Direct_Y
	Variable/G resolutionX,resolutionY

	Variable cutpos=NumVarOrDefault("cut_pos",0)
	Variable cutangle=NumVarOrDefault("cut_angle",0)
	Variable cutwidth=NumVarOrDefault("cut_width",0.1)
	Variable/G cut_pos=cutpos
	Variable/G cut_angle=cutangle
	Variable/G cut_width=cutwidth

	Variable/G VminCol,VmaxCol
	Variable/G varbinning=0
	Variable/G cursmin,cursmax

	//-------------------Chargement de l'image gisaxs2D et définition de l'espace réciproque (qy,qz)-----------------------------------	

	String cmd="Load_"+Beamline+"()"
	Execute cmd
	
	Variable/G DirectX=DirectXinit
	Variable/G DirectY=DirectYinit
	
	Redimension/D gisaxs2D	
	Duplicate/O/D gisaxs2D gisaxs2D_detec
	Make/O/N=(DimSize(gisaxs2D,0)+1)/D twothetaf
	Make/O/N=(DimSize(gisaxs2D,1)+1)/D alphaf
	twothetaf=atan((p-DirectX)*resolutionX/distance)*180/pi
//	alphaf=atan((p-DirectY)*resolutionY/distance-tan(alphai_detec*pi/180))*180/pi
	alphaf=atan((p-DirectY)*resolutionY/distance)*180/pi-alphai_detec
	
	Duplicate/O/D twothetaf twothetaf_detec
	Duplicate/O/D alphaf alphaf_detec
	
	WaveStats/Q gisaxs2D
	VminCol=0
	VmaxCol=abs(V_avg*10)
	
	Display/M/W=(0.2, 5.3, 11, 11);AppendImage gisaxs2d vs {twothetaf,alphaf} 
	DoWindow/C NewGISAXS
	ControlBar 60
	SetVariable minCol, size={85,15}, pos={5,6}, proc=SetVarProc_ApplyColors, title="Min.", limits={0,Inf,0}, value= VminCol,fsize=11,bodyWidth=50//, format="%4.4g"
	SetVariable maxCol, size={85,15}, pos={5,31},proc=SetVarProc_ApplyColors, title="Max.", limits={0,Inf,0}, value= VmaxCol,fsize=11,bodyWidth=50//, format="%4.4g"
	Slider slider0 pos={95,5},size={21,50},vert=1,side=0,proc=SliderProc,variable=VmaxCol,limits={V_max*2,0,V_max/2e16}
	Button button5, size={60,20}, pos={160,7}, proc=ButtonProc_1dcut,title="1D cut",fsize=11
	Button button5bis, size={60,20}, pos={230,7}, proc=ButtonProc_2dcut,title="2D fit",fsize=11
	Button button7, size={60,20}, pos={300,7}, proc=ButtonProc_autoscale, title="Autoscale",fsize=11
	Button button6, size={60,20}, pos={160,30}, proc=ButtonProc_logscale, title="Log. scale",fsize=11
	Button button66, size={60,20}, pos={160,30}, proc=ButtonProc_linscale, title="Lin. scale",fsize=11,disable=1
	Button button9, size={60,20}, pos={230,30}, proc=ButtonProc_symimage, title="Symmetry",fsize=11
	Button button4bis, size={60,20}, pos={300,30}, proc=ButtonProc_binning, title="Binning",fsize=11
	Button button4, size={60,40}, pos={510,7}, proc=ButtonProc_reset, title="Reset",fsize=11
	Button button8, size={60,40}, pos={440,7}, proc=ButtonProc_nmscale, title="1/nm",fsize=11
	Button button8bis, size={60,40}, pos={440,7}, proc=ButtonProc_degscale, title="deg",fsize=11,disable=1
	SetVariable setvarbin title=" ",size={20,20}, pos={365,31}, disable=2,value=varbinning, limits={-inf,inf,0}

	If (cmpstr(Beamline,"id01")==0)
		Button button5ter, size={60,20}, pos={370,7}, proc=ButtonProc_RSMid01,title="RSM",fsize=11
	Endif
	If (cmpstr(Beamline,"d2am")==0)
		Button button5ter, size={60,20}, pos={370,7}, proc=ButtonProc_RSMd2am,title="RSM",fsize=11
	Endif
	If (cmpstr(Beamline,"d2am_xpad")==0)
		Button button5ter, size={60,20}, pos={370,7}, proc=ButtonProc_RSMd2amxpad,title="RSM",fsize=11
	Endif
	If (cmpstr(Beamline,"sixs_bin")==0)
		Button button5ter, size={60,20}, pos={370,7}, proc=ButtonProc_RSMsixs,title="RSM",fsize=11
	Endif
	If (cmpstr(Beamline,"sixs_asc")==0)
		Button button5ter, size={60,20}, pos={370,7}, proc=ButtonProc_RSMsixsasc,title="RSM",fsize=11
	Endif

	ModifyImage gisaxs2D ctab= {VminCol,VmaxCol,Geo,0}
	ModifyGraph fSize=14,width=283.465,height={Plan,1,left,bottom},btLen=5,zero(bottom)=1
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	SetAxis/A bottom
	SetAxis/A/E=1 left
	ColorScale/C/N=text0/X=0.00/Y=4.00/F=0/A=RC/E image=gisaxs2D,heightPct=100,width=10,lblMargin=-5,tickLen=5.00,fsize=14,prescaleExp=0,"Intensity (arb. units)"
	ShowInfo
	
	If (cmpstr(Beamline,"id10b")==0)
		ModifyGraph height={Aspect,1}
		SetAxis/A/E=0 left
	Endif


	//-------------------Impression des infos-----------------------------------	

	Print "Image size =",DimSize(gisaxs2D,0),"x",DimSize(gisaxs2D,1),"(Resolution =",resolutionX,"x",resolutionY,"mm)",", Direct beam = (",Direct_X,",",Direct_Y,")",", Sample-to-detector distance =",Distance,"mm"
	Print "Energy =",1239.97/long_onde,"eV, Wavelength =",long_onde,"nm, Incidence angle =",alphai_detec,"deg, Azimuthal angle =",phi_detec,"deg"
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function SetVarProc_ApplyColors(ctrlName,varNum,varStr,varName) : SetVariableControl
	String ctrlName
	Variable varNum
	String varStr
	String varName
	NVAR VminCol, VmaxCol
	String imname=WaveList("*gisaxs*", ";","WIN:")
	imname=imname[0,strlen(imname)-2]
	String colorcmd=StringByKey("RECREATION",ImageInfo(WinName(0,1),imname,0))
	Variable i=7
	Do
		i+=1
	While (abs(cmpstr(colorcmd[i], "," )) > 0)
	Do
		i+=1
	While (abs(cmpstr(colorcmd[i], "," )) > 0)
	Variable j=i
	Do
		j+=1
	While (abs(cmpstr(colorcmd[j], "}" )) > 0)
	colorcmd=colorcmd[i,j]
	colorcmd="ModifyImage "+imname+"  ctab= {"+num2str(VminCol)+","+num2str(VmaxCol)+colorcmd
	Execute/Q colorcmd
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function SliderProc(ctrlName,sliderValue,event) : SliderControl
	String ctrlName
	Variable sliderValue
	Variable event	// bit field: bit 0: value set, 1: mouse down, 2: mouse up, 3: mouse moved

	if(event %& 0x1)	// bit 0, value set

	endif

	NVAR VminCol, VmaxCol
	String imname=WaveList("*gisaxs*", ";","WIN:")
	imname=imname[0,strlen(imname)-2]
	String colorcmd=StringByKey("RECREATION",ImageInfo(WinName(0,1),imname,0))
	Variable i=7
	Do
		i+=1
	While (abs(cmpstr(colorcmd[i], "," )) > 0)
	Do
		i+=1
	While (abs(cmpstr(colorcmd[i], "," )) > 0)
	Variable j=i
	Do
		j+=1
	While (abs(cmpstr(colorcmd[j], "}" )) > 0)
	colorcmd=colorcmd[i,j]
	colorcmd="ModifyImage "+imname+"  ctab= {"+num2str(VminCol)+","+num2str(VmaxCol)+colorcmd
	Execute/Q colorcmd
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_autoscale(ctrlName) : ButtonControl
	String ctrlName
	SetAxis/A/E=0
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_linscale(ctrlName) : ButtonControl
	String ctrlName
	NVAR VminCol, VmaxCol
	String imname=WaveList("*gisaxs*", ";","WIN:")
	imname=imname[0,strlen(imname)-2]
	
	// ModifyImage $imname log=0
	// ColorScale/C/N=text0 log=0
	If (cmpstr(imname,"simgisaxs2D")==0)
		Button button6 disable=0
		Button button66 disable=2
	Else
		Button button6 disable=0
		Button button66 disable=1
	EndIf
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_logscale(ctrlName) : ButtonControl
	String ctrlName
	NVAR VminCol, VmaxCol
	String imname=WaveList("*gisaxs*", ";","WIN:")
	imname=imname[0,strlen(imname)-2]
	
	Variable i=0
	Variable j=0

	If (cmpstr(imname,"simgisaxs2D")==0)
		Wavestats/Q simgisaxs2D
		Do
			i+=1
		While (StringMatch(StringByKey("RECREATION", ImageInfo("","simgisaxs2d",0))[i,i], "," )==0)
		j=i
		Do
			j+=1
		While (StringMatch(StringByKey("RECREATION", ImageInfo("","simgisaxs2d",0))[j,j], "," )==0)
		VmaxCol=str2num(StringByKey("RECREATION", ImageInfo("","simgisaxs2d",0))[i+1,j-1])
		j=0
		Do
			j+=1
		While (StringMatch(StringByKey("RECREATION", ImageInfo("","simgisaxs2d",0))[j,j], "{" )==0)
		VminCol=str2num(StringByKey("RECREATION", ImageInfo("","simgisaxs2d",0))[j+1,i-1])
	Endif
	If (Numtype(VminCol)==2)
		VminCol=V_min
	Endif
	If (Numtype(VmaxCol)==2)
		VmaxCol=V_max
	Endif
	If (VminCol==0)
		VminCol=VmaxCol/100000
	Endif

	ModifyImage $imname ctab= {VminCol,VmaxCol,Geo,0}
	// ModifyImage $imname log=1
	// ColorScale/C/N=text0 log=1

	If (cmpstr(imname,"simgisaxs2D")==0)
		Button button6 disable=2
		Button button66 disable=0
	Else
		Button button6 disable=1
		Button button66 disable=0
	EndIf
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_symimage(ctrlName) : ButtonControl
	String ctrlName
	NVAR DirectX
	Wave/D gisaxs2D

	Variable Xmin1,Xmax1,Xmin2,Xmax2
	Xmax1=DirectX-1
	Xmin2=DirectX+1
	If (Dimsize(gisaxs2D,0)<=2*DirectX)
		Xmin1=2*DirectX-Dimsize(gisaxs2D,0)+1
		Xmax2=Dimsize(gisaxs2D,0)-1
	Else
		Xmin1=0
		Xmax2=2*DirectX
	Endif

	Duplicate/R=[Xmin1,Xmax1] gisaxs2D gisaxs2Dtemp1
	Duplicate/R=[Xmin2,Xmax2] gisaxs2D gisaxs2Dtemp2
	ImageRotate/O/H gisaxs2Dtemp1
	gisaxs2Dtemp2+=gisaxs2Dtemp1
	gisaxs2Dtemp1=gisaxs2Dtemp2
	gisaxs2D[Xmin2,Xmax2][]=gisaxs2Dtemp2[p-Xmin2][q]/2
	ImageRotate/O/H gisaxs2Dtemp1
	gisaxs2D[Xmin1,Xmax1][]=gisaxs2Dtemp1[p-Xmin1][q]/2

	Killwaves gisaxs2Dtemp1,gisaxs2Dtemp2

	Button button9 disable=2
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_reset(ctrlName) : ButtonControl
	String ctrlName
	NVAR VminCol, VmaxCol,DirectXinit,DirectYinit,DirectX,DirectY,ResolutionX,ResolutionY,varbinning
	
	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	DoWindow/K Guinier_plot

	Duplicate/O/D gisaxs2D_detec gisaxs2D
	Duplicate/O/D twothetaf_detec twothetaf
	Duplicate/O/D alphaf_detec alphaf

	WaveStats/Q gisaxs2D
	VminCol=0
	VmaxCol=abs(V_avg*10)

	ModifyImage gisaxs2D ctab= {VminCol,VmaxCol,Geo,0}
	ModifyGraph fSize=14,width=300,height={Plan,1,left,bottom},btLen=5,zero(bottom)=1
	// ModifyImage gisaxs2D log=0
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	SetAxis/A bottom
	SetAxis/A/E=1 left
	ColorScale/C/N=text0/X=0.00/Y=4.00/F=0/A=RC/E image=gisaxs2D,heightPct=100,width=10,lblMargin=-5,tickLen=5.00,fsize=14,log=0,prescaleExp=0,"Intensity (arb. units)"
	ModifyGraph width=0
	ShowInfo

	DirectX=DirectXinit
	DirectY=DirectYinit
	ResolutionX=ResolutionX/2^(varbinning)
	ResolutionY=ResolutionY/2^(varbinning)
	varbinning=0

	Print "New Image size =",DimSize(gisaxs2D,0),"x",DimSize(gisaxs2D,1),"(Resolution =",resolutionX,"x",resolutionY,"mm)"

	RemoveFromGraph/Z/W=NewGISAXS yPoints1,yPoints2
	Button button5 disable=0
	Button button5bis disable=0
	Button button6 disable=0
	Button button66 disable=1
	Button button9 disable=0
	Button button4bis disable=0
	Button button8 disable=0
	Button button8bis disable=1
	
	If (resolutionX==0.05503 || resolutionX==0.1)
		Button button5ter disable=0
	Endif
	
	WaveStats/Q gisaxs2D
	Slider slider0 limits={V_max*2,0,V_max/2e16}
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_nmscale(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,alphai_detec,rsmvar
	Wave/D twothetaf,alphaf
	
	twothetaf=2*pi/long_onde*sin(twothetaf*pi/180)
	alphaf=2*pi/long_onde*(sin(alphaf*pi/180)+sin(alphai_detec*pi/180))
	Label/W=NewGISAXS/Z bottom "q\\By\\M (nm\\S-1\\M)"
	Label/W=NewGISAXS/Z left "q\\Bz\\M (nm\\S-1\\M)"

	Wave/D simtwothetaf,simalphaf
	If (stringmatch(winlist("cut2d",";",""),"cut2d*")==1 || stringmatch(winlist("Fit_gisaxs2d",";",""),"Fit_gisaxs2d*")==1 || stringmatch(winlist("Res_gisaxs2d",";",""),"Res_gisaxs2d*")==1)
		simtwothetaf=2*pi/long_onde*sin(simtwothetaf*pi/180)
		simalphaf=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	Endif
	If (stringmatch(winlist("cut2d",";",""),"cut2d*")==1)
		If (rsmvar!=1)
			Label/W=cut2d/Z bottom "q\\By\\M (nm\\S-1\\M)"
			Label/W=cut2d/Z left "q\\Bz\\M (nm\\S-1\\M)"
		Else
			Label/W=cut2d/Z bottom "q\\By\\M (nm\\S-1\\M)"
		Endif
	Endif
	If (stringmatch(winlist("Fit_gisaxs2d",";",""),"Fit_gisaxs2d*")==1)
		Label/W=Fit_gisaxs2d/Z bottom "q\\By\\M (nm\\S-1\\M)"
		Label/W=Fit_gisaxs2d/Z left "q\\Bz\\M (nm\\S-1\\M)"
	Endif
	If (stringmatch(winlist("Res_gisaxs2d",";",""),"Res_gisaxs2d*")==1)
		Label/W=Res_gisaxs2d/Z bottom "q\\By\\M (nm\\S-1\\M)"
		Label/W=Res_gisaxs2d/Z left "q\\Bz\\M (nm\\S-1\\M)"
	Endif
	
	Button button8 disable=1
	Button button8bis disable=0
	Button button5 disable=2
	Button button5bis disable=2
	Button button5ter disable=1

	DoWindow/K Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_degscale(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,alphai_detec,rsmvar,resolutionX
	Wave/D twothetaf,alphaf
	
	twothetaf=asin(long_onde*twothetaf/2/pi)*180/pi
	alphaf=asin(long_onde*alphaf/2/pi-sin(alphai_detec*pi/180))*180/pi
	Label/W=NewGISAXS/Z bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	Label/W=NewGISAXS/Z left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"

	Wave/D simtwothetaf,simalphaf
	
	If (stringmatch(winlist("cut2d",";",""),"cut2d*")==1 || stringmatch(winlist("Fit_gisaxs2d",";",""),"Fit_gisaxs2d*")==1 || stringmatch(winlist("Res_gisaxs2d",";",""),"Res_gisaxs2d*")==1)
		simtwothetaf=asin(long_onde*simtwothetaf/2/pi)*180/pi
		simalphaf=asin(long_onde*simalphaf/2/pi-sin(alphai_detec*pi/180))*180/pi
	Endif
	If (stringmatch(winlist("cut2d",";",""),"cut2d*")==1)
		If (rsmvar!=1)
			Label/W=cut2d/Z bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
			Label/W=cut2d/Z left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
		Else
			Label/W=cut2d/Z bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
		Endif	
	Endif
	If (stringmatch(winlist("Fit_gisaxs2d",";",""),"Fit_gisaxs2d*")==1)
		Label/W=Fit_gisaxs2d/Z bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
		Label/W=Fit_gisaxs2d/Z left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	Endif
	If (stringmatch(winlist("Res_gisaxs2d",";",""),"Res_gisaxs2d*")==1)
		Label/W=Res_gisaxs2d/Z bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
		Label/W=Res_gisaxs2d/Z left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	Endif
	
	Button button8 disable=0
	Button button8bis disable=1
	Button button5 disable=0
	Button button5bis disable=0
	If (resolutionX==0.05503)
		Button button5ter disable=0
	Endif
	
	DoWindow/K Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_binning(ctrlName) : ButtonControl
	String ctrlName
	NVAR DirectX,DirectY,ResolutionX,ResolutionY,varbinning
	Wave/D twothetaf,alphaf
	
	Button button5ter disable=1
	varbinning+=1
	
	Wave/D gisaxs2D

	Make/D/O/N=(dimsize(gisaxs2d,0)+2,dimsize(gisaxs2d,1)) gisaxstemp1,gisaxstemp2,gisaxstemp3,gisaxstemp4

	gisaxstemp1[2,dimsize(gisaxs2d,0)+1]=gisaxs2d[p-2][q]
	gisaxstemp2[1,dimsize(gisaxs2d,0)]=gisaxs2d[p-1][q]
	gisaxstemp3[0,dimsize(gisaxs2d,0)-1]=gisaxs2d[p][q]

	gisaxstemp4=(gisaxstemp1/2+gisaxstemp2+gisaxstemp3/2)/2

	DeletePoints 0,1, gisaxstemp4
	DeletePoints DimSize(gisaxs2d,0),1, gisaxstemp4

	gisaxstemp4[0]=gisaxstemp4[p][q]*4/3
	gisaxstemp4[DimSize(gisaxs2d,0)-1]=gisaxstemp4[p][q]*4/3

	If (DimSize(gisaxs2d,0)/2-Round(DimSize(gisaxs2d,0)/2)!=0)
		DeletePoints DimSize(gisaxs2d,0)-1,1, gisaxstemp4
		DeletePoints DimSize(gisaxs2d,0),1, twothetaf
	EndIf

	Make/D/O/N=(DimSize(gisaxs2d,0)/2,DimSize(gisaxs2d,1)) gisaxstemp5
	Make/D/O/N=(DimSize(gisaxstemp5,0)+1) twothetaftemp

	If (DirectX/2-Round(DirectX/2)!=0)
		gisaxstemp5[][]=gisaxstemp4[2*p+1][q]
		twothetaftemp=twothetaf[2*p+1]
	Else
		gisaxstemp5[][]=gisaxstemp4[2*p][q]
		twothetaftemp=twothetaf[2*p]
	EndIf

	Duplicate/O gisaxstemp5 gisaxs2d
	Duplicate/O twothetaftemp twothetaf
	KillWaves gisaxstemp1,gisaxstemp2,gisaxstemp3,gisaxstemp4,gisaxstemp5,twothetaftemp

/////////////

	Make/D/O/N=(DimSize(gisaxs2d,0),DimSize(gisaxs2d,1)+2) gisaxstemp1,gisaxstemp2,gisaxstemp3,gisaxstemp4

	gisaxstemp1[][2,DimSize(gisaxs2d,1)+1]=gisaxs2d[p][q-2]
	gisaxstemp2[][1,DimSize(gisaxs2d,1)]=gisaxs2d[p][q-1]
	gisaxstemp3[][0,DimSize(gisaxs2d,1)-1]=gisaxs2d[p][q]

	gisaxstemp4=(gisaxstemp1/2+gisaxstemp2+gisaxstemp3/2)/2

	DeletePoints/M=1 0,1, gisaxstemp4
	DeletePoints/M=1 DimSize(gisaxs2d,1),1, gisaxstemp4

	gisaxstemp4[][0]=gisaxstemp4[p][q]*4/3
	gisaxstemp4[][DimSize(gisaxs2d,1)-1]=gisaxstemp4[p][q]*4/3

	If (DimSize(gisaxs2d,1)/2-Round(DimSize(gisaxs2d,1)/2)!=0)
		DeletePoints/M=1 DimSize(gisaxs2d,1)-1,1, gisaxstemp4
		DeletePoints DimSize(gisaxs2d,1),1, alphaf
	EndIf

	Make/D/O/N=(DimSize(gisaxs2d,0),DimSize(gisaxs2d,1)/2) gisaxstemp5
	Make/D/O/N=(DimSize(gisaxstemp5,1)+1) alphaftemp

	If (DirectY/2-Round(DirectY/2)!=0)
		gisaxstemp5[][]=gisaxstemp4[p][2*q+1]
		alphaftemp=alphaf[2*p+1]
	Else
		gisaxstemp5[][]=gisaxstemp4[p][2*q]
		alphaftemp=alphaf[2*p]
	EndIf

	Duplicate/O gisaxstemp5 gisaxs2d
	Duplicate/O alphaftemp alphaf
	KillWaves gisaxstemp1,gisaxstemp2,gisaxstemp3,gisaxstemp4,gisaxstemp5,alphaftemp

	DirectX=Trunc(DirectX/2)
	DirectY=Trunc(DirectY/2)
	ResolutionX=ResolutionX*2
	ResolutionY=ResolutionY*2

	If (DimSize(gisaxs2D,0)<=5 || DimSize(gisaxs2D,1)<=5)
		Button button4bis disable=2
	EndIf
	
	Print "New Image size =",DimSize(gisaxs2D,0),"x",DimSize(gisaxs2D,1),"(Resolution =",resolutionX,"x",resolutionY,"mm)"
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_1dcut(ctrlName) : ButtonControl
	String ctrlName
	NVAR Vmincol,Vmaxcol,long_onde,resolutionX,distance,cut_pos,cut_angle,cut_width,alphai_detec,phi_detec
	Wave/D twothetaf,alphaf
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i=1

	Variable cutpos=cut_pos
	Variable cutangle=cut_angle
	Variable cutwidth=cut_width
	Prompt cutpos,"Position (deg.):"
	Prompt cutangle,"Angle (deg.):"
	Prompt cutwidth,"Width (deg.):"
	DoPrompt "Enter parameters",cutangle,cutpos,cutwidth

	cut_angle=cutangle
	cut_pos=cutpos
	cut_width=cutwidth
	
	DoWindow/K cut
	DoWindow/K Guinier_plot
	RemoveFromGraph/W=NewGISAXS/Z yPoints1,yPoints2

	If (cut_angle==0)
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
	
		WaveStats/Q alphaf
		If (cut_width>alphaf[V_npnts-2]-V_min)		// si larg > alphafmax-alphafmin, larg = alphafmax-alphafmin
			cut_width=alphaf[V_npnts-2]-V_min
		print cut_pos,cut_width
		EndIf
		If (cut_pos-cut_width/2<V_min)			// si pos - larg/2 < alphafmin, pos = alphafmin+larg/2
			cut_pos=V_min+cut_width/2
		print cut_pos,cut_width
		Endif
		If (cut_pos+cut_width/2>alphaf[V_npnts-2])	// si pos + larg/2 > alphafmax, pos = alphafmax-larg/2
			cut_pos=alphaf[V_npnts-2]-cut_width/2
		print cut_pos,cut_width
		Endif
		
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPoints1={twothetaf[pixelYdeb],twothetaf[pixelYfin]},yPoints1={alphaf[pixelZdeb],alphaf[pixelZdeb]},xPoints2={twothetaf[pixelYdeb],twothetaf[pixelYfin]},yPoints2={alphaf[pixelZfin],alphaf[pixelZfin]}
		AppendToGraph yPoints1 vs xPoints1
		AppendToGraph yPoints2 vs xPoints2
		
		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX wavetwothetaf, wavealphaf, wavevector_x, wavevector_y, wavevector_z, wavevector, wavevector_xtemp, wavevector_ytemp
		Duplicate/O/D W_ImageLineProfile scatintensity
		wavetwothetaf=twothetaf
		wavealphaf=cut_pos
		wavevector_xtemp=2*pi/long_onde*(cos(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180)-cos(alphai_detec*pi/180))
		wavevector_ytemp=2*pi/long_onde*(sin(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180))
		wavevector_x=wavevector_xtemp*cos(phi_detec*pi/180)+wavevector_ytemp*sin(phi_detec*pi/180)
		wavevector_y=-wavevector_xtemp*sin(phi_detec*pi/180)+wavevector_ytemp*cos(phi_detec*pi/180)
		wavevector_z=2*pi/long_onde*(sin(wavealphaf*pi/180)+sin(alphai_detec*pi/180))
		wavevector=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity=scatintensity+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity=scatintensity/i
		Print "Horizontal cut at alphaf =",cut_pos,"deg. averaged on",i,"pixels ( [",pixelZfin-i,"]",alphaf[pixelZfin-i],"-> [",pixelZfin-1,"]",alphaf[pixelZfin-1],")"

	ElseIf (cut_angle==90)
		pixelZdeb=0
		pixelZfin=numpnts(alphaf)-2

		WaveStats/Q twothetaf
		If (cut_width>twothetaf[V_npnts-2]-V_min)		// si larg > twothetafmax-twothetafmin, larg = twothetafmax-twothetafmin
			cut_width=twothetaf[V_npnts-2]-V_min
		EndIf
		If (cut_pos-cut_width/2<V_min)			// si pos - larg/2 < twothetafmin, pos = twothetafmin+larg/2
			cut_pos=V_min+cut_width/2
		Endif
		If (cut_pos+cut_width/2>twothetaf[V_npnts-2])	// si pos + larg/2 < twothetafmax, pos = twothetafmax-larg/2
			cut_pos=twothetaf[V_npnts-2]-cut_width/2
		Endif
		
		pixelYdeb=-1
		Do
			pixelYdeb=pixelYdeb+1
		While (twothetaf[pixelYdeb]<cut_pos-cut_width/2)
		pixelYfin=pixelYdeb
		Do
			pixelYfin=pixelYfin+1
		While (twothetaf[pixelYfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPoints1={twothetaf[pixelYdeb],twothetaf[pixelYdeb]},yPoints1={alphaf[pixelZdeb],alphaf[pixelZfin]},xPoints2={twothetaf[pixelYfin],twothetaf[pixelYfin]},yPoints2={alphaf[pixelZdeb],alphaf[pixelZfin]}
		AppendToGraph yPoints1 vs xPoints1
		AppendToGraph yPoints2 vs xPoints2

		Make/O/N=2 xPixel={pixelYdeb,pixelYdeb},yPixel={pixelZdeb,pixelZfin}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX wavetwothetaf, wavealphaf, wavevector_x, wavevector_y, wavevector_z, wavevector, wavevector_xtemp, wavevector_ytemp
		Duplicate/O/D W_ImageLineProfile scatintensity
		wavetwothetaf=cut_pos
		wavealphaf=alphaf
		wavevector_xtemp=2*pi/long_onde*(cos(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180)-cos(alphai_detec*pi/180))
		wavevector_ytemp=2*pi/long_onde*(sin(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180))
		wavevector_x=wavevector_xtemp*cos(phi_detec*pi/180)+wavevector_ytemp*sin(phi_detec*pi/180)
		wavevector_y=-wavevector_xtemp*sin(phi_detec*pi/180)+wavevector_ytemp*cos(phi_detec*pi/180)
		wavevector_z=2*pi/long_onde*(sin(wavealphaf*pi/180)+sin(alphai_detec*pi/180))
		wavevector=x

		Do
			pixelYdeb=pixelYdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYdeb},yPixel={pixelZdeb,pixelZfin}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity=scatintensity+profiletemp
			i=i+1
		While (pixelYdeb<pixelYfin-1)

		scatintensity=scatintensity/i
		Print "Vertical cut at twothetaf =",cut_pos,"deg. averaged on",i,"pixels ( [",pixelYfin-i,"]",twothetaf[pixelYfin-i],"-> [",pixelYfin-1,"]",twothetaf[pixelYfin-1],")"

	Else
		cut_pos=0
		If (cut_width>90)				// si larg > 90, larg = 90
			cut_width=90
		EndIf
		If (cut_angle-cut_width/2<0)		// si angle - larg/2 < 0, angle = larg/2
			cut_angle=cut_width/2
		Endif
		If (cut_angle+cut_width/2>90)		// si angle + larg/2 > 90, angle = 90-larg/2
			cut_angle=90-cut_width/2
		Endif

		WaveStats/Q alphaf
		Variable alphafmaximum=V_max
		WaveStats/Q twothetaf
		Variable anglemoins=abs(atan(alphafmaximum/V_min)*180/pi)
		Variable angleplus=atan(alphafmaximum/V_max)*180/pi
		Variable twothetaf1,alphaf1,twothetaf2,alphaf2
				
		If (angleplus>cut_angle-cut_width/2)
			twothetaf1=V_max
			alphaf1=V_max*tan((cut_angle-cut_width/2)*pi/180)
		Else
			twothetaf1=alphafmaximum/tan((cut_angle-cut_width/2)*pi/180)
			alphaf1=alphafmaximum
		Endif
		If (angleplus>cut_angle+cut_width/2)
			twothetaf2=V_max
			alphaf2=V_max*tan((cut_angle+cut_width/2)*pi/180)
		Else
			twothetaf2=alphafmaximum/tan((cut_angle+cut_width/2)*pi/180)
			alphaf2=alphafmaximum
		Endif

		Make/O/N=3 xPoints1={twothetaf1,0,twothetaf2},yPoints1={alphaf1,0,alphaf2}

		If (anglemoins>cut_angle-cut_width/2)
			twothetaf1=V_min
			alphaf1=abs(V_min)*tan((cut_angle-cut_width/2)*pi/180)
		Else
			twothetaf1=-alphafmaximum/tan((cut_angle-cut_width/2)*pi/180)
			alphaf1=alphafmaximum
		Endif
		If (anglemoins>cut_angle+cut_width/2)
			twothetaf2=V_min
			alphaf2=abs(V_min)*tan((cut_angle+cut_width/2)*pi/180)
		Else
			twothetaf2=-alphafmaximum/tan((cut_angle+cut_width/2)*pi/180)
			alphaf2=alphafmaximum
		Endif

		Make/O/N=3 xPoints2={twothetaf1,0,twothetaf2},yPoints2={alphaf1,0,alphaf2}

		AppendToGraph yPoints1 vs xPoints1
		AppendToGraph yPoints2 vs xPoints2

		Duplicate/O/D gisaxs2D tempx,tempy,tempimage,tempradius,tempangle,tempsector
		tempx=twothetaf[x]
		tempy=alphaf[y]
		tempradius=sign(tempx)*sqrt((tempx)^2+(tempy)^2)
		tempangle=sign(tempx)*atan(tempy/tempx)*180/pi
		tempsector=-abs(sign(tempangle-cut_angle+cut_width/2)+sign(tempangle-cut_angle-cut_width/2))/2+1
		tempimage=tempimage*tempsector
		Redimension/N=(DimSize(gisaxs2D,0)*DimSize(gisaxs2D,1)) tempimage,tempsector,tempradius

		Variable pas=(2*pi/long_onde)*sin(atan(resolutionX/distance))
		Wavestats/Q tempradius
		Make/O/N=((V_max-V_min)/pas+1)/D radial0,wavevector,scatintensity
		SetScale/P x V_min,pas," ", radial0,wavevector,scatintensity
		radial0=0
		wavevector=x
		scatintensity=0
		For(i=0;i<numpnts(tempradius);i+=1)
			scatintensity[round((tempradius[i]-V_min)/pas)]+=tempimage[i]
			radial0[round((tempradius[i]-V_min)/pas)]+=tempsector[i]
		Endfor
		scatintensity=scatintensity/radial0
		For(i=numpnts(wavevector);i>0;i-=1)
			If (radial0[i-1]==0)
				DeletePoints i-1,1, scatintensity,wavevector,radial0
			Endif
		Endfor

		Duplicate/O/D wavevector wavetwothetaf, wavealphaf, wavevector_x, wavevector_y, wavevector_z, wavevector_xtemp, wavevector_ytemp
		wavetwothetaf=wavevector*cos(cut_angle*pi/180)
		wavealphaf=wavevector*sin(cut_angle*pi/180)*sign(wavevector)
		wavevector_xtemp=2*pi/long_onde*(cos(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180)-cos(alphai_detec*pi/180))
		wavevector_ytemp=2*pi/long_onde*(sin(wavetwothetaf*pi/180)*cos(wavealphaf*pi/180))
		wavevector_x=wavevector_xtemp*cos(phi_detec*pi/180)+wavevector_ytemp*sin(phi_detec*pi/180)
		wavevector_y=-wavevector_xtemp*sin(phi_detec*pi/180)+wavevector_ytemp*cos(phi_detec*pi/180)
		wavevector_z=2*pi/long_onde*(sin(wavealphaf*pi/180)+sin(alphai_detec*pi/180))

		Wavestats/Q radial0
		Print "Sector cut averaged on",V_avg,"pixels"
	
		SetScale/P x 0,1,"", scatintensity,wavevector
		wavevector=x	
	Endif

	Display/W=(480, 10, 880, 240) scatintensity vs wavevector	// /W=(left, top, right, bottom )
	ModifyGraph mirror=2, btLen=5, fSize=14, zero(bottom)=1
	Label bottom "Pixel"
	Label left "Intensity (arb. units)"
	SetAxis left Vmincol,Vmaxcol
	ShowInfo
	ControlBar 30
	Button intens0 title="Guinier", proc=ButtonProc_guinierplot, pos={380,5}, size={60,20},fsize=11,disable=2
	Button intens1 title="Peak position", proc=ButtonProc_peakposition, pos={295,5}, size={75,20},fsize=11
	Button intens21 title="Lin. scale", proc=ButtonProc_linscale1d, pos={155,5}, size={60,20},fsize=11, disable=1
	Button intens22 title="Log. scale", proc=ButtonProc_logscale1d, pos={155,5}, size={60,20},fsize=11
	Button intens3 title="Autoscale", proc=ButtonProc_autoscale, pos={85,5}, size={60,20},fsize=11
	Button intens6 title="1D fit", proc=ButtonProc_fit1D, pos={225,5}, size={60,20},fsize=11
	Button intens5 title="Rename", proc=ButtonProc_renamewavecut, pos={450,5}, size={60,20},fsize=11

	PopupMenu popup0 proc=PopMenuProc,pos={20,5},bodyWidth=65,value="Pixel;qx;qy;qz;2thetaf;alphaf"

	DoWindow/C cut

	Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0,wavevector_xtemp,wavevector_ytemp,wavevector_ztemp
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function PopMenuProc(ctrlName,popNum,popStr) : PopupMenuControl
	String ctrlName
	Variable popNum
	String popStr
	NVAR cursmin,cursmax
	Wave/D wavevector,wavevector_x,wavevector_y,wavevector_z,wavetwothetaf,wavealphaf,fit_wavevector
	
	RemoveFromGraph/Z fit_peakposition
	DoWindow/K Fit1d_parameters
	
	If (popnum==1)
		wavevector=x	
		Label bottom "Pixel"
		Button intens0 disable=2
		Button intens6 disable=0
	ElseIf (popnum==2)
		wavevector=wavevector_x
		Label bottom "q\\Bx\\M (nm\\S-1\\M)"
		Button intens0 disable=0
		Button intens6 disable=2
	ElseIf (popnum==3)
		wavevector=wavevector_y
		Label bottom "q\\By\\M (nm\\S-1\\M)"
		Button intens0 disable=0
		Button intens6 disable=2
	ElseIf (popnum==4)
		wavevector=wavevector_z
		Label bottom "q\\Bz\\M (nm\\S-1\\M)"
		Button intens0 disable=0
		Button intens6 disable=2
	ElseIf (popnum==5)
		wavevector=wavetwothetaf
		Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
		Button intens0 disable=2
		Button intens6 disable=2
	ElseIf (popnum==6)
		wavevector=wavealphaf
		Label bottom "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"	
		Button intens0 disable=2
		Button intens6 disable=2
	Endif
	
	Duplicate/O/D/R=[cursmin,cursmax] wavevector fit_wavevector
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_2dcut(ctrlName) : ButtonControl
	String ctrlName
	NVAR Vmincol,Vmaxcol,long_onde,alphai_detec,phi_detec
	Variable/G rsmvar=0
	Wave/D twothetaf,alphaf
	Variable ymin,ymax,zmin,zmax

	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	RemoveFromGraph/W=NewGISAXS/Z yPoints1,yPoints2
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	If (numtype(str2num(StringByKey("point", CsrInfo(A))))==2)		// si le curseur A n'existe pas sur le graph
		Abort "Cursor A is not present on the graph !"
	Endif
	If (numtype(str2num(StringByKey("point", CsrInfo(B))))==2)		// si le curseur B n'existe pas sur le graph
		Abort "Cursor B is not present on the graph !"
	Endif

	ymin=str2num(StringByKey("point", CsrInfo(A)))
	zmin=str2num(StringByKey("ypoint", CsrInfo(A)))
	ymax=str2num(StringByKey("point", CsrInfo(B)))
	zmax=str2num(StringByKey("ypoint", CsrInfo(B)))

	Make/O/N=5 xPoints1={twothetaf[ymin],twothetaf[ymax],twothetaf[ymax],twothetaf[ymin],twothetaf[ymin]},yPoints1={alphaf[zmin],alphaf[zmin],alphaf[zmax],alphaf[zmax],alphaf[zmin]}
	AppendToGraph yPoints1 vs xPoints1

	Duplicate/O/D/R=[ymin,ymax+1] twothetaf simtwothetaf
	Duplicate/O/D/R=[zmin,zmax+1] alphaf simalphaf
	Duplicate/O/D/R=[ymin,ymax][zmin,zmax] gisaxs2D scatintensity2D, wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf[p]*pi/180)*cos(simalphaf[q]*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf[p]*pi/180)*cos(simalphaf[q]*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(phi_detec*pi/180)+wavevector_ytemp*sin(phi_detec*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(phi_detec*pi/180)+wavevector_ytemp*cos(phi_detec*pi/180)


	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf[q]*pi/180)+sin(alphai_detec*pi/180))

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {simtwothetaf,simalphaf}
	ModifyImage scatintensity2D ctab= {VminCol,VmaxCol,Geo,0}
	ModifyGraph width=200, height={Plan,1,left,bottom},fSize=10,btLen=3,zero(bottom)=1
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d

	Print "2D cut from {",ymin,",",zmin,"} to {",ymax,",",zmax,"}"
	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_RSMid01(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,cut_pos,cut_width,alphai_detec,phi_detec
	Variable/G rsmvar=1
	Wave/D twothetaf,alphaf,gisaxs2d
	String chemin, nombin
	String ask="no"
	Variable xdim,ydim
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i,j,firstimage,phimin,phimax
	phimin=0
	phimax=90
	
	Prompt phimin,"Azimuthal angle min. (deg.):"
	Prompt phimax,"Azimuthal angle max. (deg.):"
	Prompt ask, "Create video:", popup "yes;no;"
	DoPrompt "Enter parameters",phimin,phimax,ask
	
	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	Make/O/N=(numpnts(twothetaf)-1,phimax-phimin+1)/D scatintensity2D
	Make/O/N=(phimax-phimin+2)/D phif
	phif=x+phimin-0.5

	Duplicate/O/D scatintensity2D simtwothetaf,simalphaf,simphif,wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	simtwothetaf[][]=twothetaf[p]
	simalphaf=cut_pos
	simphif=y+phimin
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf*pi/180)*cos(simalphaf*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf*pi/180)*cos(simalphaf*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(simphif*pi/180)+wavevector_ytemp*sin(simphif*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(simphif*pi/180)+wavevector_ytemp*cos(simphif*pi/180)
	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	
	Duplicate/O/D twothetaf simtwothetaf

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	LoadWave/A=source/B="F=-2;"/J/Q
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	
	firstimage=str2num(nombin[strlen(nombin)-7,strlen(nombin)-4])

	String spectramoviename="GISAXSmovie"
	String s

	If (cmpstr(ask,"yes")==0) 
		NewMovie/F=10/L/O/P=chemin/Z as spectramoviename
	Endif

	For(j=0;j<phimax-phimin+1;j+=1)
		print "Azimuthal angle =",j+phimin,"deg.",nombin
		phi_detec=j+phimin

		//----------------------load------------------------------------------------------------------------------------------------------------------------------------------

		xdim=1242
		ydim=1152

		GBLoadWave/A=source/P=chemin/T={2,4}/S=8192/W=1/B/Q nombin
		Redimension/N=(xdim,ydim) source1
		Duplicate/O/D source1 gisaxs2D0
		Reverse/P gisaxs2D0
		gisaxs2D=gisaxs2D0
		Killwaves source1,gisaxs2D0

		If (cmpstr(ask,"yes")==0) 
			SetDrawEnv fsize=16,textrgb=(65535,65535,65535)
			sprintf s,"\\F'Symbol'j\\F'Arial' = %2.0f"+" deg", phi_detec
			DrawText 0.65,0.18,s
			SetDrawLayer UserFront

			DoUpdate

			AddMovieFrame
			SetDrawLayer/K UserFront
		Else
			DoUpdate
		Endif

		//----------------------cut------------------------------------------------------------------------------------------------------------------------------------------
		i=1
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX  wavevector0 
		Duplicate/O/D W_ImageLineProfile scatintensity0
		wavevector0=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity0=scatintensity0+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity0=scatintensity0/i

		Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0

		scatintensity2D[][j]=scatintensity0[p]
		
		If ((j+firstimage)<9)
			nombin=nombin[0,strlen(nombin)-5]+num2str(j+firstimage+1)+"ccd"
		Elseif ((j+firstimage)<99)
			nombin=nombin[0,strlen(nombin)-6]+num2str(j+firstimage+1)+"ccd"
		Else
			nombin=nombin[0,strlen(nombin)-7]+num2str(j+firstimage+1)+"ccd"
		Endif
	Endfor
	
	If (cmpstr(ask,"yes")==0) 
		CloseMovie
		Print "GISAXS movie has been created"
	Endif

	//----------------------display image------------------------------------------------------------------------------------------------------------------------------------------

	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {twothetaf,phif}
	ModifyImage scatintensity2D ctab= {*,*,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
	Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d
	
	Killwaves source0
	phi_detec=phimin

	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_RSMd2am(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,cut_pos,cut_width,alphai_detec,phi_detec
	Variable/G rsmvar=1
	Wave/D twothetaf,alphaf,gisaxs2d
	String chemin, nombin
	String ask="no"
	Variable xdim,ydim
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i,j,firstimage,phimin,phimax
	phimin=0
	phimax=90
	
	Prompt phimin,"Azimuthal angle min. (deg.):"
	Prompt phimax,"Azimuthal angle max. (deg.):"
	Prompt ask, "Create video:", popup "yes;no;"
	DoPrompt "Enter parameters",phimin,phimax,ask
	
	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	Make/O/N=(numpnts(twothetaf)-1,phimax-phimin+1)/D scatintensity2D
	Make/O/N=(phimax-phimin+2)/D phif
	phif=x+phimin-0.5

	Duplicate/O/D scatintensity2D simtwothetaf,simalphaf,simphif,wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	simtwothetaf[][]=twothetaf[p]
	simalphaf=cut_pos
	simphif=y+phimin
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf*pi/180)*cos(simalphaf*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf*pi/180)*cos(simalphaf*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(simphif*pi/180)+wavevector_ytemp*sin(simphif*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(simphif*pi/180)+wavevector_ytemp*cos(simphif*pi/180)
	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	
	Duplicate/O/D twothetaf simtwothetaf

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	LoadWave/A=source/B="F=-2;"/J/Q
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]

	String manip="sep2010"		// sep2010, dec2010, sep2011
	Variable startnumber
	String extensionfile
	If (cmpstr(manip,"sep2010")==0)
		startnumber=6
		extensionfile="DGF_EDF"
	ElseIf (cmpstr(manip,"dec2010")==0)
		startnumber=3
		extensionfile="_EDF"
	Elseif (cmpstr(manip,"sep2011")==0)
		startnumber=2
		extensionfile="dgf.edf"
	Endif

	firstimage=str2num(nombin[startnumber,startnumber+2])

	String spectramoviename="GISAXSmovie"
	String s

	If (cmpstr(ask,"yes")==0) 
		NewMovie/F=10/L/O/P=chemin/Z as spectramoviename
	Endif

	For(j=0;j<phimax-phimin+1;j+=1)
		print "Azimuthal angle =",j+phimin,"deg.",nombin
		phi_detec=j+phimin

		//----------------------load------------------------------------------------------------------------------------------------------------------------------------------

		xdim=dimsize(gisaxs2d,0)
		ydim=dimsize(gisaxs2d,1)

		GBLoadWave/A=source/P=chemin/T={32,4}/S=1024/W=1/F=1/B=1/Q nombin
		Redimension/N=(xdim,ydim) source1
		Duplicate/O/D source1 gisaxs2D0
		Reverse/dim=1/P gisaxs2D0
		gisaxs2D=gisaxs2D0
		Killwaves source1,gisaxs2D0

		If (cmpstr(ask,"yes")==0) 
			SetDrawEnv fsize=16,textrgb=(65535,65535,65535)
			sprintf s,"\\F'Symbol'j\\F'Arial' = %2.0f"+" deg", phi_detec
			DrawText 0.65,0.18,s
			SetDrawLayer UserFront

			DoUpdate

			AddMovieFrame
			SetDrawLayer/K UserFront
		Else
			DoUpdate
		Endif

		//----------------------cut------------------------------------------------------------------------------------------------------------------------------------------
		i=1
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX  wavevector0 
		Duplicate/O/D W_ImageLineProfile scatintensity0
		wavevector0=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity0=scatintensity0+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity0=scatintensity0/i

		Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0

		scatintensity2D[][j]=scatintensity0[p]
		
		nombin=s_filename[0,startnumber-1]+num2str(j+firstimage+1)+extensionfile
	Endfor

	If (cmpstr(ask,"yes")==0) 
		CloseMovie
		Print "GISAXS movie has been created"
	Endif

	//----------------------display image------------------------------------------------------------------------------------------------------------------------------------------

	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {twothetaf,phif}
	ModifyImage scatintensity2D ctab= {*,*,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
	Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d
	
	Killwaves source0
	phi_detec=phimin

	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_RSMd2amxpad(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,cut_pos,cut_width,alphai_detec,phi_detec,Vmincol,Vmaxcol
	Variable/G rsmvar=1
	Wave/D twothetaf,alphaf,gisaxs2d
	String chemin, nombin
	String ask="no"
	Variable xdim,ydim
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i,j,firstimage,phimin,phimax,phistep
	phimin=-10
	phimax=10
	phistep=0.05
	
	Prompt phimin,"Azimuthal angle min. (deg.):"
	Prompt phimax,"Azimuthal angle max. (deg.):"
	Prompt phistep,"Azimuthal step (deg.):"
	Prompt ask, "Create video:", popup "yes;no;"
	DoPrompt "Enter parameters",phimin,phimax,phistep,ask
	
	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	Make/O/N=(numpnts(twothetaf)-1,(phimax-phimin)/phistep+1)/D scatintensity2D
	Make/O/N=((phimax-phimin)/phistep+2)/D phif
	phif=x*phistep+phimin-0.5*phistep

	Duplicate/O/D scatintensity2D simtwothetaf,simalphaf,simphif,wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	simtwothetaf[][]=twothetaf[p]
	simalphaf=cut_pos
	simphif=y*phistep+phimin
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf*pi/180)*cos(simalphaf*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf*pi/180)*cos(simalphaf*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(simphif*pi/180)+wavevector_ytemp*sin(simphif*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(simphif*pi/180)+wavevector_ytemp*cos(simphif*pi/180)
	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	
	Duplicate/O/D twothetaf simtwothetaf

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	LoadWave/A=source/B="F=-2;"/J/Q
	Wave/T source0
	Variable byteorder
	String bytetemp=source0[2]
	bytetemp=bytetemp[13,15]
	If (cmpstr(bytetemp,"Low")==0)
		byteorder=1
	Else
		byteorder=0
	Endif
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	
	firstimage=str2num(nombin[8,10])	// manips sept2012
	
	String spectramoviename="GISAXSmovie"
	String s

	If (cmpstr(ask,"yes")==0) 
		NewMovie/F=10/L/O/P=chemin/Z as spectramoviename
	Endif

	For(j=0;j<(phimax-phimin)/phistep+1;j+=1)
		print "Azimuthal angle =",j*phistep+phimin,"deg.",nombin
		phi_detec=j*phistep+phimin

		//----------------------load------------------------------------------------------------------------------------------------------------------------------------------

		xdim=dimsize(gisaxs2d,0)
		ydim=dimsize(gisaxs2d,1)
		
		GBLoadWave/A=source/P=chemin/T={2,4}/S=512/W=1/B=(byteorder) nombin
		If (ydim > xdim)
			Redimension/N=(xdim,ydim) source1
			Duplicate/O/D source1 gisaxs2D0
		Else
			Redimension/N=(ydim,xdim) source1
			Duplicate/O/D source1 gisaxs2D0
			MatrixTranspose gisaxs2D0
		Endif
		gisaxs2D=gisaxs2D0
		Killwaves source1,gisaxs2D0

		If (cmpstr(ask,"yes")==0) 
			SetDrawEnv fsize=16,textrgb=(65535,65535,65535)
			sprintf s,"\\F'Symbol'j\\F'Arial' = %2.0f"+" deg", phi_detec
			DrawText 0.65,0.18,s
			SetDrawLayer UserFront

			DoUpdate

			AddMovieFrame
			SetDrawLayer/K UserFront
		Else
			DoUpdate
		Endif

		//----------------------cut------------------------------------------------------------------------------------------------------------------------------------------
		i=1
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX  wavevector0 
		Duplicate/O/D W_ImageLineProfile scatintensity0
		wavevector0=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity0=scatintensity0+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity0=scatintensity0/i

		Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0

		scatintensity2D[][j]=scatintensity0[p]
		
		nombin=s_filename[0,7]+num2str(j+firstimage+1)+"g.edf"		// manips sept2012

	Endfor

	If (cmpstr(ask,"yes")==0) 
		CloseMovie
		Print "GISAXS movie has been created"
	Endif

	//----------------------display image------------------------------------------------------------------------------------------------------------------------------------------

	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {twothetaf,phif}
	ModifyImage scatintensity2D ctab= {Vmincol,Vmaxcol,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
	Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d
	
	Killwaves source0
	phi_detec=phimin

	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_RSMsixs(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,cut_pos,cut_width,alphai_detec,phi_detec
	Variable/G rsmvar=1
	Wave/D twothetaf,alphaf,gisaxs2d
	String chemin, nombin
	String ask="no"
	Variable xdim,ydim
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i,j,firstimage,phimin,phimax
	phimin=0
	phimax=90
	
	Prompt phimin,"Azimuthal angle min. (deg.):"
	Prompt phimax,"Azimuthal angle max. (deg.):"
	Prompt ask, "Create video:", popup "yes;no;"
	DoPrompt "Enter parameters",phimin,phimax,ask
	
	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	Make/O/N=(numpnts(twothetaf)-1,phimax-phimin+1)/D scatintensity2D
	Make/O/N=(phimax-phimin+2)/D phif
	phif=x+phimin-0.5

	Duplicate/O/D scatintensity2D simtwothetaf,simalphaf,simphif,wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	simtwothetaf[][]=twothetaf[p]
	simalphaf=cut_pos
	simphif=y+phimin
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf*pi/180)*cos(simalphaf*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf*pi/180)*cos(simalphaf*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(simphif*pi/180)+wavevector_ytemp*sin(simphif*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(simphif*pi/180)+wavevector_ytemp*cos(simphif*pi/180)
	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	
	Duplicate/O/D twothetaf simtwothetaf

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	LoadWave/A=source/B="F=-2;"/J/Q
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]

	String nombintemp=nombin[0,strlen(nombin)-5]
	i=0
	Do
		i+=1
	While (numtype(str2num(nombintemp[strlen(nombintemp)-i,strlen(nombintemp)]))==0)

	firstimage=str2num(nombintemp[strlen(nombintemp)-i+1,strlen(nombintemp)])
	nombintemp=nombintemp[0,strlen(nombintemp)-strlen(num2str(firstimage))-1]
	print firstimage,nombintemp

	String spectramoviename="GISAXSmovie"
	String s

	If (cmpstr(ask,"yes")==0) 
		NewMovie/F=10/L/O/P=chemin/Z as spectramoviename
	Endif

	For(j=0;j<phimax-phimin+1;j+=1)
		print "Azimuthal angle =",j+phimin,"deg.",nombin
		phi_detec=j+phimin

		//----------------------load------------------------------------------------------------------------------------------------------------------------------------------

		xdim=dimsize(gisaxs2d,0)
		ydim=dimsize(gisaxs2d,1)

		GBLoadWave/A=source/P=chemin/T={80,4}/W=1 nombin
		Redimension/N=(xdim,ydim) source1
		Duplicate/O/D source1 gisaxs2D0
		MatrixTranspose gisaxs2D0
		Reverse/dim=1/P gisaxs2D0
		Reverse/dim=0/P gisaxs2D0
		gisaxs2D=gisaxs2D0
		Killwaves source1,gisaxs2D0

		If (cmpstr(ask,"yes")==0) 
			SetDrawEnv fsize=16,textrgb=(65535,65535,65535)
			sprintf s,"\\F'Symbol'j\\F'Arial' = %2.0f"+" deg", phi_detec
			DrawText 0.65,0.18,s
			SetDrawLayer UserFront

			DoUpdate

			AddMovieFrame
			SetDrawLayer/K UserFront
		Else
			DoUpdate
		Endif

		//----------------------cut------------------------------------------------------------------------------------------------------------------------------------------
		i=1
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX  wavevector0 
		Duplicate/O/D W_ImageLineProfile scatintensity0
		wavevector0=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity0=scatintensity0+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity0=scatintensity0/i

		Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0

		scatintensity2D[][j]=scatintensity0[p]
		
		nombin=nombintemp+num2str(j+firstimage+1)+".bin"
		
	Endfor

	If (cmpstr(ask,"yes")==0) 
		CloseMovie
		Print "GISAXS movie has been created"
	Endif

	//----------------------display image------------------------------------------------------------------------------------------------------------------------------------------

	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {twothetaf,phif}
	ModifyImage scatintensity2D ctab= {*,*,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
	Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d
	
	Killwaves source0
	phi_detec=phimin

	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
		
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_RSMsixsasc(ctrlName) : ButtonControl
	String ctrlName
	NVAR long_onde,cut_pos,cut_width,alphai_detec,phi_detec
	Variable/G rsmvar=1
	Wave/D twothetaf,alphaf,gisaxs2d
	String chemin, nombin
	String ask="no"
	Variable xdim,ydim
	Variable pixelYdeb,pixelYfin,pixelZdeb,pixelZfin
	Variable i,j,firstimage,phimin,phimax
	phimin=0
	phimax=90
	
	Prompt phimin,"Azimuthal angle min. (deg.):"
	Prompt phimax,"Azimuthal angle max. (deg.):"
	Prompt ask, "Create video:", popup "yes;no;"
	DoPrompt "Enter parameters",phimin,phimax,ask
	
	DoWindow/K cut2d
	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Fit_scatintensity2D,Res_scatintensity2D,simgisaxs2D

	Make/O/N=(numpnts(twothetaf)-1,phimax-phimin+1)/D scatintensity2D
	Make/O/N=(phimax-phimin+2)/D phif
	phif=x+phimin-0.5

	Duplicate/O/D scatintensity2D simtwothetaf,simalphaf,simphif,wavevector_xtemp, wavevector_ytemp, wavevector_x2D, wavevector_y2D, wavevector_z2D
	simtwothetaf[][]=twothetaf[p]
	simalphaf=cut_pos
	simphif=y+phimin
	
	wavevector_xtemp[][]=2*pi/long_onde*(cos(simtwothetaf*pi/180)*cos(simalphaf*pi/180)-cos(alphai_detec*pi/180))
	wavevector_ytemp[][]=2*pi/long_onde*(sin(simtwothetaf*pi/180)*cos(simalphaf*pi/180))
	wavevector_x2D[][]=wavevector_xtemp*cos(simphif*pi/180)+wavevector_ytemp*sin(simphif*pi/180)
	wavevector_y2D[][]=-wavevector_xtemp*sin(simphif*pi/180)+wavevector_ytemp*cos(simphif*pi/180)
	wavevector_z2D[][]=2*pi/long_onde*(sin(simalphaf*pi/180)+sin(alphai_detec*pi/180))
	
	Duplicate/O/D twothetaf simtwothetaf

	KillWaves wavevector_xtemp, wavevector_ytemp	
	
	LoadWave/A=source/B="F=-2;"/J/Q
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]

	String nombintemp=nombin[0,strlen(nombin)-5]
	i=0
	Do
		i+=1
	While (numtype(str2num(nombintemp[strlen(nombintemp)-i,strlen(nombintemp)]))==0)

	firstimage=str2num(nombintemp[strlen(nombintemp)-i+1,strlen(nombintemp)])
	nombintemp=nombintemp[0,strlen(nombintemp)-strlen(num2str(firstimage))-1]
	print firstimage,nombintemp

	String spectramoviename="GISAXSmovie"
	String s

	If (cmpstr(ask,"yes")==0) 
		NewMovie/F=10/L/O/P=chemin/Z as spectramoviename
	Endif

	For(j=0;j<phimax-phimin+1;j+=1)
		print "Azimuthal angle =",j+phimin,"deg.",nombin
		phi_detec=j+phimin

		//----------------------load------------------------------------------------------------------------------------------------------------------------------------------

		xdim=dimsize(gisaxs2d,0)
		ydim=dimsize(gisaxs2d,1)

		LoadWave/A=source/D/Q/G/P=chemin nombin
		Redimension/N=(xdim,ydim) source1
		Duplicate/O/D source1 gisaxs2D0
		MatrixTranspose gisaxs2D0
		Reverse/dim=1/P gisaxs2D0
		Reverse/dim=0/P gisaxs2D0		//
		gisaxs2D=gisaxs2D0
		Killwaves source1,gisaxs2D0

		If (cmpstr(ask,"yes")==0) 
			SetDrawEnv fsize=16,textrgb=(65535,65535,65535)
			sprintf s,"\\F'Symbol'j\\F'Arial' = %2.0f"+" deg", phi_detec
			DrawText 0.65,0.18,s
			SetDrawLayer UserFront

			DoUpdate

			AddMovieFrame
			SetDrawLayer/K UserFront
		Else
			DoUpdate
		Endif

		//----------------------cut------------------------------------------------------------------------------------------------------------------------------------------
		i=1
		pixelYdeb=0
		pixelYfin=numpnts(twothetaf)-2
		pixelZdeb=-1
		Do
			pixelZdeb=pixelZdeb+1
		While (alphaf[pixelZdeb]<cut_pos-cut_width/2)
		pixelZfin=pixelZdeb
		Do
			pixelZfin=pixelZfin+1
		While (alphaf[pixelZfin]<cut_pos+cut_width/2)

		Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
		ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
		Duplicate/O/D W_LineProfileX  wavevector0 
		Duplicate/O/D W_ImageLineProfile scatintensity0
		wavevector0=x

		Do
			pixelZdeb=pixelZdeb+1
			Make/O/N=2 xPixel={pixelYdeb,pixelYfin},yPixel={pixelZdeb,pixelZdeb}
			ImageLineProfile xwave=xPixel, ywave=yPixel, srcwave=gisaxs2D
			Duplicate/O/D W_ImageLineProfile profiletemp
			scatintensity0=scatintensity0+profiletemp
			i=i+1
		While (pixelZdeb<pixelZfin-1)

		scatintensity0=scatintensity0/i

		Killwaves/Z profiletemp,xPixel,yPixel,W_LineProfileX,W_LineProfileY,W_ImageLineProfile,tempx,tempy,tempimage,tempradius,tempangle,tempsector,radial0

		scatintensity2D[][j]=scatintensity0[p]
		
		nombin=nombintemp+num2str(j+firstimage+1)+".txt"
	Endfor

	If (cmpstr(ask,"yes")==0) 
		CloseMovie
		Print "GISAXS movie has been created"
	Endif

	//----------------------display image------------------------------------------------------------------------------------------------------------------------------------------

	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity2D vs {twothetaf,phif}
	ModifyImage scatintensity2D ctab= {*,*,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
	Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"
	DoWindow/C cut2d
	
	Killwaves source0
	phi_detec=phimin

	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(2)
	DoWindow/C Fit2d_parameters
		
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_Fit1D(ctrlName) : ButtonControl
	String ctrlName

	RemoveFromGraph/Z fit_peakposition
	DoWindow/K Fit1d_parameters
	DoWindow/K Fit2d_parameters
	askfittingparameters(1)
	DoWindow/C Fit1d_parameters
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_guinierplot(ctrlName) : ButtonControl
	String ctrlName
	Wave/D wavevector,scatintensity
	DoWindow/K Guinier_plot
	Duplicate/O/D wavevector wavevector2
	Duplicate/O/D scatintensity logscatintensity
	wavevector2=wavevector^2
	logscatintensity=Ln(scatintensity)
	Display/W=(480, 298, 880, 528) logscatintensity vs wavevector2
	ModifyGraph mirror=2, btLen=5, fSize=14, zero(bottom)=1
	Label bottom "q\\S2\\M (nm\\S-2\\M)"
	Label left "Ln I(q) (arb. units)"
	ShowInfo
	ControlBar 30
	Button guinier0 title="Diameter", proc=ButtonProc_guinierslope, pos={10,5}, size={60,20},fsize=11
	Button guinier1 title="Differentiate", proc=ButtonProc_differentiate, pos={80,5}, size={75,20},fsize=11
	Button guinier2 title="Autoscale", proc=ButtonProc_autoscale, pos={165,5}, size={60,20},fsize=11
	DoWindow/C Guinier_plot
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_peakposition(ctrlName) : ButtonControl
	String ctrlName
	Wave/D scatintensity,wavevector,W_coef,twothetaf,alphaf
	NVAR cut_angle
	CurveFit/Q gauss  scatintensity[pcsr(A),pcsr(B)] /D /X=wavevector /D 
	ModifyGraph rgb(fit_scatintensity)=(16384,16384,65280)
	Print "Fit from x =",wavevector[V_startRow]," to x =",wavevector[V_endRow],", peak at xmax =",W_coef(2),"(2pi/xmax =",2*pi/W_coef(2),")"
	RemoveFromGraph/Z fit_peakposition
	KillWaves/Z fit_peakposition
	Rename fit_scatintensity fit_peakposition
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_guinierslope(ctrlName) : ButtonControl
	String ctrlName
	Wave/D logscatintensity,wavevector2,W_coef
	If (numtype(str2num(StringByKey("point", CsrInfo(A))))==2)		// si le curseur A n'existe pas sur le graph
		Abort "Cursor A is not present on the graph !"
	Endif
	If (numtype(str2num(StringByKey("point", CsrInfo(B))))==2)		// si le curseur B n'existe pas sur le graph
		Abort "Cursor B is not present on the graph !"
	Endif
	CurveFit/Q line  logscatintensity[pcsr(A),pcsr(B)] /X=wavevector2 /D 
	ModifyGraph rgb(fit_logscatintensity)=(16384,16384,65280)
	Print "Guinier Plot: slope =",W_coef(2),"nm?->	Guinier diameter: Dg =", 2*sqrt(-3*W_coef(2)),"nm	->	Diameter: D =", 2*sqrt(-3*W_coef(2))*sqrt(5/3),"nm"
	If (sqrt(wavevector2[V_startRow])<sqrt(wavevector2[V_endRow]))
		Print "	----- Correlation of",V_Pr,"from q =",sqrt(wavevector2[V_startRow]),"1/nm [",V_startRow,"] to",sqrt(wavevector2[V_endRow]),"1/nm [",V_endRow,"] -----"
	Else
		Print "	----- Correlation of",V_Pr,"from q =",-sqrt(wavevector2[V_startRow]),"1/nm [",V_startRow,"] to",-sqrt(wavevector2[V_endRow]),"1/nm [",V_endRow,"] -----"
	Endif
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_differentiate(ctrlName) : ButtonControl
	String ctrlName
	Wave/D logscatintensity,wavevector2	
	Differentiate logscatintensity/X=wavevector2
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_linscale1d(ctrlName) : ButtonControl
	String ctrlName
	Button intens21 disable=1
	Button intens22 disable=0
	ModifyGraph log(left)=0
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_logscale1d(ctrlName) : ButtonControl
	String ctrlName
	Button intens21 disable=0
	Button intens22 disable=1
	ModifyGraph log(left)=1
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_renamewavecut(ctrlName) : ButtonControl
	String ctrlName
	String new_wa_name="wavevector"
	String new_sc_name="scatintensity"
	String new_wi_name="cut"
	
	Prompt new_wa_name, "Enter new wavector name: "
	Prompt new_sc_name, "Enter new scatintensity name: "
	Prompt new_wi_name, "Enter new window name: "
	DoPrompt "Enter new wave names", new_wa_name, new_sc_name,new_wi_name
	
	Rename wavevector,$new_wa_name; Rename scatintensity,$new_sc_name;
	PopupMenu popup0 disable=1
	Button intens0 disable=1
	Button intens1 disable=1
	Button intens5 disable=1
	Button intens6 disable=1
	DoWindow/C $new_wi_name
End

//°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°?
//---------------------------------------------------------------------------------------------------------------------------------------------------------------
//°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°?
//---------------------------------------------------------------------------------------------------------------------------------------------------------------
//°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°?

Function Load_d22()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String ligne, chemin, nombin
	Variable xdim, ydim, file1, directYtemp

	Open/R/M="Choisir le fichier (extension .hea)"/T=".hea"  file1
	Silent 1

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"xdim")!=0)
	xdim=Str2Num(ligne[17,25])
	FReadLine file1,ligne
	ydim=Str2Num(ligne[17,25])

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"Regr")!=0)
	resolutionX=Str2Num(ligne[12,15])*0.05625
	FReadLine file1, ligne
	resolutionY=Str2Num(ligne[12,15])*0.05625

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"mono")!=0)
	long_onde=1239.97/Str2Num(ligne[7,25])

	FStatus file1
	Close file1

	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)-4]+"bin"			//strlen(str ) <> Returns the number of characters in the string expression str.
	GBLoadWave/B/A=source/P=chemin/T={32,4}/W=1/F=1 nombin	//GBLoadWave [/A[=baseName]/D[=d]/N[=baseName] /O[=o] /P=pathName  /I[=TYPE] /Q[=q] /V[=v]/T={fType, wType}/L=l/F=f/J=j/B/W=w/U=u/S=s/Y={offset, multiplier}] fileNameStr <> The GBLoadWave operation loads data from the named binary file into waves.
	Wave/D source0
	Redimension/N=(xdim,ydim) source0
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
	Reverse/dim=1/P gisaxs2D

	directYtemp=ydim-1-DirectYinit

	DirectYinit=DirectYtemp

End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_dw31b()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String ligne, chemin, nombin
	Variable xdim, ydim, file1, directYtemp

	Open/R/M="Choisir le fichier (extension .hea)"/T=".hea"  file1
	Silent 1

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"xdim")!=0)
	xdim=Str2Num(ligne[17,25])
	FReadLine file1,ligne
	ydim=Str2Num(ligne[17,25])

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"Regr")!=0)
	resolutionX=Str2Num(ligne[12,15])*0.05625
	FReadLine file1, ligne
	resolutionY=Str2Num(ligne[12,15])*0.05625

	Do
		FReadLine file1,ligne
	While(CmpStr(ligne[0,3],"mono")!=0)
	long_onde=1239.97/Str2Num(ligne[11,25])

	FStatus file1
	Close file1

	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)-4]+"bin"			//strlen(str ) <> Returns the number of characters in the string expression str.
	GBLoadWave/B/A=source/P=chemin/T={32,4}/W=1/F=1 nombin	//GBLoadWave [/A[=baseName]/D[=d]/N[=baseName] /O[=o] /P=pathName  /I[=TYPE] /Q[=q] /V[=v]/T={fType, wType}/L=l/F=f/J=j/B/W=w/U=u/S=s/Y={offset, multiplier}] fileNameStr <> The GBLoadWave operation loads data from the named binary file into waves.
	Wave/D source0
	Redimension/N=(xdim,ydim) source0
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
	Reverse/dim=1/P gisaxs2D

	directYtemp=ydim-1-DirectYinit

	DirectYinit=DirectYtemp

End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_d2am()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Wave/T source0
	dimtemp=source0[5]
	xdim=str2num(dimtemp[18,21])
	resolutionX=0.05*1340/str2num(dimtemp[18,21])
	dimtemp=source0[6]
	ydim=str2num(dimtemp[18,21])
	resolutionY=0.05*1300/str2num(dimtemp[18,21])
	bytetemp=source0[2]
	bytetemp=bytetemp[18,20]
	If (cmpstr(bytetemp,"Low")==0)
		byteorder=1
	Else
		byteorder=0
	Endif
	
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={32,4}/S=1024/W=1/F=1/B=(byteorder) nombin
	Wave/D source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	If (directXinit < 0.1*xdim)
		MatrixTranspose gisaxs2D
		directYtemp=DirectXinit
		directXtemp=DirectYinit
		ydimtemp=xdim
		xdimtemp=ydim
		resolutionYtemp=resolutionX
		resolutionXtemp=resolutionY
	ElseIf (directXinit > 0.9*xdim)
		MatrixTranspose gisaxs2D
		Reverse/dim=1/P gisaxs2D
		directYtemp=xdim-1-DirectXinit
		directXtemp=DirectYinit
		ydimtemp=xdim
		xdimtemp=ydim
		resolutionYtemp=resolutionX
		resolutionXtemp=resolutionY
	Else
		Reverse/dim=1/P gisaxs2D
		directYtemp=ydim-1-DirectYinit
		directXtemp=DirectXinit
		ydimtemp=ydim
		xdimtemp=xdim
		resolutionYtemp=resolutionY
		resolutionXtemp=resolutionX
	Endif

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_d2am_xpad()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Wave/T source0
	dimtemp=source0[4]
	xdim=str2num(dimtemp[8,11])
	resolutionX=0.13
	dimtemp=source0[5]
	ydim=str2num(dimtemp[8,11])
	resolutionY=0.13
	bytetemp=source0[2]
	bytetemp=bytetemp[13,15]
	If (cmpstr(bytetemp,"Low")==0)
		byteorder=1
	Else
		byteorder=0
	Endif
	
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={2,4}/S=512/W=1/B=(byteorder) nombin
	Wave/D source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
	
	If (directXinit < directYinit)
		MatrixTranspose gisaxs2D
		directYtemp=DirectXinit
		directXtemp=DirectYinit
		DirectXinit=directXtemp
		DirectYinit=DirectYtemp
	Endif
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_bm32()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q
	xdim=1242
	ydim=1152
	resolutionX=0.05625
	resolutionY=0.05625
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={32,4}/S=4096/W=1/F=1/B=1 nombin
	Wave/D source1
	DeletePoints 0,1,source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	MatrixTranspose gisaxs2D
	Reverse/dim=1/P gisaxs2D
	directYtemp=xdim-1-DirectXinit
	directXtemp=DirectYinit
	ydimtemp=xdim
	xdimtemp=ydim
	resolutionYtemp=resolutionX
	resolutionXtemp=resolutionY

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_bm20()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q/L={0, 0, 0, 2, 0 }
	xdim=2048
	ydim=2048
	resolutionX=0.064447
	resolutionY=0.064447
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={16,4}/W=1 nombin
	Wave/D source0
	Redimension/N=(xdim,ydim) source0
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0

	directXtemp=DirectXinit
	directYtemp=DirectYinit
	ydimtemp=xdim
	xdimtemp=ydim
	resolutionYtemp=resolutionX
	resolutionXtemp=resolutionY

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_id10b()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q
	xdim=1296
	ydim=256
	resolutionX=0.055
	resolutionY=0.055
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]

	GBLoadWave/A=source/P=chemin/T={32,4}/S=3072/W=1/B nombin
	Wave/D source1
	DeletePoints 0,1,source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	MatrixTranspose gisaxs2D
	Reverse/P gisaxs2D

	directYtemp=xdim-1-DirectXinit
	directXtemp=ydim-1-DirectYinit
	ydimtemp=xdim
	xdimtemp=ydim
	resolutionYtemp=resolutionX
	resolutionXtemp=resolutionY

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_id01()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q
	xdim=1242
	ydim=1152
	resolutionX=0.05503
	resolutionY=0.05554
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={2,4}/S=8192/W=1/B nombin
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	Reverse/P gisaxs2D
	directYtemp=ydim-1-DirectYinit
	directXtemp=xdim-1-DirectXinit
	ydimtemp=ydim
	xdimtemp=xdim
	resolutionYtemp=resolutionY
	resolutionXtemp=resolutionX
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swing_asc()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/J/D/Q/M
	Print "File",S_filename,"loaded"
	xdim=Dimsize(source0,0)
	ydim=Dimsize(source0,1)
	Variable bintemp=4096/xdim
	resolutionX=0.04174*bintemp
	resolutionY=0.04174*bintemp
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
	
	MatrixTranspose gisaxs2D
	Reverse/P gisaxs2D
	Reverse/DIM=0/P gisaxs2D
	
	DirectYinit=ydim-1-DirectYinit
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swing_edf()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Wave/T source0
	dimtemp=source0[4]
	xdim=str2num(dimtemp[17,20])
	resolutionX=0.05*1340/str2num(dimtemp[17,20])
	dimtemp=source0[5]
	ydim=str2num(dimtemp[17,20])
	resolutionY=0.05*1300/str2num(dimtemp[17,20])
	bytetemp=source0[2]
	bytetemp=bytetemp[17,19]
	If (cmpstr(bytetemp,"Low")==0)
		byteorder=1
	Else
		byteorder=0
	Endif
	
	dimtemp=source0[25]
	long_onde=1239.97/str2num(dimtemp[50,55])
	dimtemp=source0[24]
	distance=str2num(dimtemp[50,55])
	
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={80,4}/S=4404/W=1/B=(byteorder) nombin
	Wave/D source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
	
	Reverse/dim=1/P gisaxs2D
	directYtemp=ydim-1-DirectYinit
	directXtemp=DirectXinit
	ydimtemp=ydim
	xdimtemp=xdim
	resolutionYtemp=resolutionY
	resolutionXtemp=resolutionX

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swing_bin()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q
	Killwaves/Z source1
	xdim=1024
	ydim=1024
	resolutionX=0.04174*4
	resolutionY=0.04174*4
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={80,4}/W=1 nombin
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	Reverse/P gisaxs2D
	Reverse/P/DIM=0 gisaxs2D
	directYtemp=ydim-1-DirectYinit
	directXtemp=DirectXinit
	ydimtemp=ydim
	xdimtemp=xdim
	resolutionYtemp=resolutionY
	resolutionXtemp=resolutionX
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_sixs_bin()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/B="F=-2;"/J/Q
	Killwaves/Z source1
	xdim=2046
	ydim=2046
	resolutionX=0.08
	resolutionY=0.08
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={80,4}/W=1 nombin
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1

	MatrixTranspose gisaxs2D
	Reverse/dim=1/P gisaxs2D
	Reverse/dim=0/P gisaxs2D
	directYtemp=xdim-1-DirectXinit
	directXtemp=DirectYinit
	ydimtemp=xdim
	xdimtemp=ydim
	resolutionYtemp=resolutionX
	resolutionXtemp=resolutionY

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_sixs_asc()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String chemin, nombin
	Variable  xdim, ydim, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/D/Q/G
	Print "File",S_filename,"loaded"
	xdim=2048
	ydim=2048
	resolutionX=0.08
	resolutionY=0.08
	Redimension/N=(xdim,ydim) source0
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
	
	MatrixTranspose gisaxs2D
	Reverse/dim=1/P gisaxs2D
	Reverse/dim=0/P gisaxs2D		//
	directYtemp=xdim-DirectXinit
	directXtemp=ydim-DirectYinit		// DirectYinit-1
	ydimtemp=xdim
	xdimtemp=ydim
	resolutionYtemp=resolutionX
	resolutionXtemp=resolutionY

	resolutionX=resolutionXtemp
	resolutionY=resolutionYtemp
	DirectXinit=directXtemp
	DirectYinit=DirectYtemp
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_sixs_xpad()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
//	String chemin, nombin
//	Variable  directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp
	
	LoadWave/A=source/D/Q/G/M
	Print "File",S_filename,"loaded"
//	xdim=dimsize(source0,0)
//	ydim=dimsize(source0,1)
	resolutionX=0.13
	resolutionY=0.13
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
	
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_ip()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	Variable xdim, ydim
	String chemin, nombin

	LoadWave/A=source/B="F=-2;"/J/Q
	xdim=540
	ydim=307
	resolutionX=0.176
	resolutionY=0.176
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={80,4}/B/S=614/W=1 nombin
	Wave/D source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_imagefile()
	NVAR resolutionX, resolutionY
	Variable resolutionXtemp=resolutionX
	Variable resolutionYtemp=resolutionY
	
	Prompt resolutionXtemp, "Horizontal pixel size (mm):"
	Prompt resolutionYtemp, "Vertical pixel size (mm):"
	DoPrompt "Enter parameters", resolutionXtemp, resolutionYtemp
	
	ImageLoad/T=tiff/O/N=gisaxs2D
	Reverse/DIM=1/P gisaxs2d
	resolutionX=resolutionXtemp
	resolutionY=resolutionXtemp
End


//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_textfile()
	NVAR resolutionX, resolutionY
	Variable resolutionXtemp=resolutionX
	Variable resolutionYtemp=resolutionY
	
	Prompt resolutionXtemp, "Horizontal pixel size (mm):"
	Prompt resolutionYtemp, "Vertical pixel size (mm):"
	DoPrompt "Enter parameters", resolutionXtemp, resolutionYtemp
	
	LoadWave/A=source/D/Q/G/M
	Print "File",S_filename,"loaded"
	resolutionX=resolutionXtemp
	resolutionY=resolutionXtemp
	Duplicate/O/D source0 gisaxs2D
	Killwaves source0
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function correctmonitoring()
	Wave/D gisaxs2D
	Wave/T textWave1
	Variable Izero=1
	String Fileref=""
	NVAR sinalphai_sample,alphai_detec
	
	Prompt Izero,"Enter monitor intensity"
	Prompt Fileref,"Enter reference file"
	DoPrompt "Monitoring",Izero,Fileref
	If (Izero!=1)
		If (cmpstr(textWave1[3],"Supported islands")==0)
			gisaxs2D=gisaxs2D/Izero*sin(alphai_detec*pi/180)
			Print "gisaxs2D = gisaxs2D /",Izero,"/",1/sin(alphai_detec*pi/180)
		Else
			gisaxs2D=gisaxs2D/Izero*sinalphai_sample
			Print "gisaxs2D = gisaxs2D /",Izero,"/",1/sinalphai_sample
		Endif
	Endif

	If (cmpstr(Fileref,"")!=0)
		Fileref="gisaxs2D-="+Fileref
		Execute Fileref
		Print Fileref
	Endif
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swingbin()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Variable bintemp=4
	xdim=4096/bintemp
	ydim=4096/bintemp
	resolutionX=0.041*bintemp
	resolutionY=0.041*bintemp
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={80,4}/W=1 nombin
	Wave/D source1
	Variable numtemp=numpnts(source1)-xdim*ydim
print numtemp	
	DeletePoints 0,numtemp,source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
	
	Reverse/dim=1/P gisaxs2D
	
	DirectYinit=ydim-1-DirectYinit
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swing1()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Variable bintemp=4
	xdim=4096/bintemp
	ydim=4096/bintemp
	resolutionX=0.041*bintemp
	resolutionY=0.041*bintemp
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={2,4}/W=1/F=1/B=1 nombin
	Wave/D source1
	Variable numtemp=numpnts(source1)-xdim*ydim
	DeletePoints 0,numtemp,source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
	
	Reverse/dim=1/P gisaxs2D
	
	DirectYinit=ydim-1-DirectYinit
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Load_swing2()
	NVAR resolutionX, resolutionY, directXinit, directYinit, alphai_detec, distance, long_onde
	String dimtemp, bytetemp, chemin, nombin
	Variable xdim, ydim, byteorder, directXtemp, xdimtemp, resolutionXtemp, directYtemp, ydimtemp, resolutionYtemp

	LoadWave/A=source/B="F=-2;"/J/Q
	Variable bintemp=4
	xdim=4096/bintemp
	ydim=4096/bintemp
	resolutionX=0.041*bintemp
	resolutionY=0.041*bintemp
	NewPath/O/Q chemin, s_path
	nombin=s_filename[0,StrLen(s_filename)]
	GBLoadWave/A=source/P=chemin/T={2,4}/W=1/F=1/B=1/J=2 nombin
	Wave/D source1
	Variable numtemp=numpnts(source1)-xdim*ydim
	DeletePoints 0,numtemp,source1
	Redimension/N=(xdim,ydim) source1
	Duplicate/O/D source1 gisaxs2D
	Killwaves source0,source1
	
	Reverse/dim=1/P gisaxs2D
	
	DirectYinit=ydim-1-DirectYinit
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function qxqymap(npnts)
	Variable npnts
	DoWindow/K qyqxmap
	NVAR Vmincol,Vmaxcol
	Wave/D scatintensity2D,wavevector_x2D, wavevector_y2D
//	Variable npnts=round(DimSize(scatintensity2D,0)/2)
	
	Wavestats/Q wavevector_x2D
	Variable qxmin=V_min
	Variable qxmax=V_max
	Wavestats/Q wavevector_y2D
	Variable qymin=V_min
	Variable qymax=V_max
	
	Variable i,j
	Variable xpnt,ypnt

	Make/N=(npnts)/D/O qxwave
	Make/N=(npnts)/D/O qywave
	SetScale/I x qxmin,qxmax,"", qxwave
	SetScale/I x qymin,qymax,"", qywave
	Make/O/N=(npnts,npnts)/D scatintensity_qxqy
	SetScale/I x qymin,qymax,"", scatintensity_qxqy
	SetScale/I y qxmin,qxmax,"", scatintensity_qxqy

	scatintensity_qxqy=0
	Duplicate/O scatintensity_qxqy nbrepoints

	For(j=0;j<DimSize(scatintensity2D,1);j+=1)
		For(i=0;i<DimSize(scatintensity2D,0);i+=1)
			xpnt=x2pnt(qywave, wavevector_y2D[i][j] )
			ypnt=x2pnt(qxwave, wavevector_x2D[i][j] )
//			scatintensity_qxqy[xpnt][ypnt]=scatintensity2D[i][j]
			nbrepoints[xpnt][ypnt]+=1
			scatintensity_qxqy[xpnt][ypnt]+=scatintensity2D[i][j]
		Endfor
	Endfor
	
	scatintensity_qxqy=scatintensity_qxqy/max(1,nbrepoints)
	
	KillWaves nbrepoints
	
	Display/M/W=(16.6, 5.3, 21, 11);AppendImage scatintensity_qxqy
	ModifyImage scatintensity_qxqy ctab= {Vmincol,Vmaxcol,Geo,0}
	ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero=1
	Label left "q\Bx\M (nm\S-1\M)"
	Label bottom "q\By\M (nm\S-1\M)"
	DoWindow/C qyqxmap

End

Function corRSMxpad(val)
	Variable val
	Wave/D scatintensity2D
	Variable i
	
	For(i=0;i<DimSize(scatintensity2D,1);i+=1)
		If (scatintensity2D[50][i]>val)
			scatintensity2D[][i]=(scatintensity2D[p][i-1]+scatintensity2D[p][i+1])/2
		Endif
	Endfor
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function askLAYERparameters()
	DoWindow/K Layer_parameters
	String cmd,titletemp
	Wave/D nps,thickness,delta,betta
	Wave/T textWave1
	NVAR slayer,deltaLAY,betaLAY

	If (cmpstr(textWave1[3],"Born approximation")==0)
	
	ElseIf (cmpstr(textWave1[3],"Supported islands")==0)
		slayer=0
		nps=0
	Else
		If (numpnts(nps)==1)
			InsertPoints 0,1, delta,betta,thickness,roughness,nps
			delta[0]=delta[1]
			betta[0]=betta[1]
		Endif
		If (slayer==0)
			slayer=1
			nps[0]=1
		Endif
		If (cmpstr(textWave1[2], "Paracrystal 3D")==0)
			nps=0
			slayer=1
			nps[0]=1
		Endif
	Endif
	
	thickness[numpnts(nps)-1]=inf
	
	If (slayer==0)
		deltaLAY=0
		betaLAY=0
	Else
		deltaLAY=delta[slayer-1]
		betaLAY=betta[slayer-1]	
	Endif

	NewPanel/M/W=(0.2, 1.6, 16.2, min(18.8,3.1+0.9*numpnts(nps)))/N=Layer_parameters	//W=(left, top, right, bottom )
	ModifyPanel/W=Layer_parameters cbRGB=(65280,65280,48896), frameInset= 3, frameStyle= 1

	TitleBox title1 title="      \\F'Symbol'd      ",frame=4,fSize=13,labelBack=(60928,60928,60928),pos={110,8}
	TitleBox title2 title="      \\F'Symbol'b      ",frame=4,fSize=13,labelBack=(60928,60928,60928),pos={210,8}
	TitleBox title3 title="Thickness",frame=4,fSize=13,labelBack=(60928,60928,60928),pos={305,8}
	TitleBox title4 title="Roughness",frame=4,fSize=13,labelBack=(60928,60928,60928),pos={400,8}
	DrawText 325,50,"(nm)"
	DrawText 425,50,"(nm)"

	cmd="CheckBox check0 title=\"\",pos={492,15},mode=1,value="+num2str(1-sum(nps))+",proc=CheckBoxProc"
	Execute cmd
	
	Button button0 title="New table",size={70,20},pos={525,8},fSize=10,proc=ProcNewLayerParameters
	Button button1 title="Insert layer",size={70,20},pos={525,62},fSize=10,proc=ProcInsertLayerParameters
	Button button2 title="Delete layer",size={70,20},pos={525,90},fSize=10,proc=ProcDeleteLayerParameters
	Button button3 title="Display table",size={70,20},pos={525,34},fSize=10,proc=ProcDisplayLayerParameters

	Variable i=0
	For (i=0;i<numpnts(thickness)-1;i+=1)
		titletemp="\" Layer #"+num2str(i+1)+" \""
		cmd="TitleBox title"+num2str(i+5)+" title="+titletemp+",frame=4,fSize=13,labelBack=(60928,60928,60928),pos={20,"+num2str(50+30*i)+"}"
		Execute cmd
		titletemp="\" \""
		cmd="SetVariable setvar"+num2str(i+1)+" title="+titletemp+",pos={110,"+num2str(55+30*i)+"},size={60,20},value=delta["+num2str(i)+"],limits={0,inf,0},proc=updateLAY"
		Execute cmd
		titletemp="\" \""
		cmd="SetVariable setvar"+num2str(i+101)+" title="+titletemp+",pos={210,"+num2str(55+30*i)+"},size={60,20},value=betta["+num2str(i)+"],limits={0,inf,0},proc=updateLAY"
		Execute cmd
		titletemp="\" \""
		cmd="SetVariable setvar"+num2str(i+201)+" title="+titletemp+",pos={310,"+num2str(55+30*i)+"},size={60,20},value=thickness["+num2str(i)+"],limits={0,inf,0}"
		Execute cmd
		titletemp="\" \""
		cmd="SetVariable setvar"+num2str(i+301)+" title="+titletemp+",pos={410,"+num2str(55+30*i)+"},size={60,20},value=roughness["+num2str(i)+"],limits={0,inf,0}"
		Execute cmd
		
		cmd="CheckBox check"+num2str(i+1)+" title=\"\",pos={492,"+num2str(55+30*i)+"},mode=1,value=nps["+num2str(i)+"],proc=CheckBoxProc"
		Execute cmd

		If (nps[i]==1)
			cmd="TitleBox title"+num2str(i+5)+" labelBack=(39680,59392,38656)"
			Execute cmd
			cmd="SetVariable setvar"+num2str(i+1)+" frame=0,  labelBack=(39680,59392,38656)"
			Execute cmd
			cmd="SetVariable setvar"+num2str(i+101)+" frame=0,  labelBack=(39680,59392,38656)"
			Execute cmd
			cmd="SetVariable setvar"+num2str(i+201)+" frame=0,  labelBack=(39680,59392,38656)"
			Execute cmd
			cmd="SetVariable setvar"+num2str(i+301)+" frame=0,  labelBack=(39680,59392,38656)"
			Execute cmd
		Endif
	Endfor
	titletemp="\" Substrate \""
	cmd="TitleBox title"+num2str(i+5)+" title="+titletemp+",frame=4,fSize=13,labelBack=(52224,52224,52224),pos={20,"+num2str(50+30*i)+"}"
	Execute cmd
	titletemp="\" \""
	cmd="SetVariable setvar"+num2str(i+1)+" title="+titletemp+",pos={110,"+num2str(55+30*i)+"},size={60,20},value=delta["+num2str(i)+"],limits={0,inf,0}"
	Execute cmd
	titletemp="\" \""
	cmd="SetVariable setvar"+num2str(i+101)+" title="+titletemp+",pos={210,"+num2str(55+30*i)+"},size={60,20},value=betta["+num2str(i)+"],limits={0,inf,0}"
	Execute cmd
	titletemp="\" \""
	cmd="SetVariable setvar"+num2str(i+201)+" title="+titletemp+",pos={310,"+num2str(55+30*i)+"},size={60,20},value=thickness["+num2str(i)+"],limits={0,inf,0}"
	Execute cmd
	titletemp="\" \""
	cmd="SetVariable setvar"+num2str(i+301)+" title="+titletemp+",pos={410,"+num2str(55+30*i)+"},size={60,20},value=roughness["+num2str(i)+"],limits={0,inf,0}"
	Execute cmd
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function CheckBoxProc (ctrlName,checked) : CheckBoxControl
	String ctrlName
	Variable checked			// 1 if selected, 0 if not
	Wave nps
	NVAR slayer
	String cmd
	
	nps=0
	Variable i=str2num(ctrlName[5,strlen(ctrlName)])
	If (i==0)
		slayer=0
		askLAYERparameters()
	Else
		nps[i-1]=1
		slayer=i
		askLAYERparameters()
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ProcNewLayerParameters(ctrlName) : ButtonControl
	String ctrlName
	Variable numb_layer=1
	NVAR slayer
	
	slayer=0

	Prompt numb_layer,"Number of layers (including substrate):"
	DoPrompt "Enter layer parameters", numb_layer

	Make/O/D/N=(numb_layer) delta,betta,thickness,roughness,nps
	
	askLAYERparameters()
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ProcInsertLayerParameters(ctrlName) : ButtonControl
	String ctrlName
	Variable numb_layer,delta_layer,beta_layer,thickness_layer,roughness_layer
	NVAR slayer
	Wave/D delta,betta,thickness,roughness,nps
	numb_layer=1
	
	Prompt numb_layer,"Insert new layer before layer #:"
	Prompt delta_layer,"Layer delta:"
	Prompt beta_layer,"Layer beta:"
	Prompt thickness_layer,"Layer thickness (nm):"
	Prompt roughness_layer,"Layer roughness (nm):"
	DoPrompt "Enter layer parameters", numb_layer,delta_layer,beta_layer,thickness_layer,roughness_layer

	InsertPoints numb_layer-1,1, delta,betta,thickness,roughness,nps
	delta[numb_layer-1]=delta_layer
	betta[numb_layer-1]=beta_layer
	thickness[numb_layer-1]=thickness_layer
	roughness[numb_layer-1]=roughness_layer
	nps=0
	slayer=0
	
	askLAYERparameters()
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ProcDeleteLayerParameters(ctrlName) : ButtonControl
	String ctrlName
	Variable numb_layer,delta_layer,beta_layer,thickness_layer,roughness_layer
	NVAR slayer
	Wave/D delta,betta,thickness,roughness,nps
	numb_layer=1
	
	Prompt numb_layer,"Delete layer #:"
	DoPrompt "Enter layer parameters", numb_layer

	DeletePoints numb_layer-1,1, delta,betta,thickness,roughness,nps
	nps=0
	slayer=0

	askLAYERparameters()
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ProcDisplayLayerParameters(ctrlName) : ButtonControl
	String ctrlName
	DoWindow/K Table_Layer_parameters
	Edit/M/W=(0.2, 8, 16.2, 13.5) delta,betta,thickness,roughness,nps
	DoWindow/C Table_Layer_parameters
	ModifyTable width(delta)=72,width(betta)=72,width(thickness)=72,width(roughness)=72,width(nps)=72
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function updateLAY(sva) : SetVariableControl
	STRUCT WMSetVariableAction &sva
	NVAR slayer,deltaLAY,betaLAY
	Wave/D delta,betta

	If (slayer==0)
		deltaLAY=0
		betaLAY=0
	Else
		deltaLAY=delta[slayer-1]
		betaLAY=betta[slayer-1]	
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//----------------------------------------------------------------------------------------------------------------------------------

Function FitGisaxs1D(w,x) : FitFunc
	Wave/D w
	Variable x
	Wave/D wavevector_x,wavevector_y,wavevector_z

	Return Fit_GISAXS(wavevector_x[x],wavevector_y[x],wavevector_z[x])
//	Return Fit_GISAXS(wavevector_x[x],wavevector_y[x]+1e-2,wavevector_z[x])
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function FitGisaxs2D(w,x,y) : FitFunc
	Wave/D w
	Variable x
	Variable y
	Wave/D wavevector_x2D,wavevector_y2D,wavevector_z2D

	Return Fit_GISAXS(wavevector_x2D(x)(y),wavevector_y2D(x)(y),wavevector_z2D(x)(y))
//	Return Fit_GISAXS(wavevector_x2D(x)(y),wavevector_y2D(x)(y)+1e-2,wavevector_z2D(x)(y))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function askfittingparameters(dim)
	Variable dim
	Wave/T textWave0,textWave1
	Wave coefhold
	String titletemp,setvar,cmd,chkbox
	Variable i=0
	NewPanel/M/W=(8, 2.6, 14, 18.6)	//W=(left, top, right, bottom )
	
	TitleBox title0 title="Hold ?",frame=0,pos={185,15}
	
	For (i=0;i<numpnts(coef);i+=1)
		titletemp=textwave0[i]
		setvar="setvar"+num2str(i)
		chkbox="check"+num2str(i)
		SetVariable $setvar title=titletemp,pos={20,45+35*i},size={150,20},value=coef[i],fSize=13,limits={-Inf,Inf,0},bodyWidth=60,disable=0
		Checkbox $chkbox title="",pos={190,45+35*i},value=coefhold[i],proc=procChkbox
		If (cmpstr(textWave0[i], "None")==0)
			cmd="SetVariable "+setvar+" disable=1"
			Execute cmd
			cmd="Checkbox "+chkbox+" disable=1"
			Execute cmd
			coefhold[i]=1
		Endif
	Endfor
	If (dim==1)
		Button button0 title="Fit now",size={75,25},pos={95,8},proc=executeFit1d
		Button button1 title="Plot now",size={75,25},pos={8,8},proc=executeGraph1d
	Else
		Button button0 title="Fit now",size={75,25},pos={95,8},proc=executeFit2d
		Button button1 title="Plot now",size={75,25},pos={8,8},proc=executeGraph2d
	Endif
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function procChkbox(ctrlName,checked) : CheckBoxControl
	String ctrlName
	Variable checked			// 1 if selected, 0 if not
	Wave coefhold
	
	Variable i=str2num(ctrlName[5,strlen(ctrlName)])
	coefhold[i]=checked
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function executeGraph1d(ctrlName) : ButtonControl
	String ctrlName
	Wave coef,wavevector
	Variable i
	String cmd
	NVAR cursmin,cursmax
	
	RemoveFromGraph/Z fit_scatintensity
	RemoveFromGraph/Z Res_scatintensity
	RemoveFromGraph/Z fit_peakposition

	cursmin=min(str2num(StringByKey("point", CsrInfo(A))),str2num(StringByKey("point", CsrInfo(B))))
	cursmax=max(str2num(StringByKey("point", CsrInfo(A))),str2num(StringByKey("point", CsrInfo(B))))

	If (numtype(cursmin)==2)		// si le curseur A n'existe pas sur le graph
		cursmin=0
	Endif
	If (numtype(cursmax)==2)		// si le curseur B n'existe pas sur le graph
		cursmax=numpnts(wavevector)-1
	Endif

	Duplicate/O/D/R=[cursmin,cursmax] scatintensity fit_scatintensity
	Duplicate/O/D/R=[cursmin,cursmax] wavevector fit_wavevector

	String startime
	Variable timerRatio
	Variable timerRefNum0
	Variable timerRefNum1
	Variable microSeconds

	Wavestats/Q fit_scatintensity
	timerRatio=16/V_npnts*100

	timerRefNum0 = startMSTimer
	timerRefNum1 = startMSTimer
	startime=time()
	if (timerRefNum0 == -1 || timerRefNum1 == -1)
		Abort "All timers are in use"
	endif

	If (numpnts(fit_scatintensity)>16)
		fit_scatintensity[0,15]=FitGisaxs1D(coef,x)

		microSeconds = stopMSTimer(timerRefNum0)
		Print "Run started at",startime,"---  Total time estimated:",microSeconds/1e6*100/timerRatio,"seconds"
	
		fit_scatintensity[16,numpnts(fit_scatintensity)-1]=FitGisaxs1D(coef,x)
	Else
		microSeconds = stopMSTimer(timerRefNum0)
		fit_scatintensity=FitGisaxs1D(coef,x)
	Endif

	microSeconds = stopMSTimer(timerRefNum1)
	Print "Run finished at",time(),"---  Total time elapsed:",microSeconds/1e6,"seconds"

	AppendToGraph fit_scatintensity vs fit_wavevector
	ModifyGraph lsize(fit_scatintensity)=2,rgb(fit_scatintensity)=(0,0,62720)
	Beep
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function executeFit1d(ctrlName) : ButtonControl
	String ctrlName
	Wave coefhold
	Variable i
	String cmd
	NVAR cursmin,cursmax
	
	DoWindow/K Fit1d_parameters
	
	RemoveFromGraph/Z fit_peakposition
	RemoveFromGraph/Z fit_scatintensity
	RemoveFromGraph/Z Res_scatintensity
	Killwaves/Z Res_scatintensity

	cursmin=min(str2num(StringByKey("point", CsrInfo(A))),str2num(StringByKey("point", CsrInfo(B))))
	cursmax=max(str2num(StringByKey("point", CsrInfo(A))),str2num(StringByKey("point", CsrInfo(B))))

	If (numtype(cursmin)==2)		// si le curseur A n'existe pas sur le graph
		Abort "Cursor A is not present on the graph !"
	Endif
	If (numtype(cursmax)==2)		// si le curseur B n'existe pas sur le graph
		Abort "Cursor B is not present on the graph !"
	Endif
	
	Duplicate/O/D/R=[cursmin,cursmax] wavevector fit_wavevector

	cmd="FuncFit/L="+num2str(cursmax-cursmin+1)+"/H=\""
	For (i=0;i<numpnts(coefhold);i+=1)
		cmd+=num2str(coefhold[i])
	Endfor
	cmd+="\"/NTHR=1/TBOX=0 FitGisaxs1D coef  scatintensity[pcsr(A),pcsr(B)] /D /R"
	Execute cmd
	RemoveFromGraph fit_scatintensity
	AppendToGraph fit_scatintensity vs fit_wavevector	
	ModifyGraph lsize(fit_scatintensity)=2,rgb(fit_scatintensity)=(0,0,62720)
	ModifyGraph lstyle(Res_scatintensity)=2,rgb(Res_scatintensity)=(0,0,62720)
	SetAxis/A Res_Left
	Print "Residual =",sum(Res_scatintensity)	
	Beep
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function executeGraph2d(ctrlName) : ButtonControl
	String ctrlName
	Wave coef,scatintensity2D
	NVAR Vmincol,Vmaxcol,rsmvar

	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Res_scatintensity2D,simgisaxs2D
	Duplicate/O/D scatintensity2D Res_scatintensity2D,simgisaxs2D
	
	////////////////////
	Variable npointsy=DimSize(simgisaxs2D,0)
	Variable nlines=ceil(256/npointsy)

	Wavestats/Q simgisaxs2D

	Variable timerRatio=(nlines*npointsy)/V_npnts*100
	String startime=time()
	Variable timerRefNum0=startMSTimer
	Variable timerRefNum1=startMSTimer
	Variable microSeconds
 
	if (timerRefNum0 == -1 || timerRefNum1 == -1)
		Abort "All timers are in use"
	endif

	If (V_npnts>256)
		simgisaxs2D[0,nlines-1]=FitGisaxs2D(coef,x,y)

		microSeconds = stopMSTimer(timerRefNum0)
		Print "Run started at",startime,"---  Total time estimated:",microSeconds/1e6*100/timerRatio,"seconds"

		simgisaxs2D[nlines,npointsy-1]=FitGisaxs2D(coef,x,y)
	Else
		simgisaxs2D=FitGisaxs2D(coef,x,y)
	EndIf

	microSeconds = stopMSTimer(timerRefNum1)
	Print "Run finished at",time(),"---  Total time elapsed:",microSeconds/1e6,"seconds"
	////////////////////////

	Res_scatintensity2D=scatintensity2D-simgisaxs2D
	Print "Residual =",sum(Res_scatintensity2D)	

	If (rsmvar!=1)
		Display/M/W=(9.4, 0.6, 11, 11);AppendImage Res_scatintensity2D vs {simtwothetaf,simalphaf}
		ModifyImage Res_scatintensity2D ctab= {*,*,Geo,0}
		ModifyGraph width=200, height={Plan,1,left,bottom},fSize=10,btLen=3,zero(bottom)=1
		Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
		Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
		DoWindow/C Res_gisaxs2D

		Display/M/W=(6.6, 5.3, 11, 11);AppendImage simgisaxs2D vs {simtwothetaf,simalphaf}
		ModifyImage simgisaxs2D ctab= {VminCol,VmaxCol,Geo,0}
		ModifyGraph width=200, height={Plan,1,left,bottom},fSize=10,btLen=3,zero(bottom)=1
		Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	Else
		Display/M/W=(9.4, 0.6, 11, 11);AppendImage Res_scatintensity2D vs {simtwothetaf,phif}
		ModifyImage Res_scatintensity2D ctab= {*,*,Geo,0}
		ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
		Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
		Label left "\\F'Symbol'j\\F'Arial' (deg)"
		DoWindow/C Res_gisaxs2D

		Display/M/W=(6.6, 5.3, 11, 11);AppendImage simgisaxs2D vs {simtwothetaf,phif}
		ModifyImage simgisaxs2D ctab= {*,*,Geo,0}
		ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
		Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Endif
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	DoWindow/C Fit_gisaxs2D
	Beep
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function executeFit2d(ctrlName) : ButtonControl
	String ctrlName
	Wave coefhold
	NVAR VminCol,VmaxCol,rsmvar
	Variable i
	String cmd
	
	DoWindow/K Fit2d_parameters

	DoWindow/K Res_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	DoWindow/K Sim_gisaxs2D
	Killwaves/Z Res_scatintensity2D,simgisaxs2D
	Duplicate/O/D scatintensity2D Res_scatintensity2D,simgisaxs2D

	Duplicate/O/D scatintensity2D Fit_scatintensity2D
	
	cmd="FuncFitMD/H=\""
	For (i=0;i<numpnts(coefhold);i+=1)
		cmd+=num2str(coefhold[i])
	Endfor
	cmd+="\"/NTHR=1/TBOX=0 FitGisaxs2D coef  scatintensity2D /D=Fit_scatintensity2D/R"
	Execute cmd
	
	DoWindow/C Res_gisaxs2D
	ModifyImage Res_scatintensity2D ctab= {*,*,Geo,0}
	Print "Residual =",sum(Res_scatintensity2D)	

	If (rsmvar!=1)
		Display/M/W=(6.6, 5.3, 11, 11);AppendImage Fit_scatintensity2D vs {simtwothetaf,simalphaf}
		ModifyImage Fit_scatintensity2D ctab= {VminCol,VmaxCol,Geo,0}
		ModifyGraph width=200, height={Plan,1,left,bottom},fSize=10,btLen=3,zero(bottom)=1
		Label left "\\F'Symbol'a\\F'Arial'\\Bf\\M (deg)"
	Else
		Display/M/W=(6.6, 5.3, 11, 11);AppendImage Fit_scatintensity2D vs {simtwothetaf,phif}
		ModifyImage Fit_scatintensity2D ctab= {*,*,Geo,0}
		ModifyGraph width=200, height={Aspect,1},fSize=10,btLen=3,zero(bottom)=1
		Label left "\\F'Symbol'j\\F'Arial' (deg)"
	Endif	
	Label bottom "2\\F'Symbol'q\\F'Arial'\\Bf\\M (deg)"	
	DoWindow/C Fit_gisaxs2D
	Beep
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function bessel(u)
Variable u
Return (bessJ(1,u+1e-6))/(u+1e-6)
End

//----------------------------------------------------------------------------------------------------------------------------------

Function rotz(q1,q2,q3,dxi)
	Variable q1,q2,q3,dxi
	Wave/D qprov
	qprov[0]=sqrt(q1^2+q2^2)*cos(atan(q2/q1)+dxi)
	qprov[1]=sqrt(q1^2+q2^2)*sin(atan(q2/q1)+dxi)
	qprov[2]=q3
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function roty(q1,q2,q3,dpsi)
	Variable q1,q2,q3,dpsi
	Wave/D qprov
	qprov[0]=sqrt(q1^2+q3^2)*cos(atan(q3/q1)+dpsi)
	qprov[1]=q2
	qprov[2]=sqrt(q1^2+q3^2)*sin(atan(q3/q1)+dpsi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function rotx(q1,q2,q3,dphi)
	Variable q1,q2,q3,dphi
	Wave/D qprov
	qprov[0]=q1
	qprov[1]=sqrt(q2^2+q3^2)*cos(atan(q3/q2)+dphi)
	qprov[2]=sqrt(q2^2+q3^2)*sin(atan(q3/q2)+dphi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function rotz_qx(q1,q2,q3,dxi)
	Variable q1,q2,q3,dxi
	Return sqrt(q1^2+q2^2)*cos(atan(q2/q1)+dxi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function rotz_qy(q1,q2,q3,dxi)
	Variable q1,q2,q3,dxi
	Return sqrt(q1^2+q2^2)*sin(atan(q2/q1)+dxi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function roty_qx(q1,q2,q3,dpsi)
	Variable q1,q2,q3,dpsi
	Return sqrt(q1^2+q3^2)*cos(atan(q3/q1)+dpsi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function roty_qz(q1,q2,q3,dpsi)
	Variable q1,q2,q3,dpsi
	Return sqrt(q1^2+q3^2)*sin(atan(q3/q1)+dpsi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function rotx_qy(q1,q2,q3,dphi)
	Variable q1,q2,q3,dphi
	Return sqrt(q2^2+q3^2)*cos(atan(q3/q2)+dphi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function rotx_qz(q1,q2,q3,dphi)
	Variable q1,q2,q3,dphi
	Return sqrt(q2^2+q3^2)*sin(atan(q3/q2)+dphi)
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function pangle()
	Wave coef
	Print "H=",coef[2]*coef[6],"nm, beta=",atan(2*coef[6]/(1-coef[15]))*180/pi,"deg, gamma=",atan(2*coef[6]/(1+coef[15]))*180/pi,"deg, Xi =",(coef[2]*coef[4])^3/2/coef[5]^2,"nm"
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------

Function pvcoreshell()
	Wave coef
	Print "Vcore =",4/3*pi*(coef[2]/2)^3,"nm3, Vshell =",4/3*pi*(coef[2]/2+coef[15])^3-4/3*pi*(coef[2]/2)^3,"nm3, Vcore/Vtot =",(coef[2]/2)^3/(coef[2]/2+coef[15])^3,"Vshell/Vtot =",((coef[2]/2+coef[15])^3-(coef[2]/2)^3)/(coef[2]/2+coef[15])^3
End

//---------------------------------------------------------------------------------------------------------------------------------------------------------------



#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function CreateNewGISAXS2D(MapType)
	String MapType

	Variable qxval=NumVarOrDefault("qx_val",0)
	Variable qyval=NumVarOrDefault("qy_val",0)
	Variable qzval=NumVarOrDefault("qz_val",0)
	Variable qymin=NumVarOrDefault("qy_min",-2.5)
	Variable qymax=NumVarOrDefault("qy_max",2.5)
	Variable qzmin=NumVarOrDefault("qz_min",0)
	Variable qzmax=NumVarOrDefault("qz_max",2.5)
	Variable 	alphai=NumVarOrDefault("alphai_detec",0.3)
	Variable 	phi=NumVarOrDefault("phi_detec",0)
	Variable deltaq=NumVarOrDefault("delta_q",0.02)

	Prompt alphai,"Incidence angle (°):"
	If (CmpStr(MapType,"QyQz_map")==0)
		Prompt phi,"Azimuthal angle (°):"
		Prompt qymin,"qy min (1/nm):"
		Prompt qymax,"qy max (1/nm):"
		Prompt qzmin,"qz min (1/nm):"
		Prompt qzmax,"qz max (1/nm):"
		Prompt qxval,"qx (1/nm):"
		Prompt deltaq,"Delta q (1/nm):"
		DoPrompt "Enter parameters", alphai, phi, qymin, qymax, qzmin, qzmax, qxval, deltaq
//	ElseIf (CmpStr(MapType,"QxQz_map")==0)
//		Prompt phi,"Azimuthal angle (°):"
//		Prompt qymin,"qx min (1/nm):"
//		Prompt qymax,"qx max (1/nm):"
//		Prompt qzmin,"qz min (1/nm):"
//		Prompt qzmax,"qz max (1/nm):"
//		Prompt qyval,"qy (1/nm):"
//		Prompt deltaq,"Delta q (1/nm):"
//		DoPrompt "Enter parameters", alphai, phi, qymin, qymax, qzmin, qzmax, qyval, deltaq
	Elseif (CmpStr(MapType,"QxQy_map")==0)
		Prompt phi,"Azimuthal angle (°):"
		Prompt qymin,"qy min (1/nm):"
		Prompt qymax,"qy max (1/nm):"
		Prompt qzmin,"qx min (1/nm):"
		Prompt qzmax,"qx max (1/nm):"
		Prompt qzval,"qz (1/nm):"
		Prompt deltaq,"Delta q (1/nm):"
		DoPrompt "Enter parameters", alphai, phi, qymin, qymax, qzmin, qzmax, qzval, deltaq
	Else
		Prompt phi,"Delta phi (°):"
		Prompt qymin,"qy min (1/nm):"
		Prompt qymax,"qy max (1/nm):"
		Prompt qzmin,"phi min (1/nm):"
		Prompt qzmax,"phi max (1/nm):"
		Prompt qzval,"qz (1/nm):"
		Prompt deltaq,"Delta q (1/nm):"
		DoPrompt "Enter parameters", alphai, phi, qymin, qymax, qzmin, qzmax, qzval, deltaq
	EndIf	

	Variable/G qx_val=qxval
	Variable/G qy_val=qyval
	Variable/G qz_val=qzval
	Variable/G qy_min=qymin
	Variable/G qy_max=qymax
	Variable/G qz_min=qzmin
	Variable/G qz_max=qzmax
	Variable/G alphai_detec=alphai
	Variable/G phi_detec=phi
	Variable/G delta_q=deltaq

	DoWindow/K Sim_gisaxs2D
	DoWindow/K Fit_gisaxs2D
	Killwaves/Z simgisaxs2D
	
	Variable npointsy, npointsz
	
	If (CmpStr(MapType,"QyQz_map")==0 || CmpStr(MapType,"QxQz_map")==0 || CmpStr(MapType,"QxQy_map")==0)
		npointsy=ceil((qy_max-qy_min)/deltaq)+1
		npointsz=ceil((qz_max-qz_min)/deltaq)+1
		Make/N=(npointsy,npointsz)/D/O simgisaxs2D
		SetScale/P x qy_min,deltaq,"", simgisaxs2D
		SetScale/P y qz_min,deltaq,"", simgisaxs2D
		Print "Image size =",DimSize(simgisaxs2D,0),"x",DimSize(simgisaxs2D,1),"(resolution =",deltaq,"1/nm)"
		Print "Incidence angle =",alphai_detec,"deg, Azimuthal angle =",phi_detec,"deg"
	Else
		npointsy=ceil((qy_max-qy_min)/deltaq)+1
		npointsz=ceil((qz_max-qz_min)/phi)+1
		Make/N=(npointsy,npointsz)/D/O simgisaxs2D
		SetScale/P x qy_min,deltaq,"", simgisaxs2D
		SetScale/P y qz_min,phi,"", simgisaxs2D
		Print "Image size =",DimSize(simgisaxs2D,0),"x",DimSize(simgisaxs2D,1),"(resolution =",deltaq,"1/nm)"
		Print "Incidence angle =",alphai_detec,"deg, dPhi =",phi_detec,"deg"
	Endif
	

	////////////////////
	String startime
	Variable timerRatio
	Variable timerRefNum0
	Variable timerRefNum1
	Variable microSeconds
	Variable nlines=ceil(256/npointsy)

	Duplicate/O simgisaxs2d qx2d,qy2d,qz2d
	Wavestats/Q simgisaxs2D
	timerRatio=(nlines*npointsy)/V_npnts*100

	If (CmpStr(MapType,"QyQz_map")==0)
		qx2d=qx_val*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
		qy2d=-qx_val*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
		qz2d=y
//	ElseIf (CmpStr(MapType,"QxQz_map")==0)
//		qx2d=x*cos(phi_detec*pi/180)+qy_val*sin(phi_detec*pi/180)
//		qy2d=-x*sin(phi_detec*pi/180)+qy_val*cos(phi_detec*pi/180)
//		qz2d=y
	ElseIf (CmpStr(MapType,"QxQy_map")==0)
		qx2d=y*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
		qy2d=-y*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
		qz2d=qz_val
	Else
		qx2d=x*sin(y*pi/180)
		qy2d=x*cos(y*pi/180)
		qz2d=qz_val
		phi_detec=0
	EndIf	

	timerRefNum0 = startMSTimer
	timerRefNum1 = startMSTimer
	startime=time()
	if (timerRefNum0 == -1 || timerRefNum1 == -1)
		Abort "All timers are in use"
	endif

	If (V_npnts>256)
		simgisaxs2D[0,nlines-1]=Fit_GISAXS(qx2d[p][q],qy2d[p][q],qz2d[p][q])

		microSeconds = stopMSTimer(timerRefNum0)
		Print "Run started at",startime,"---  Total time estimated:",microSeconds/1e6*100/timerRatio,"seconds"

		simgisaxs2D[nlines,npointsy-1]=Fit_GISAXS(qx2d[p][q],qy2d[p][q],qz2d[p][q])
	Else
		microSeconds = stopMSTimer(timerRefNum0)
		simgisaxs2D=Fit_GISAXS(qx2d,qy2d,qz2d)
	EndIf

	microSeconds = stopMSTimer(timerRefNum1)
	Print "Run finished at",time(),"---  Total time elapsed:",microSeconds/1e6,"seconds"
	Killwaves qx2d,qy2d,qz2d
	////////////////////////

	Display/M/W=(0.2, 5.3, 11, 11);AppendImage simgisaxs2D
	ControlBar 30
	Button button0, size={60,20}, pos={200,5}, title="Update",fsize=11
	Button button6, size={60,20}, pos={400,5}, proc=ButtonProc_logscale, title="Log. scale",fsize=11
	Button button66, size={60,20}, pos={320,5}, proc=ButtonProc_linscale, title="Lin. scale",fsize=11,disable=2
	ModifyImage simgisaxs2D ctab= {*,*,Geo,0}
	If (CmpStr(MapType,"QyQz_map")==0)
		Label bottom "q\\By\\M (nm\\S-1\\M)"
		Label left "q\\Bz\\M (nm\\S-1\\M)"
		Button button0, proc=ButtonProc_newQyQz
		SetVariable setvar2 title="qx (nm)",pos={15,5},size={100,18},value=qx_val,limits={-inf,inf,0.1}
		ModifyGraph fSize=14,width=226.772,height={Plan,1,left,bottom},btLen=5,zero=1
//	ElseIf (CmpStr(MapType,"QxQz_map")==0)
//		Label bottom "q\\Bx\\M (nm\\S-1\\M)"
//		Label left "q\\Bz\\M (nm\\S-1\\M)"
//		Button button0, proc=ButtonProc_newQxQz
//		SetVariable setvar2 title="qy (nm)",pos={15,5},size={100,18},value=qy_val,limits={-inf,inf,0.1}
//		ModifyGraph fSize=14,width=226.772,height={Plan,1,left,bottom},btLen=5,zero=1
	ElseIf (CmpStr(MapType,"QxQy_map")==0)
		Label bottom "q\\By\\M (nm\\S-1\\M)"
		Label left "q\\Bx\\M (nm\\S-1\\M)"
		Button button0, proc=ButtonProc_newQxQy
		SetVariable setvar2 title="qz (nm)",pos={15,5},size={100,18},value=qz_val,limits={-inf,inf,0.1}
		ModifyGraph fSize=14,width=226.772,height={Plan,1,left,bottom},btLen=5,zero=1
	Else
		Label bottom "q\\By\\M (nm\\S-1\\M)"
		Label left "\\F'Symbol'j\\F'Arial' (deg)"
		Button button0, proc=ButtonProc_newQyPhi
		SetVariable setvar2 title="qz (nm)",pos={15,5},size={100,18},value=qz_val,limits={-inf,inf,0.1}
		ModifyGraph fSize=14,width=226.772,height={Aspect,1},btLen=5,zero=1
	EndIf	
	SetAxis/A
	ColorScale/C/N=text0/X=0.00/Y=4.00/F=0/A=RC/E image=simgisaxs2D,heightPct=100,width=10,lblMargin=-5,tickLen=5.00,fsize=14,prescaleExp=0,"Intensity (arb. units)"
	ShowInfo
	DoWindow/C Sim_gisaxs2D
	
	Variable/G Vmincol=V_min
	Variable/G Vmaxcol=V_max

End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_newQyQz(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs2D,qx2d,qy2d,qz2d
	NVAR qx_val,phi_detec
	
	Duplicate/O simgisaxs2d qx2d,qy2d,qz2d

	qx2d=qx_val*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
	qy2d=-qx_val*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
	qz2d=y

	simgisaxs2D=Fit_GISAXS(qx2d,qy2d,qz2d)

	Killwaves qx2d,qy2d,qz2d
	ColorScale/C/N=text0 "Intensity (arb. units)"
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

//Function ButtonProc_newQxQz(ctrlName) : ButtonControl
//	String ctrlName
//	Wave/D simgisaxs2D,qx2d,qy2d,qz2d
//	NVAR qy_val,phi_detec
//	
//	Duplicate/O simgisaxs2d qx2d,qy2d,qz2d
//
//	qx2d=x*cos(phi_detec*pi/180)+qy_val*sin(phi_detec*pi/180)
//	qy2d=-x*sin(phi_detec*pi/180)+qy_val*cos(phi_detec*pi/180)
//	qz2d=y
//
//	simgisaxs2D=Fit_GISAXS(qx2d,qy2d,qz2d)
//
//	Killwaves qx2d,qy2d,qz2d
//	Button button6 disable=0
//	ColorScale/C/N=text0 "Intensity (arb. units)"
//End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_newQxQy(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs2D,qx2d,qy2d,qz2d
	NVAR qz_val,phi_detec
	
	Duplicate/O simgisaxs2d qx2d,qy2d,qz2d

	qx2d=y*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
	qy2d=-y*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
	qz2d=qz_val

	simgisaxs2D=Fit_GISAXS(qx2d,qy2d,qz2d)

	Killwaves qx2d,qy2d,qz2d
	ColorScale/C/N=text0 "Intensity (arb. units)"
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_newQyPhi(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs2D,qx2d,qy2d,qz2d
	NVAR qz_val
	
	Duplicate/O simgisaxs2d qx2d,qy2d,qz2d

	qx2d=x*sin(y*pi/180)
	qy2d=x*cos(y*pi/180)
	qz2d=qz_val

	simgisaxs2D=Fit_GISAXS(qx2d,qy2d,qz2d)

	Killwaves qx2d,qy2d,qz2d
	ColorScale/C/N=text0 "Intensity (arb. units)"
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
//°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function CreateNewGISAXS1D(CutType)
	String CutType
	Variable qxval=NumVarOrDefault("qx_val",0)
	Variable qyval=NumVarOrDefault("qy_val",0)
	Variable qzval=NumVarOrDefault("qz_val",0)
	Variable qymin=NumVarOrDefault("qy_min",-2.5)
	Variable qymax=NumVarOrDefault("qy_max",2.5)
	Variable qzmin=NumVarOrDefault("qz_min",0)
	Variable qzmax=NumVarOrDefault("qz_max",2.5)
	Variable 	alphai=NumVarOrDefault("alphai_detec",0.3)
	Variable 	phi=NumVarOrDefault("phi_detec",0)
	Variable deltaq=NumVarOrDefault("delta_q",0.02)

	Prompt alphai,"Incidence angle (°):"
	Prompt phi,"Azimuthal angle (°):"
	If (CmpStr(CutType,"Qy_cut")==0)
		Prompt qymin,"qy min (1/nm):"
		Prompt qymax,"qy max (1/nm):"
		Prompt qzval,"qz (1/nm):"
		Prompt qxval,"qx (1/nm)"
		Prompt deltaq,"Delta q (1/nm):"
		DoPrompt "Enter parameters", alphai, phi, qymin, qymax, qzval, qxval, deltaq
	ElseIf (CmpStr(CutType,"Qz_cut")==0)
		Prompt qzmin,"qz min (1/nm):"
		Prompt qzmax,"qz max (1/nm):"
		Prompt qyval,"qy (1/nm):"
		Prompt qxval,"qx (1/nm)"
		Prompt deltaq,"Delta q (1/nm):"
		DoPrompt "Enter parameters", alphai, phi, qzmin, qzmax, qyval, qxval, deltaq
	EndIf	

	Variable/G qx_val=qxval
	Variable/G qy_val=qyval
	Variable/G qz_val=qzval
	Variable/G qy_min=qymin
	Variable/G qy_max=qymax
	Variable/G qz_min=qzmin
	Variable/G qz_max=qzmax
	Variable/G alphai_detec=alphai
	Variable/G phi_detec=phi
	Variable/G delta_q=deltaq

	DoWindow/K Sim_gisaxs1D
	Killwaves/Z simgisaxs1D
	
	Variable npointsy, npointsz
	String startime
	Variable timerRatio
	Variable timerRefNum0
	Variable timerRefNum1
	Variable microSeconds
	
	If (CmpStr(CutType,"Qy_cut")==0)
		npointsy=ceil((qy_max-qy_min)/deltaq)+1
		Make/N=(npointsy)/D/O simgisaxs1D
		SetScale/P x qy_min,deltaq,"", simgisaxs1D
		Print "Incidence angle =",alphai_detec,"deg, Azimuthal angle =",phi_detec,"deg"
	ElseIf (CmpStr(CutType,"Qz_cut")==0)
		npointsz=ceil((qz_max-qz_min)/deltaq)+1
		Make/N=(npointsz)/D/O simgisaxs1D
		SetScale/P x qz_min,deltaq,"", simgisaxs1D
		Print "Incidence angle =",alphai_detec,"deg, Azimuthal angle =",phi_detec,"deg"
	EndIf	

	////////////////////
	Duplicate/O simgisaxs1d qx1d,qy1d,qz1d
	Wavestats/Q simgisaxs1D
	timerRatio=16/V_npnts*100
	
	If (CmpStr(CutType,"Qy_cut")==0)
		qx1d=qx_val*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
		qy1d=-qx_val*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
		qz1d=qz_val
	Elseif (CmpStr(CutType,"Qz_cut")==0)
		qx1d=qx_val*cos(phi_detec*pi/180)+qy_val*sin(phi_detec*pi/180)
		qy1d=-qx_val*sin(phi_detec*pi/180)+qy_val*cos(phi_detec*pi/180)
		qz1d=x
	EndIf	

	timerRefNum0 = startMSTimer
	timerRefNum1 = startMSTimer
	startime=time()
	if (timerRefNum0 == -1 || timerRefNum1 == -1)
		Abort "All timers are in use"
	endif

	If (numpnts(simgisaxs1d)>16)
		simgisaxs1D[0,15]=Fit_GISAXS(qx1d[p],qy1d[p],qz1d[p])

		microSeconds = stopMSTimer(timerRefNum0)
		Print "Run started at",startime,"---  Total time estimated:",microSeconds/1e6*100/timerRatio,"seconds"
	
		simgisaxs1D[16,numpnts(simgisaxs1D)-1]=Fit_GISAXS(qx1d[p],qy1d[p],qz1d[p])
	Else
		microSeconds = stopMSTimer(timerRefNum0)
		simgisaxs1D=Fit_GISAXS(qx1d,qy1d,qz1d)
	Endif

	microSeconds = stopMSTimer(timerRefNum1)
	Print "Run finished at",time(),"---  Total time elapsed:",microSeconds/1e6,"seconds"
	Killwaves qx1d,qy1d,qz1d
	////////////////////////

	Display/M/W=(0.2, 5.3, 13.2, 12.3) simgisaxs1d	// /W=(left, top, right, bottom )
	ModifyGraph mirror=2, btLen=5, fSize=14, lsize=1.5, zero(bottom)=1
	SetAxis/A/E=1 left
	SetAxis/A/E=0 bottom
	DoWindow/C Sim_gisaxs1D
	ControlBar 30
	Button button0, size={60,20}, pos={215,5}, title="Update",fsize=11
	Button intens0 title="Guinier", proc=ButtonProc_simguinierplot, pos={310,5}, size={60,20},fsize=11
	Button intens21 title="Lin. scale", proc=ButtonProc_linscale1d, pos={400,5}, size={60,20},fsize=11, disable=1
	Button intens22 title="Log. scale", proc=ButtonProc_logscale1d, pos={400,5}, size={60,20},fsize=11
	If (CmpStr(CutType,"Qy_cut")==0)
		Label left "I(q\\By\\M) (arb. units)"
		Label bottom "q\\By\\M (nm\\S-1\\M)"
		SetVariable setvar2 title="qx (nm)",pos={10,5},size={85,18},value=qx_val,limits={-inf,inf,0.1}
		SetVariable setvar3 title="qz (nm)",pos={105,5},size={85,18},value=qz_val,limits={-inf,inf,0.1}
		Button button0, proc=ButtonProc_newQycut
	Elseif (CmpStr(CutType,"Qz_cut")==0)
		Label left "I(q\\Bz\\M) (arb. units)"
		Label bottom "q\\Bz\\M (nm\\S-1\\M)"
		SetVariable setvar2 title="qx (nm)",pos={10,5},size={85,18},value=qx_val,limits={-inf,inf,0.1}
		SetVariable setvar3 title="qy (nm)",pos={105,5},size={85,18},value=qy_val,limits={-inf,inf,0.1}
		Button button0, proc=ButtonProc_newQzcut
	EndIf	

End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_newQycut(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs1D,qx1d,qy1d,qz1d
	NVAR qx_val,qz_val,phi_detec

	RemoveFromGraph/Z simgisaxs1dold	
	Duplicate/O simgisaxs1d qx1d,qy1d,qz1d,simgisaxs1dold
	AppendToGraph simgisaxs1dold
	ModifyGraph rgb(simgisaxs1dold)=(0,52224,26368)
	
	qx1d=qx_val*cos(phi_detec*pi/180)+x*sin(phi_detec*pi/180)
	qy1d=-qx_val*sin(phi_detec*pi/180)+x*cos(phi_detec*pi/180)
	qz1d=qz_val

	simgisaxs1D=Fit_GISAXS(qx1d,qy1d,qz1d)

	Killwaves qx1d,qy1d,qz1d
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_newQzcut(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs1D,qx1d,qy1d,qz1d
	NVAR qx_val,qy_val,phi_detec
	
	RemoveFromGraph/Z simgisaxs1dold	
	Duplicate/O simgisaxs1d qx1d,qy1d,qz1d,simgisaxs1dold
	AppendToGraph simgisaxs1dold
	ModifyGraph rgb(simgisaxs1dold)=(0,52224,26368)

	qx1d=qx_val*cos(phi_detec*pi/180)+qy_val*sin(phi_detec*pi/180)
	qy1d=-qx_val*sin(phi_detec*pi/180)+qy_val*cos(phi_detec*pi/180)
	qz1d=x

	simgisaxs1D=Fit_GISAXS(qx1d,qy1d,qz1d)

	Killwaves qx1d,qy1d,qz1d
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Function ButtonProc_simguinierplot(ctrlName) : ButtonControl
	String ctrlName
	Wave/D simgisaxs1D
	DoWindow/K Guinier_plot
	Duplicate/O/D simgisaxs1D wavevector2,logscatintensity
	wavevector2=x^2
	logscatintensity=Ln(simgisaxs1D)
	Display/W=(480, 298, 880, 528) logscatintensity vs wavevector2
	ModifyGraph mirror=2, btLen=5, fSize=14, zero(bottom)=1
	Label bottom "q\\S2\\M (nm\\S-2\\M)"
	Label left "Ln I(q) (arb. units)"
	ShowInfo
	ControlBar 30
	Button guinier0 title="Diameter", proc=ButtonProc_guinierslope, pos={10,5}, size={60,20},fsize=11
	Button guinier1 title="Differentiate", proc=ButtonProc_differentiate, pos={80,5}, size={75,20},fsize=11
	Button guinier2 title="Autoscale", proc=ButtonProc_autoscale, pos={165,5}, size={60,20},fsize=11
	DoWindow/C Guinier_plot
End

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// Born Approximation
	Variable q_x,q_y,q_z,D_y,D_z

	Return magsqr(Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)	// Born Approximation
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Wave/D delta,betta
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Variable/C formfactorcmplx
		
	formfactorcmplx=Form_factor(q_x,q_y,q_z,D_y,D_z)

	Variable bool=(sign(alphafdetec)+1)/2
	Return (2*pi/long_onde)^2/(4*pi)*((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*formfactorcmplx*bool
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Buried layer
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness
	Variable/C k_i,k_f,formfactorcmplx
		
	k_i=-2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphafdetec*pi/180))^2)

	Variable z0=(1/calcul_profpen(alphai_detec,delta[slayer-1],betta[slayer-1])+1/calcul_profpen(alphafdetec,delta[slayer-1],betta[slayer-1]))^(-1)
	Variable z1=(sum(thickness,0,slayer-2)+sign(slayer-2)*sum(thickness,0,slayer-2))/2	// z1=0 if slayer-2<0 and z1=z1 if slayer-2>=0
	Variable z2=sum(thickness,0,slayer-1)
	Variable t0=Calcul_transmission(alphai_detec,delta[slayer-1],betta[slayer-1])*Calcul_transmission(alphafdetec,delta[slayer-1],betta[slayer-1])

	formfactorcmplx=Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)

	Return (2*pi/long_onde)^4/(16*pi)^2*magsqr((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*t0*z0/thickness[slayer-1]*(exp(-z1/z0)-exp(-z2/z0))*magsqr(formfactorcmplx)*(sign(alphafdetec)+1)/2
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)
	Variable q_x,q_y,q_z,D_y,D_z

	Return 1
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Correlated roughness
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness,coef
	Variable/C formfactorcmplx,k_i,k_f,formfactorcmplx1,formfactorcmplx2
	
	k_i=-2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphafdetec*pi/180))^2)

	formfactorcmplx1=champincidentmoins(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)
	formfactorcmplx1+=champincidentplus(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	formfactorcmplx1+=champincidentmoins(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx1+=champincidentplus(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

	formfactorcmplx1=(2*pi/long_onde)^2/(4*pi)*((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*formfactorcmplx1	
	
	k_i=	-2*pi/long_onde*sqrt((1)^2-(cos(alphai_detec*pi/180))^2)
	k_f=	2*pi/long_onde*sqrt((1)^2-(cos(alphafdetec*pi/180))^2)

	formfactorcmplx2=Form_factor(q_x,q_y,k_f-k_i,D_y*coef[12],D_z*coef[13])		
	formfactorcmplx2+=calcul_reflecto(alphai_detec)*Form_factor(q_x,q_y,k_f+k_i,D_y*coef[12],D_z*coef[13])
	formfactorcmplx2+=calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y*coef[12],D_z*coef[13])
	formfactorcmplx2+=calcul_reflecto(alphai_detec)*calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y*coef[12],D_z*coef[13])

//	formfactorcmplx2=(2*pi/long_onde)^2/(4*pi)*((1-delta[0]-sqrt(-1)*betta[0])^2-(1-delta[0]/2-sqrt(-1)*betta[0]/2)^2)*formfactorcmplx2
	formfactorcmplx2=(2*pi/long_onde)^2/(4*pi)*((1-delta[0]-sqrt(-1)*betta[0])^2-(1)^2)*formfactorcmplx2

	Variable bool=(sign(alphafdetec)+1)/2
	Return (magsqr(formfactorcmplx1)+magsqr(formfactorcmplx2)+2*sqrt(magsqr(formfactorcmplx1))*sqrt(magsqr(formfactorcmplx2))*cos(q_z*sum(thickness,0,slayer-2)))*bool
//	Return (magsqr(formfactorcmplx1)+magsqr(formfactorcmplx2)+2*sqrt(magsqr(formfactorcmplx1))*sqrt(magsqr(formfactorcmplx2))*cos(-q_y*coef[2]*coef[4]/4+q_z*sum(thickness,0,slayer-2)))*bool
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)
	Variable q_x,q_y,q_z,D_y,D_z

	Return 1
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Holes layer
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness
	Variable/C formfactorcmplx,k_i,k_f,formfactorcmplx1,formfactorcmplx2
	
	//k_i=-2*pi/long_onde*sqrt((1-delta[slayer-1]-sqrt(-1)*betta[slayer-1])^2-(cos(alphai_detec*pi/180))^2)
	k_i=-2*pi/long_onde*sqrt((1)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-delta[slayer-1]-sqrt(-1)*betta[slayer-1])^2-(cos(alphafdetec*pi/180))^2)
	

	formfactorcmplx=champincidentmoins(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)
	formfactorcmplx+=champincidentplus(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	formfactorcmplx+=champincidentmoins(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx+=champincidentplus(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

	Return magsqr(formfactorcmplx)*(sign(alphafdetec)+1)/2

	//formfactorcmplx1=champincidentmoins(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)
	//formfactorcmplx1+=champincidentplus(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	//formfactorcmplx1+=champincidentmoins(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	//formfactorcmplx1+=champincidentplus(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

//		formfactorcmplx1=formfactorcmplx1*((1-1.094E-05-sqrt(-1)*1.565E-07)^2-(1-2.979e-5-sqrt(-1)*2.721e-6)^2)//			AS
//	formfactorcmplx1=formfactorcmplx1*((1-1.998E-05-sqrt(-1)*1.823E-06)^2-(1-2.979e-5-sqrt(-1)*2.721e-6)^2)//			AS
	//	formfactorcmplx1=formfactorcmplx1*((1-6.653E-06-sqrt(-1)*6.369E-08)^2-(1-1.9001E-05-sqrt(-1)*1.1833E-06)^2)//			SAS
	
//	wave/d coef
//	variable xi=coef[8]
//	k_i=	-2*pi/long_onde*sqrt((1)^2-(cos(alphai_detec*pi/180))^2)
//	k_f=	2*pi/long_onde*sqrt((1)^2-(cos(alphafdetec*pi/180))^2)
//	formfactorcmplx2=Form_factor(q_x,q_y,k_f-k_i,D_y,D_z*xi)		
//	formfactorcmplx2+=calcul_reflecto(alphai_detec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z*xi)
//	formfactorcmplx2+=calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z*xi)
//	formfactorcmplx2+=calcul_reflecto(alphai_detec)*calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z*xi)

//		formfactorcmplx2=formfactorcmplx2*((1-3.554E-06-sqrt(-1)*5.33E-08)^2-(1-1.065e-5-sqrt(-1)*1.598e-7)^2)//			AS
//	formfactorcmplx2=formfactorcmplx2*((1-5.326E-06-sqrt(-1)*7.99E-08)^2-(1-1.065e-5-sqrt(-1)*1.598e-7)^2)//			AS
	//	formfactorcmplx2=formfactorcmplx2*((1-2.147E-06-sqrt(-1)*2.097E-08)^2-(1-6.442e-6-sqrt(-1)*6.29e-8)^2)/2//			SAS
	
//	Return magsqr(formfactorcmplx1)+magsqr(formfactorcmplx2)+2*real(r2polar(formfactorcmplx1))*real(r2polar(formfactorcmplx2))*cos(q_z*sum(thickness,0,slayer-1))
//	Return magsqr(formfactorcmplx1)+magsqr(formfactorcmplx2)//+2*real(r2polar(formfactorcmplx1))*real(r2polar(formfactorcmplx2))*cos(q_z*thickness[0])
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Sandwiched islands
	Variable q_x,q_y,q_z,D_y,D_z

	Return magsqr(Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)	// DWBA Sandwiched islands
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness
	Variable/C formfactorcmplx,k_i,k_f
	
	k_i=-2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphafdetec*pi/180))^2)

	formfactorcmplx=champincidentmoins(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)
	formfactorcmplx+=champincidentplus(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	formfactorcmplx+=champincidentmoins(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx+=champincidentplus(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

	Variable bool=(sign(alphafdetec)+1)/2
	Return (2*pi/long_onde)^2/(4*pi)*((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*formfactorcmplx*bool
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Sandwiched layer
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness
	Variable/C k_i,k_f,formfactorcmplx
		
	k_i=-2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphafdetec*pi/180))^2)

	Variable z0=(1/calcul_profpen(alphai_detec,delta[slayer-1],betta[slayer-1])+1/calcul_profpen(alphafdetec,delta[slayer-1],betta[slayer-1]))^(-1)
	Variable y0=(1/calcul_profpen(alphai_detec,delta[slayer-1],betta[slayer-1])-1/calcul_profpen(alphafdetec,delta[slayer-1],betta[slayer-1]))^(-1)
	Variable/C formfactorcmplx1,formfactorcmplx2,formfactorcmplx3,formfactorcmplx4
	Variable formfactor1,formfactor2,formfactor3,formfactor4
	
	formfactorcmplx1=champincidentmoins(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)
	formfactorcmplx2=champincidentplus(alphai_detec)*champincidentmoins(alphafdetec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	formfactorcmplx3=champincidentmoins(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx4=champincidentplus(alphai_detec)*champincidentplus(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

	formfactor1=magsqr(formfactorcmplx1)*z0/thickness[slayer-1]*(exp(thickness[slayer-1]/z0)-1)
	formfactor2=magsqr(formfactorcmplx2)*y0/thickness[slayer-1]*(1-exp(-thickness[slayer-1]/y0))
	formfactor3=magsqr(formfactorcmplx3)*y0/thickness[slayer-1]*(exp(thickness[slayer-1]/y0)-1)
	formfactor4=magsqr(formfactorcmplx4)*z0/thickness[slayer-1]*(1-exp(-thickness[slayer-1]/z0))

	Return (2*pi/long_onde)^4/(16*pi)^2*magsqr((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*(formfactor1+formfactor2+formfactor3+formfactor4)*(sign(alphafdetec)+1)/2
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)
	Variable q_x,q_y,q_z,D_y,D_z

	Return 1
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Supported islands
	Variable q_x,q_y,q_z,D_y,D_z

	Return magsqr(Form_factor_Amplitude(q_x,q_y,q_z,D_y,D_z))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_Amplitude(q_x,q_y,q_z,D_y,D_z)	// DWBA Supported islands
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,deltaNPs,betaNPs
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Variable/C formfactorcmplx,k_i,k_f
	
	k_i=	-2*pi/long_onde*sqrt((1)^2-(cos(alphai_detec*pi/180))^2)
	k_f=	2*pi/long_onde*sqrt((1)^2-(cos(alphafdetec*pi/180))^2)
	
	formfactorcmplx=Form_factor(q_x,q_y,k_f-k_i,D_y,D_z)		
	formfactorcmplx+=calcul_reflecto(alphai_detec)*Form_factor(q_x,q_y,k_f+k_i,D_y,D_z)
	formfactorcmplx+=calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx+=calcul_reflecto(alphai_detec)*calcul_reflecto(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)

	Variable bool=(sign(alphafdetec)+1)/2
	Return (2*pi/long_onde)^2/(4*pi)*((1-deltaNPs-sqrt(-1)*betaNPs)^2-1)*formfactorcmplx*bool
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Form_factor2(q_x,q_y,q_z,D_y,D_z)	// DWBA Surface holes
	Variable q_x,q_y,q_z,D_y,D_z

	Return magsqr(Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor_amplitude(q_x,q_y,q_z,D_y,D_z)	// DWBA Surface holes
	Variable q_x,q_y,q_z,D_y,D_z
	NVAR long_onde,alphai_detec,slayer,deltaNPs,betaNPs,deltaLAY,betaLAY
	Variable alphafdetec=asin(long_onde/2/pi*q_z-sin(alphai_detec*pi/180))*180/pi
	Wave/D delta,betta,thickness
	Variable/C formfactorcmplx,k_i,k_f
	
	k_i=-2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphai_detec*pi/180))^2)
	k_f=2*pi/long_onde*sqrt((1-deltaLAY-sqrt(-1)*betaLAY)^2-(cos(alphafdetec*pi/180))^2)

slayer-=1
	formfactorcmplx=champincidentmoinsdown(alphai_detec)*champincidentmoinsdown(alphafdetec)*Form_factor(q_x,q_y,-k_f+k_i,D_y,D_z)
	formfactorcmplx+=champincidentplusdown(alphai_detec)*champincidentmoinsdown(alphafdetec)*Form_factor(q_x,q_y,-k_f-k_i,D_y,D_z)
	formfactorcmplx+=champincidentmoinsdown(alphai_detec)*champincidentplusdown(alphafdetec)*Form_factor(q_x,q_y,+k_f+k_i,D_y,D_z)
	formfactorcmplx+=champincidentplusdown(alphai_detec)*champincidentplusdown(alphafdetec)*Form_factor(q_x,q_y,+k_f-k_i,D_y,D_z)
slayer+=1

	Variable bool=(sign(alphafdetec)+1)/2
	Return (2*pi/long_onde)^2/(4*pi)*((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)*formfactorcmplx*bool
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// Anisotropic pyramid (asymmetric sawtooth profile)
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ
	Wave/D coef
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	
	sizeX=coef[14]//*D_y
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable/C result
	Wave/D coef

	Variable anisotropy=coef[15]
	result=sizeX*(1-inZ/sizeZ)*sinc(vectQx_cmplx*sizeX/2*(1-inZ/sizeZ))*sizeY*(1-inZ/sizeZ)*sinc(vectQy_cmplx*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQy_cmplx*anisotropy*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQz_cmplx*inZ)


	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// capsule {diameter D_y, height D_z}	D_z > D_y
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR sizeY,sizeZ,psi_detec
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=(Integrate1D(complexFormFactorFunction,0,D_y/2,2)+2*pi*(D_y/2)^2*(D_z-D_y)*bessel(sqrt(q_x^2+q_y^2)*D_y/2)*sinc(q_z*(D_z-D_y)/2))*exp(sqrt(-1)*q_z*D_z/2)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeY,sizeZ
	Variable/C result
	result=4*pi*((sizeY/2)^2-inZ^2)*bessel(sqrt(vectQx_cmplx^2+vectQy_cmplx^2)*sqrt((sizeY/2)^2-inZ^2))*cos(vectQz_cmplx*(inZ+sizeZ/2-sizeY/2))
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)		// Core-shell cylinder {core diameter D_y, core height D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	Wave/D coef
	NVAR psi_detec,deltaLAY,betaLAY,deltaNPs,betaNPs,deltaNPc,betaNPc

	Variable/C formfactorcmplx
	Variable/C tau=((1-deltaNPc-sqrt(-1)*betaNPc)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)/((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)

	formfactorcmplx=(1-tau)*2*pi*(D_y/2)^2*D_z*bessel(sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*D_y/2)*sinc((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*D_z/2)*exp(sqrt(-1)*q_z*(D_z/2*cos(psi_detec*pi/180)+D_y/2*sqrt((sin(psi_detec*pi/180))^2)))
	formfactorcmplx+=tau*2*pi*(D_y/2+coef[8])^2*(D_z+coef[8])*bessel(sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*(D_y/2+coef[8]))*sinc((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*(D_z+coef[8])/2)*exp(sqrt(-1)*q_z*((D_z+coef[8])/2*cos(psi_detec*pi/180)+(D_y/2+coef[8])*sqrt((sin(psi_detec*pi/180))^2)))

	Return formfactorcmplx
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// Core-shell hemispheroid {core diameter D_y, core height D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z 
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeY,sizeZ,psi_detec,deltaLAY,betaLAY,deltaNPs,betaNPs,deltaNPc,betaNPc
	Wave/D coef
	Variable/C formfactorcmplx
	Variable/C tau=((1-deltaNPc-sqrt(-1)*betaNPc)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)/((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180)
	vectQz_cmplx=-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180)
	
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)*exp(sqrt(-1)*q_z*D_y/2*sqrt((sin(psi_detec*pi/180))^2))
	formfactorcmplx=(1-tau)*cIntegralResult

	sizeY=D_y+2*coef[8]
	sizeZ=D_z+coef[8]
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z+coef[8],2)*exp(sqrt(-1)*q_z*(D_y+2*coef[8])/2*sqrt((sin(psi_detec*pi/180))^2))
	formfactorcmplx+=tau*cIntegralResult

	Return formfactorcmplx
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeY,sizeZ
	Variable/C result
	result=2*pi*(sizeY/2*sqrt(1-inZ^2/sizeZ^2))^2*bessel(sqrt(vectQx_cmplx^2+vectQy_cmplx^2)*(sizeY/2*sqrt(1-inZ^2/sizeZ^2)))*exp(-sqrt(-1)*vectQz_cmplx*inZ)
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// Core-shell ripple (asymmetric sawtooth profile)
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z 
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ,deltaLAY,betaLAY,deltaNPs,betaNPs,deltaNPc,betaNPc
	Wave/D coef
	Variable/C formfactorcmplx
	Variable/C tau=((1-deltaNPc-sqrt(-1)*betaNPc)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)/((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	
	sizeX=coef[14]//*D_y
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)

	formfactorcmplx=(1-tau)*cIntegralResult

	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)*exp(sqrt(-1)*q_z*coef[8])
	formfactorcmplx+=tau*(cIntegralResult+sizeX*sizeY*coef[8]*sinc(q_x*sizeX/2)*sinc(q_y*sizeY/2)*sinc(q_z*coef[8]/2)*exp(sqrt(-1)*q_z*coef[8]/2))

	Return formfactorcmplx
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable/C result
	Wave/D coef

	Variable anisotropy=coef[15]
	result=sizeX*sinc(vectQx_cmplx*sizeX/2)*sizeY*(1-inZ/sizeZ)*sinc(vectQy_cmplx*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQy_cmplx*anisotropy*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQz_cmplx*inZ)

	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)		// cylinder {diameter D_y, height D_z, volume (pi/4)*D_y^2*D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	Wave/D coef
	NVAR psi_detec,deltaLAY,betaLAY,deltaNPs,betaNPs,deltaNPc,betaNPc

	Variable/C formfactorcmplx
	Variable/C tau=((1-deltaNPc-sqrt(-1)*betaNPc)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)/((1-deltaNPs-sqrt(-1)*betaNPs)^2-(1-deltaLAY-sqrt(-1)*betaLAY)^2)

	Variable/C kk
	
	kk=sqrt((sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*D_y/2)^2+((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*D_z/2)^2)
	formfactorcmplx=(1-tau)*(pi/6*D_y^2*D_z)*3*(sin(kk)-(kk)*cos(kk))/(kk)^3//*exp(sqrt(-1)*q_z*(D_y*D_z/2/sqrt((D_y*cos(psi_detec*pi/180))^2+(D_z*sin(psi_detec*pi/180))^2)))
	
	D_y+=2*coef[8]
	D_z+=2*coef[8]
	kk=sqrt((sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*D_y/2)^2+((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*D_z/2)^2)
	formfactorcmplx+=tau*(pi/6*D_y^2*D_z)*3*(sin(kk)-(kk)*cos(kk))/(kk)^3//*exp(sqrt(-1)*q_z*(D_y*D_z/2/sqrt((D_y*cos(psi_detec*pi/180))^2+(D_z*sin(psi_detec*pi/180))^2)))
	
	Return formfactorcmplx*exp(sqrt(-1)*q_z*(D_y*D_z/2/sqrt((D_y*cos(psi_detec*pi/180))^2+(D_z*sin(psi_detec*pi/180))^2)))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)		// cylinder {diameter D_y, height D_z, volume (pi/4)*D_y^2*D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR psi_detec

	Return 2*pi*(D_y/2)^2*D_z*bessel(sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*D_y/2)*sinc((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*D_z/2)*exp(sqrt(-1)*q_z*(D_z/2*cos(psi_detec*pi/180)+D_y/2*sqrt((sin(psi_detec*pi/180))^2)))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// Ellipsoid {length D_x, diameter D_y, height D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ,psi_detec,phi_detec
	Wave/D coef
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180)
	vectQz_cmplx=-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180)
	sizeX=coef[14]*D_y
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z/2,2)*exp(sqrt(-1)*q_z*(D_y*D_z/2/sqrt((D_y*cos(psi_detec*pi/180))^2+(D_z*sin(psi_detec*pi/180))^2)))
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable Rz=sizeX/2*sqrt(1-4*inZ^2/sizeZ^2)	
	Variable Wz=sizeY/2*sqrt(1-4*inZ^2/sizeZ^2)	
	Variable/C result=4*pi*Rz*Wz*bessel(sqrt(vectQx_cmplx^2*Rz^2+vectQy_cmplx^2*Wz^2))*cos(vectQz_cmplx*inZ)

	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// facetted sphere {diameter D_y, height D_z}	D_z < D_y
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR sizeY,sizeZ,psi_detec
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180)
	vectQz_cmplx=-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180)
	sizeY=D_y
	sizeZ=D_z
	Variable dzmin=D_y/2*(sign(abs(psi_detec*pi/180)-pi/2+asin(D_z/D_y))+1)/2+D_y/2*sin(asin(D_z/D_y)+abs(psi_detec*pi/180))*(sign(pi/2-asin(D_z/D_y)-abs(psi_detec*pi/180))+1)/2
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z/2,2)*exp(sqrt(-1)*q_z*dzmin)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeY,sizeZ
	Variable/C result
	result=4*pi*((sizeY/2)^2-inZ^2)*bessel(sqrt(vectQx_cmplx^2+vectQy_cmplx^2)*sqrt((sizeY/2)^2-inZ^2))*cos(vectQz_cmplx*inZ)
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// hemispheroid {diameter D_y, height D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z 
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeY,sizeZ,psi_detec
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180)
	vectQz_cmplx=-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180)
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)*exp(sqrt(-1)*q_z*D_y/2*sqrt((sin(psi_detec*pi/180))^2))
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeY,sizeZ
	Variable/C result
	result=2*pi*(sizeY/2*sqrt(1-inZ^2/sizeZ^2))^2*bessel(sqrt(vectQx_cmplx^2+vectQy_cmplx^2)*(sizeY/2*sqrt(1-inZ^2/sizeZ^2)))*exp(-sqrt(-1)*vectQz_cmplx*inZ)
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)		// prism
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z

//	Return 2*sqrt(3)*exp(-sqrt(-1)*q_y*D_y/2/sqrt(3))/(q_x*(q_x^2-3*q_y^2))*(q_x*exp(sqrt(-1)*q_y*D_y/2*sqrt(3))-q_x*cos(q_x*D_y/2)-sqrt(-1)*sqrt(3)*q_y*sin(q_x*D_y/2))*sinc(q_z*D_z/2)*exp(sqrt(-1)*q_z*D_z/2)
	Return 2*sqrt(3)*exp(-sqrt(-1)*(-q_x)*D_y/2/sqrt(3))/(q_y*(q_y^2-3*(-q_x)^2))*(q_y*exp(sqrt(-1)*(-q_x)*D_y/2*sqrt(3))-q_y*cos(q_y*D_y/2)-sqrt(-1)*sqrt(3)*(-q_x)*sin(q_y*D_y/2))*sinc(q_z*D_z/2)*exp(sqrt(-1)*q_z*D_z/2)
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// spheroids randomly oriented {diameter D_y, height D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ,psi_detec,phi_detec
	Wave/D coef
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	sizeX=D_y
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,pi,2)/pi
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable/C kk=sqrt((sqrt(vectQx_cmplx^2+(vectQy_cmplx*cos(inZ)+vectQz_cmplx*sin(inZ))^2)*sizeY/2)^2+((-vectQy_cmplx*sin(inZ)+vectQz_cmplx*cos(inZ))*sizeZ/2)^2)
	Variable/C result=(pi/6*sizeY^2*sizeZ)*3*(sin(kk)-(kk)*cos(kk))/(kk)^3

	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// ripple (symmetric sinusoidal profile)
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ
	Wave/D coef 
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	sizeX=coef[14]
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable/C result
	Wave/D coef
	result=sizeX*sinc(vectQx_cmplx*sizeX/2)*sizeY/pi*acos(2*inZ/sizeZ-1)*sinc(vectQy_cmplx*sizeY/2/pi*acos(2*inZ/sizeZ-1))*exp(-sqrt(-1)*vectQz_cmplx*inZ)
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// ripple (asymmetric sawtooth profile)
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeX,sizeY,sizeZ
	Wave/D coef
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y
	vectQz_cmplx=q_z
	sizeX=coef[14]//*D_y
	sizeY=D_y
	sizeZ=D_z
	cIntegralResult=Integrate1D(complexFormFactorFunction,0,D_z,2)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeX,sizeY,sizeZ
	Variable/C result
	Wave/D coef

	Variable anisotropy=coef[15]
	result=sizeX*sinc(vectQx_cmplx*sizeX/2)*sizeY*(1-inZ/sizeZ)*sinc(vectQy_cmplx*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQy_cmplx*anisotropy*sizeY/2*(1-inZ/sizeZ))*exp(-sqrt(-1)*vectQz_cmplx*inZ)

	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// spheroid {diameter D_y, height D_z, volume (pi/6)*D_y^2*D_z}
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR psi_detec
	
	Variable/C kk=sqrt((sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*D_y/2)^2+((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*D_z/2)^2)
	
	Return (pi/6*D_y^2*D_z)*3*(sin(kk)-(kk)*cos(kk))/(kk)^3*exp(sqrt(-1)*q_z*(D_y*D_z/2/sqrt((D_y*cos(psi_detec*pi/180))^2+(D_z*sin(psi_detec*pi/180))^2)))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)	// Truncated sphere {diameter D_y, height D_z}	D_y/2 < D_z < D_y
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx,cIntegralResult
	NVAR sizeY,sizeZ,psi_detec
	vectQx_cmplx=q_x
	vectQy_cmplx=q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180)
	vectQz_cmplx=-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180)
	sizeY=D_y
	sizeZ=D_z
	Variable dzmin=D_y/2*(sign(abs(psi_detec*pi/180)-pi/2+asin(2*D_z/D_y-1))+1)/2+D_y/2*sin(asin(2*D_z/D_y-1)+abs(psi_detec*pi/180))*(sign(pi/2-asin(2*D_z/D_y-1)-abs(psi_detec*pi/180))+1)/2
	cIntegralResult=Integrate1D(complexFormFactorFunction,D_y/2-D_z,D_y/2,2)*exp(sqrt(-1)*q_z*dzmin)
	Return cIntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C ComplexFormFactorFunction(inZ)
	Variable inZ
	NVAR/C vectQx_cmplx,vectQy_cmplx,vectQz_cmplx
	NVAR sizeY,sizeZ
	Variable/C result
	result=2*pi*((sizeY/2)^2-inZ^2)*bessel(sqrt(vectQx_cmplx^2+vectQy_cmplx^2)*sqrt((sizeY/2)^2-inZ^2))*exp(-sqrt(-1)*vectQz_cmplx*inZ)
	Return result
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C Form_factor(q_x,q_y,q_z,D_y,D_z)		// tetrahedron
	Variable/C q_x,q_y,q_z
	Variable D_y,D_z
	Wave/D coef

	Variable q1=0.5*((sqrt(3)*q_y-(-q_x))/tan(coef[14]*pi/180)-q_z)
	Variable q2=0.5*((sqrt(3)*q_y+(-q_x))/tan(coef[14]*pi/180)+q_z)
	Variable q3=0.5*((2*(-q_x))/tan(coef[14]*pi/180)-q_z)
	Variable L1=2*tan(coef[14]*pi/180)*D_y/2/sqrt(3)-D_z
	
	Return D_z/sqrt(3)/q_y/(q_y^2-3*(-q_x)^2)*exp(sqrt(-1)*q_z*d_y/2*tan(coef[14]*pi/180)/sqrt(3))*(-(q_y+sqrt(3)*(-q_x))*sinc(q1*D_z)*exp(sqrt(-1)*q1*L1)+(-q_y+sqrt(3)*(-q_x))*sinc(q2*D_z)*exp(-sqrt(-1)*q2*L1)+2*q_y*sinc(q3*D_z)*exp(sqrt(-1)*q3*L1))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Fit_GISAXS(q_x,q_y,q_z)
	Variable q_x,q_y,q_z
	Wave/D coef
	NVAR vectQx,vectQy,vectQz
	NVAR IntegralResult,Dmin,Dmax
	Variable resultDA
	vectQx=q_x
	vectQy=q_y
	vectQz=q_z

	IntegralResult=Integrate1D(DAFunction1,Dmin,Dmax)
	resultDA=IntegralResult

	IntegralResult=magsqr(Integrate1D(DAFunction2,Dmin,Dmax))
	resultDA+=IntegralResult*(Structure_factor(q_x,q_y,q_z,coef[2]*coef[4],coef[2]*Shape_dist(coef,coef[2])*coef[4],coef[5])-1)
	Return abs(coef[0])+abs(coef[1])*resultDA
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function DAFunction1(inX)		// <|F(q)|²>
	Variable inX
	Wave/D coef
	NVAR vectQx,vectQy,vectQz
	Variable resultDA1
	resultDA1=Size_dist(coef,inX)*Form_factor2(vectQx,vectQy,vectQz,inX,inX*Shape_dist(coef,inX))
	Return resultDA1
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function/C DAFunction2(inX)	// <F(q)>
	Variable inX
	NVAR vectQx,vectQy,vectQz,sizeY,sizeZ
	Variable/C resultDA2
	resultDA2=Size_dist(coef,inX)*Form_factor_amplitude(vectQx,vectQy,vectQz,inX,inX*Shape_dist(coef,inX))
	Return resultDA2
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

















#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Fit_GISAXS(q_x,q_y,q_z)		// Local Monodisperse Approximation (LMA)
	Variable q_x,q_y,q_z
	Wave/D coef
	NVAR vectQx,vectQy,vectQz
	NVAR IntegralResult,Dmin,Dmax
	vectQx=q_x
	vectQy=q_y
	vectQz=q_z
	IntegralResult=Integrate1D(LMAFunction,Dmin,Dmax)
	Return abs(coef[0])+abs(coef[1])*IntegralResult
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function LMAFunction(inX)
	Variable inX
	Wave/D coef
	NVAR vectQx,vectQy,vectQz
	Variable resultLMA
	resultLMA=Size_dist(coef,inX)*Form_factor2(vectQx,vectQy,vectQz,inX,inX*Shape_dist(coef,inX))*Structure_factor(vectQx,vectQy,vectQz,inX*coef[4],inX*Shape_dist(coef,inX)*coef[4],coef[5])
	Return resultLMA
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Fit_GISAXS(q_x,q_y,q_z)		// Monodisperse approximation (MA)
	Variable q_x,q_y,q_z
	Wave/D coef

	Variable D=coef[2]
	Variable H=D*Shape_dist(coef,D)
	Variable Dhs=D*coef[4]
	Variable Hhs=H*coef[4]
	
	Return abs(coef[0])+abs(coef[1])*Form_factor2(q_x,q_y,q_z,D,H)*Structure_factor(q_x,q_y,q_z,Dhs,Hhs,coef[5])
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Shape_dist(w,D) : FitFunc	// Fonction H/D = f(D)
	Wave/D w
	Variable D

	Return w[6]
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Shape_dist(w,D) : FitFunc	// Fonction H/D = f(D)
	Wave/D w
	Variable D

//	Return w[6]*D^w[7]
//	Return w[6]+w[7]/D
	Return w[7]*(w[6]+1/D)

End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Size_dist(w,D) : FitFunc	// Double gaussian
	Wave/D w
	Variable D

	Variable fwhm=w[3]
	
	Return  1/(fwhm/sqrt(2*ln(2))*sqrt(pi/2))*exp(-2*((D-w[2])^2)/(fwhm/sqrt(2*ln(2)))^2)+w[9]/(w[11]/sqrt(2*ln(2))*sqrt(pi/2))*exp(-2*((D-w[10])^2)/(w[11]/sqrt(2*ln(2)))^2)

End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Size_dist(w,D) : FitFunc	// Double log-normal
	Wave/D w
	Variable D

	Variable fwhm=w[3]
	
	Return 1/D/((1/sqrt(2*ln(2))*asinh(fwhm/2/w[2]))*sqrt(pi*2))*exp(-1/2*((ln(D)-ln(w[2]))^2)/(1/sqrt(2*ln(2))*asinh(fwhm/2/w[2]))^2)+abs(w[9])/D/((1/sqrt(2*ln(2))*asinh(w[11]/2/w[10]))*sqrt(pi*2))*exp(-1/2*((ln(D)-ln(w[10]))^2)/(1/sqrt(2*ln(2))*asinh(w[11]/2/w[10]))^2)
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Size_dist(w,D) : FitFunc	// Gaussian
	Wave/D w
	Variable D

	Variable fwhm=w[3]
	
	Return 1/(fwhm/sqrt(2*ln(2))*sqrt(pi/2))*exp(-2*((D-w[2])^2)/(fwhm/sqrt(2*ln(2)))^2)
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Size_dist(w,D) : FitFunc	// Log-normal
	Wave/D w
	Variable D

	Variable fwhm=w[3]
	Variable dmean=w[2]//w[6]
	
//	Return 1/D/((1/sqrt(2*ln(2))*asinh(fwhm/2/w[2]))*sqrt(pi*2))*exp(-1/2*((ln(D)-ln(w[2]))^2)/(1/sqrt(2*ln(2))*asinh(fwhm/2/w[2]))^2)
	Return 1/D/((1/sqrt(2*ln(2))*asinh(fwhm/2/dmean))*sqrt(pi*2))*exp(-1/2*((ln(D)-ln(dmean))^2)/(1/sqrt(2*ln(2))*asinh(fwhm/2/dmean))^2)
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Size_dist(w,D) : FitFunc	// Weibull
	Wave/D w
	Variable D

	Variable fwhm=w[3]
	
	Return fwhm/w[2]*(D/w[2])^(fwhm-1)*exp(-(D/w[2])^(fwhm))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,sigma)	// Paracrystal 1D
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,sigma
	Variable vLambda0=1e3		// correlation length (nm)
	Variable vPhi=exp(-q_y^2*sigma^2/2)*exp(-Dy_hs/vLambda0)

	Return (1-vPhi^2)/(1+vPhi^2-2*vPhi*cos(q_y*Dy_hs))

//	Variable/C vPk=vPhi*exp(sqrt(-1)*q_y*Dy_hs)
//	Return real((1+vPk)/(1-vPk))
//	Return 1+2*real(vPk/(1-vPk))

//	Variable vNk=1e10
//	Return real(2*(1-vPk^vNk)/(1-vPk)-1)

//	Return (1-exp(-(q_x^2+q_y^2)*sigma^2))/(1+exp(-(q_x^2+q_y^2)*sigma^2)-2*exp(-1/2*(q_x^2+q_y^2)*sigma^2)*cos(sqrt(q_x^2+q_y^2)*Dy_hs))
//	Return (1-exp(-(q_x^2)*sigma^2))/(1+exp(-(q_x^2)*sigma^2)-2*exp(-1/2*(q_x^2)*sigma^2)*cos(q_x*Dy_hs))
//	Return (1-exp(-(q_y^2)*sigma^2))/(1+exp(-(q_y^2)*sigma^2)-2*exp(-1/2*(q_y^2)*sigma^2)*cos(q_y*Dy_hs))
	
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,sigma)	// Paracrystal 2D Hexagonal lattice
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,sigma
	Variable vLambda0=1e3		// correlation length (nm)
	Variable q_p=sqrt(q_x^2+q_y^2)
	Variable vA,vB,sigma_x,sigma_y,vPhi_x,vPhi_y,vQscalA,vQscalB
	
	vA=Dy_hs							// pas du réseau dans la direction x
	vB=Dy_hs							// pas du réseau dans la direction y
	sigma_x=sigma						// écart-type dans la direction x
	sigma_y=sigma						// écart-type dans la direction x
	vPhi_x=exp(-q_p^2*sigma_x^2/2)*exp(-vA/vLambda0)
	vPhi_y=exp(-q_p^2*sigma_y^2/2)*exp(-vB/vLambda0)

//------------------------------------------------------------------------------------------------
	Variable returntemp

	vQscalA=q_y*vA
	vQscalB=q_y*vA/2+q_x*vA*sqrt(3)/2
	returntemp=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

	Return returntemp

//	vQscalA=q_y*vA/2+q_x*vA*sqrt(3)/2
//	vQscalB=-q_y*vA/2+q_x*vA*sqrt(3)/2
//	returntemp+=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

//	vQscalA=-q_y*vA/2+q_x*vA*sqrt(3)/2
//	vQscalB=-q_y*vA
//	returntemp+=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

//	Return returntemp/3
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,sigma)	// Paracrystal 1D
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,sigma
	
	Variable sigma2=2
	Variable Dy_hs2=7.5
	
//	Return (1-exp(-(q_y^2)*sigma^2))/(1+exp(-(q_y^2)*sigma^2)-2*exp(-1/2*(q_y^2)*sigma^2)*cos(q_y*Dy_hs))*(1-exp(-(q_x^2)*sigma2^2))/(1+exp(-(q_x^2)*sigma2^2)-2*exp(-1/2*(q_x^2)*sigma2^2)*cos(q_x*Dy_hs2))
//	Return (1-exp(-(q_x^2)*sigma2^2))/(1+exp(-(q_x^2)*sigma2^2)-2*exp(-1/2*(q_x^2)*sigma2^2)*cos(q_x*Dy_hs2))
//	Return (1-exp(-(q_y^2)*sigma2^2))/(1+exp(-(q_y^2)*sigma2^2)-2*exp(-1/2*(q_y^2)*sigma2^2)*cos(q_y*Dy_hs2))

	Variable q_p=sqrt(q_x^2+q_y^2)
//	Variable/C xi1=exp(-sqrt(-1)*Dy_hs*q_y)*exp(-sigma^2*q_y^2/2)
//	Variable/C xi2=exp(-sqrt(-1)*Dy_hs2*q_x)*exp(-sigma2^2*q_x^2/2)

	Variable a1x=Dy_hs*sqrt(3)/2
	Variable a1y=-Dy_hs/2
	Variable a2x=Dy_hs*sqrt(3)/2
	Variable a2y=Dy_hs/2
//	Variable a1x=Dy_hs
//	Variable a1y=0
//	Variable a2x=-Dy_hs/2
//	Variable a2y=Dy_hs*sqrt(3)/2
	Variable/C xi1=exp(-sqrt(-1)*(a1x*q_x+a1y*q_y))*exp(-sigma^2*q_p^2/2)
	Variable/C xi2=exp(-sqrt(-1)*(a2x*q_x+a2y*q_y))*exp(-sigma^2*q_p^2/2)

	Return (1+2*real(xi1/(1-xi1)))*(1+2*real(xi2/(1-xi2)))	
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,sigma)	// Paracrystal 2D Rectangular lattice
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,sigma
	Wave/D coef
	Variable vLambda0=1e3		// correlation length (nm)
	Variable q_p=sqrt(q_x^2+q_y^2)
	Variable vA,vB,sigma_x,sigma_y,vPhi_x,vPhi_y,vQscalA,vQscalB
	
	vA=coef[16]*Dy_hs		// pas du réseau dans la direction x
	vB=Dy_hs				// pas du réseau dans la direction y
	sigma_x=coef[17]*sigma	// écart-type dans la direction x
	sigma_y=sigma			// écart-type dans la direction y

	vPhi_x=exp(-q_p^2*sigma_x^2/2)*exp(-vA/vLambda0)
	vPhi_y=exp(-q_p^2*sigma_y^2/2)*exp(-vB/vLambda0)

	//------------------------------------------------------------------------------------------------

	vQscalA=q_x*vA			// q_para . a (dans la direction x)
	vQscalB=q_y*vB			// q_para . b (dans la direction y)
	
	Return (1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))
	
	//------------------------------------------------------------------------------------------------
//	Variable returntemp		// Paracrystal 2D Centered rectangular lattice

//	vQscalA=q_y*vB
//	vQscalB=q_y*vB/2+q_x*vA/2
//	returntemp=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

//	vQscalA=q_y*vB/2+q_x*vA/2
//	vQscalB=-q_y*vB/2+q_x*vA/2
//	returntemp+=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

//	vQscalA=-q_y*vB/2+q_x*vA/2
//	vQscalB=-q_y*vB
//	returntemp+=(1-vPhi_x^2)/(1+vPhi_x^2-2*vPhi_x*cos(vQscalA))*(1-vPhi_y^2)/(1+vPhi_y^2-2*vPhi_y*cos(vQscalB))

//	Return returntemp/3

End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs)	// 2D short-range organization
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs
	Variable q_p,G
	
	q_p=sqrt(q_x^2+q_y^2)
	G=((1+2*eta_hs)^2/(1-eta_hs)^4)*(sin(Dy_hs*q_p)-Dy_hs*q_p*cos(Dy_hs*q_p))/(Dy_hs*q_p)^2+(-6*eta_hs*(1+eta_hs/2)^2/(1-eta_hs)^4)*(2*Dy_hs*q_p*sin(Dy_hs*q_p)+(2-(Dy_hs*q_p)^2)*cos(Dy_hs*q_p)-2)/(Dy_hs*q_p)^3+(eta_hs*((1+2*eta_hs)^2/(1-eta_hs)^4)/2)*(-(Dy_hs*q_p)^4*cos(Dy_hs*q_p)+4*((3*(Dy_hs*q_p)^2-6)*cos(Dy_hs*q_p)+((Dy_hs*q_p)^3-6*Dy_hs*q_p)*sin(Dy_hs*q_p)+6))/(Dy_hs*q_p)^5
	Return 1/(1+24*eta_hs*G/(Dy_hs*q_p))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs)	// Volume short-range organization
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs
	NVAR psi_detec

	Variable gg=2*sqrt((sqrt(q_x^2+(q_y*cos(psi_detec*pi/180)+q_z*sin(psi_detec*pi/180))^2)*Dy_hs/2)^2+((-q_y*sin(psi_detec*pi/180)+q_z*cos(psi_detec*pi/180))*Dz_hs/2)^2)
	Variable G=((1+2*eta_hs)^2/(1-eta_hs)^4)*(sin(gg)-gg*cos(gg))/(gg)^2+(-6*eta_hs*(1+eta_hs/2)^2/(1-eta_hs)^4)*(2*gg*sin(gg)+(2-(gg)^2)*cos(gg)-2)/(gg)^3+(eta_hs*((1+2*eta_hs)^2/(1-eta_hs)^4)/2)*(-(gg)^4*cos(gg)+4*((3*(gg)^2-6)*cos(gg)+((gg)^3-6*gg)*sin(gg)+6))/(gg)^5

	Return 1/(1+24*eta_hs*G/(gg))
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma rtGlobals=1		// Use modern global access method.

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

Function Structure_Factor(q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs)	// Random organization
	Variable q_x,q_y,q_z,Dy_hs,Dz_hs,eta_hs

	Return 1
End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
